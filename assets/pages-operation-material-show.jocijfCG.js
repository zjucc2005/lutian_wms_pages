import{o as e,d as t,w as a,e as i,L as s,D as l,f as o,t as r,k as d,i as _,az as n,a2 as u,aA as m,s as c,p,aB as f,n as h,a as g,h as b,c as x,q as k,g as y,F as v,u as w,C as F,j as S,l as I}from"./index-DsK9pIyj.js";import{p as N,a as E,_ as j}from"./uni-popup.CPWlX1tX.js";import{_ as R}from"./_plugin-vue_export-helper.BCo6x5W8.js";import{r as C}from"./uni-app.es.CSK8ITuj.js";import{_ as B}from"./uni-list-item.BkmqxiQh.js";import{_ as G}from"./uni-list.dJf-6p1_.js";import{_ as T}from"./uni-section.BpQrEx4g.js";import{_ as q}from"./uni-goods-nav.BN-nj5na.js";import{_ as $}from"./uni-icons.DRoE6XYp.js";import{_ as P}from"./uqrcode.r-H7a1Jc.js";import{_ as A}from"./uni-data-picker.MxVuyZ-u.js";import{_ as V}from"./uni-easyinput.BfazFYzq.js";import{p as Z}from"./index.uHoH2c2-.js";import{K as z}from"./k3cloudapi.PCDjx1SF.js";import{B as M}from"./bd_material.d9K6JZK2.js";import"./stock_loc.Bj3C3Byx.js";import"./inv_log.D0BShjlW.js";import{S as Q}from"./stk_inventory.Tp2E6wVT.js";import"./uni-badge.CO78OwkC.js";import"./uni-load-more.CyJx3ZKG.js";const L=R({name:"uniPopupMessage",mixins:[N],props:{type:{type:String,default:"success"},message:{type:String,default:""},duration:{type:Number,default:3e3},maskShow:{type:Boolean,default:!1}},data:()=>({}),created(){this.popup.maskShow=this.maskShow,this.popup.messageChild=this},methods:{timerClose(){0!==this.duration&&(clearTimeout(this.timer),this.timer=setTimeout((()=>{this.popup.close()}),this.duration))}}},[["render",function(n,u,m,c,p,f){const h=d,g=_;return e(),t(g,{class:"uni-popup-message"},{default:a((()=>[i(g,{class:s(["uni-popup-message__box fixforpc-width","uni-popup__"+m.type])},{default:a((()=>[l(n.$slots,"default",{},(()=>[i(h,{class:s(["uni-popup-message-text","uni-popup__"+m.type+"-text"])},{default:a((()=>[o(r(m.message),1)])),_:1},8,["class"])]),!0)])),_:3},8,["class"])])),_:3})}],["__scopeId","data-v-d81cfb56"]]),O=async e=>new Promise(((t,a)=>{u({url:e,method:"GET",responseType:"arraybuffer",success:e=>{let a=m(e.data);t(a)},fail:e=>{a(e)}})}));const U=R({props:{id:{type:String}},data:()=>({bd_material:{},stk_inventories:[],image_urls:[],image_fields:["ImageFileServer","F_PAEZ_ImageFileServer","F_PAEZ_ImageFileServer1"],f_image_fields:["FImageFileServer","F_PAEZ_ImageFileServer","F_PAEZ_ImageFileServer1"],flash_type:"",flash_msg:"",canvas_id:"",edit_form:{name:"",type:"text",field:"",value:"",value_was:""},goods_nav:{options:[{icon:"image",text:"上传图片"}],button_group:[{text:"打印模板",color:"#fff",backgroundColor:c.state.goods_nav_color.grey}]}}),onLoad(e){e.id&&this.load_material(e.id)},mounted(){},computed:{can_edit:()=>["wh_admin","nrj_admin"].includes(c.state.role),is_admin:()=>c.state.cur_stock.FUseOrgId&&1===c.state.cur_stock.FUseOrgId&&["wh_admin","nrj_admin"].includes(c.state.role)},methods:{edit_field(e){var t,a,i;this.can_edit?("F_RGEN_xsjc_83g"==e?this.edit_form={field:e,type:"text",name:"销售简称",value:this.bd_material.F_RGEN_xsjc_83g,value_was:this.bd_material.F_RGEN_xsjc_83g}:"F_RGEN_Text_cpjc"==e?this.edit_form={field:e,type:"text",name:"产品简称",value:this.bd_material.F_RGEN_Text_cpjc,value_was:this.bd_material.F_RGEN_Text_cpjc}:"FBoxStandardQty"==e?this.edit_form={field:e,type:"number",name:"单箱标准数量",value:this.bd_material.MaterialStock[0].BoxStandardQty,value_was:this.bd_material.MaterialStock[0].BoxStandardQty}:"F_RGEN_Text_qtr"==e?this.edit_form={field:e,type:"text",name:"单托标准数量",value:this.bd_material.F_RGEN_Text_qtr,value_was:this.bd_material.F_RGEN_Text_qtr}:"StockId"==e?this.edit_form={field:e,type:"text",name:"仓库",value:0,value_was:null==(t=this.bd_material.MaterialStock[0].StockId)?void 0:t.Name[0].Value}:"CangGuanYuan"==e?this.edit_form={field:e,type:"text",name:"仓管员",value:null==(a=this.bd_material.F_PAEZ_Base1)?void 0:a.FStaffNumber,value_was:null==(i=this.bd_material.F_PAEZ_Base1)?void 0:i.FStaffNumber,placeholder:"请填写员工编号"}:"F_PAEZ_Text_qtr2"==e?this.edit_form={field:e,type:"text",name:"库位",value:this.bd_material.F_PAEZ_Text_qtr2,value_was:this.bd_material.F_PAEZ_Text_qtr2}:"F_RGEN_Text_bzgx"==e&&(this.edit_form={field:e,type:"text",name:"部装工序",value:this.bd_material.F_RGEN_Text_bzgx,value_was:this.bd_material.F_RGEN_Text_bzgx}),this.$refs.edit_popup.open()):this.flash("warn","创建组织下才可修改")},flash(e,t){this.flash_type=e,this.flash_msg=t,this.$refs.flash.open()},goods_nav_click(e){0===e.index&&this.$refs.image_popup.open(),1===e.index&&this.search_bom()},goods_nav_button_click(e){0===e.index&&this.select_material_card()},if_image_delete(e){p({itemList:[`删除图片${e+1}`],success:t=>{0===t.tapIndex&&this.image_delete(e)}})},image_preview(e){console.log("image_preview",e,this.image_urls.map((e=>e.original)));f({current:e,urls:this.image_urls.map((e=>e.original))})},search_bom(){p({itemList:["查询父项物料","查询子项物料"],success:e=>{0===e.tapIndex&&(Z("success"),h({url:`/pages/k3cloud/eng_bom/tree?material_no=${this.bd_material.Number}&sup=true`})),1===e.tapIndex&&(Z("success"),h({url:`/pages/k3cloud/eng_bom/tree?material_no=${this.bd_material.Number}&sup=false`}))}})},select_material_card(){this.bd_material.Id&&p({itemList:["物料资料卡"],success:e=>{0===e.tapIndex&&(this.$logger.info(">>> 生成物料资料卡"),h({url:"/pages/operation/material/card",success:e=>{Z("success"),e.eventChannel.emit("sendMaterial",{bd_material:this.bd_material,image_urls:this.image_urls})}}))}})},show_qrcode(){this.canvas_id="qrcode_"+Date.now(),this.$refs.qrcode_popup.open()},async image_delete(e){let t={};t[this.f_image_fields[e]]="",await M.update(this.bd_material.Id,t),await this.load_material(this.bd_material.Id)},async image_upload(e){var t;const{tempFiles:a}=await(async e=>new Promise(((t,a)=>{n({count:1,...e,success:e=>{t(e)},fail:e=>{a(e)},complete:e=>{}})})))({count:1,sizeType:["compressed"]});g({title:"Loading",mask:!0});for(let i=0;i<a.length;i++){let s=a[i],l=await O(s.path),o={FileName:s.name,SendByte:l},r=await z.upload_file(o);if(this.$logger.info("upload_res",r),r.data.Result.ResponseStatus.IsSuccess){let a={};a[this.f_image_fields[e]]=r.data.Result.FileId;let i=await M.update(this.bd_material.Id,a);if(!i.data.Result.ResponseStatus.IsSuccess)return this.flash("error",null==(t=i.data.Result.ResponseStatus.Errors[0])?void 0:t.Message),void b()}}b(),this.load_material(this.bd_material.Id)},async load_material(e){var t;g({title:"Loading",mask:!0}),this.image_urls=[],this.blank_image_fields=[];let a=await M.view(e);if(a.data.Result.ResponseStatus.IsSuccess){let e=a.data.Result.Result;this.bd_material=e;for(let a of this.image_fields)(null==(t=e[a])?void 0:t.trim())?this.image_urls.push({field:a,id:e[a],original:await z.download_image_cache(e[a])}):this.blank_image_fields.push(a);let i=await Q.query({"FMaterialId.FNumber":e.Number}),s=[];for(let t of i.data){let e=s.find((e=>e.FStockId==t.FStockId));e?e.FBaseQty+=t.FBaseQty:s.push(t)}this.stk_inventories=s,this.goods_nav.button_group[0].backgroundColor=c.state.goods_nav_color.green}b()},async submit_edit_field(){var e;if(this.edit_form.value==this.edit_form.value_was)return void this.$refs.edit_popup.close();let t={};"FBoxStandardQty"==this.edit_form.field?t={SubHeadEntity1:{FBoxStandardQty:this.edit_form.value}}:"StockId"==this.edit_form.field?t={SubHeadEntity1:{FStockId:{FStockId:this.edit_form.value||0}}}:"CangGuanYuan"==this.edit_form.field?t={F_PAEZ_Base1:{FStaffNumber:this.edit_form.value}}:t[this.edit_form.field]=this.edit_form.value,g({title:"Loading",mask:!0});let a=await M.update(this.bd_material.Id,t);b(),this.$refs.edit_popup.close(),a.data.Result.ResponseStatus.IsSuccess?(await this.load_material(this.bd_material.Id),this.flash("success","修改成功"),Z("success")):this.flash("error",null==(e=a.data.Result.ResponseStatus.Errors[0])?void 0:e.Message)},thumbnail_url(e){let t=this.image_urls.find((t=>t.id==e.trim()));return(null==t?void 0:t.original)||"/static/default_40x40.png"}}},[["render",function(l,n,u,m,c,p){const f=C(x("uni-popup-message"),L),h=C(x("uni-popup"),E),g=C(x("uni-list-item"),B),b=_,N=d,R=C(x("uni-list"),G),Z=S,z=C(x("uni-section"),T),M=C(x("uni-goods-nav"),q),Q=C(x("uni-icons"),$),O=I,U=C(x("uqrcode"),P),D=C(x("uni-popup-dialog"),j),Y=C(x("uni-data-picker"),A),H=C(x("uni-easyinput"),V);return e(),k(v,null,[i(h,{ref:"flash",type:"message"},{default:a((()=>[i(f,{type:c.flash_type,message:c.flash_msg,duration:2e3},null,8,["type","message"])])),_:1},512),c.bd_material.Id?(e(),t(z,{key:0,title:"物料详情",type:"square",class:"above-uni-goods-nav"},{default:a((()=>[i(R,null,{default:a((()=>{var d,_,u;return[i(g,{title:"编码","right-text":c.bd_material.Number,onClick:p.show_qrcode,clickable:"","show-arrow":""},null,8,["right-text","onClick"]),i(g,{title:"名称","right-text":null==(d=c.bd_material.Name[0])?void 0:d.Value},null,8,["right-text"]),i(g,{title:"规格","right-text":null==(_=c.bd_material.Specification[0])?void 0:_.Value},null,8,["right-text"]),i(g,{title:"存货类别","right-text":c.bd_material.MaterialBase[0].CategoryID.Name[0].Value},null,8,["right-text"]),i(g,{title:"销售简称","right-text":c.bd_material.F_RGEN_xsjc_83g,onClick:n[0]||(n[0]=e=>p.edit_field("F_RGEN_xsjc_83g")),clickable:p.is_admin,"show-arrow":p.is_admin},null,8,["right-text","clickable","show-arrow"]),i(g,{title:"产品简称","right-text":c.bd_material.F_RGEN_Text_cpjc,onClick:n[1]||(n[1]=e=>p.edit_field("F_RGEN_Text_cpjc")),clickable:p.is_admin,"show-arrow":p.is_admin},null,8,["right-text","clickable","show-arrow"]),i(g,{title:"单箱标准数量","right-text":c.bd_material.MaterialStock[0].BoxStandardQty.toString(),onClick:n[2]||(n[2]=e=>p.edit_field("FBoxStandardQty")),clickable:p.can_edit,"show-arrow":p.can_edit},null,8,["right-text","clickable","show-arrow"]),i(g,{title:"单托标准数量","right-text":c.bd_material.F_RGEN_Text_qtr,onClick:n[3]||(n[3]=e=>p.edit_field("F_RGEN_Text_qtr")),clickable:p.can_edit,"show-arrow":p.can_edit},null,8,["right-text","clickable","show-arrow"]),i(g,{title:"仓库","right-text":null==(u=c.bd_material.MaterialStock[0].StockId)?void 0:u.Name[0].Value,onClick:n[4]||(n[4]=e=>p.edit_field("StockId")),clickable:p.is_admin,"show-arrow":p.is_admin},null,8,["right-text","clickable","show-arrow"]),i(g,{title:"仓管员","right-text":c.bd_material.F_PAEZ_Base1?[c.bd_material.F_PAEZ_Base1.Name[0].Value,c.bd_material.F_PAEZ_Base1.FStaffNumber].join(" / "):"",onClick:n[5]||(n[5]=e=>p.edit_field("CangGuanYuan")),clickable:p.is_admin,"show-arrow":p.is_admin},null,8,["right-text","clickable","show-arrow"]),i(g,{title:"库位","right-text":c.bd_material.F_PAEZ_Text_qtr2,onClick:n[6]||(n[6]=e=>p.edit_field("F_PAEZ_Text_qtr2")),clickable:p.is_admin,"show-arrow":p.is_admin},null,8,["right-text","clickable","show-arrow"]),i(g,{title:"部装工序","right-text":c.bd_material.F_RGEN_Text_bzgx,onClick:n[7]||(n[7]=e=>p.edit_field("F_RGEN_Text_bzgx")),clickable:p.is_admin,"show-arrow":p.is_admin},null,8,["right-text","clickable","show-arrow"]),(e(!0),k(v,null,w(c.stk_inventories,((d,_)=>(e(),t(g,{key:_,title:"库存量(基本单位)",note:[`组织：${d["FStockOrgId.FName"]}`,`仓库：${d.FStockName}`].join("\n"),"right-text":[d.FBaseQty,c.bd_material.MaterialBase[0].BaseUnitId.Name[0].Value].join(" ")},{body:a((()=>[i(b,{class:"uni-list-item__body"},{default:a((()=>[i(b,{class:"title"},{default:a((()=>[o("库存量(金蝶账面)")])),_:1}),i(b,{class:"note"},{default:a((()=>[i(b,null,{default:a((()=>[o("组织："),i(N,{class:s(d.FStockOrgId==l.$store.state.cur_stock.FUseOrgId?"text-primary":"")},{default:a((()=>[o(r(d["FStockOrgId.FName"]),1)])),_:2},1032,["class"])])),_:2},1024),i(b,null,{default:a((()=>[o("仓库："+r(d.FStockName),1)])),_:2},1024)])),_:2},1024)])),_:2},1024)])),_:2},1032,["note","right-text"])))),128))]})),_:1}),(e(!0),k(v,null,w(c.image_urls,((s,l)=>(e(),t(b,{key:l,class:"image-card"},{default:a((()=>[i(Z,{src:s.original,mode:"widthFix",style:F({width:s.loading?0:"100%",height:s.loading?0:""}),onClick:e=>p.image_preview(l)},null,8,["src","style","onClick"])])),_:2},1024)))),128))])),_:1})):y("",!0),i(b,{class:"uni-goods-nav-wrapper"},{default:a((()=>[i(M,{options:c.goods_nav.options,"button-group":c.goods_nav.button_group,fill:l.$store.state.goods_nav_fill,onClick:p.goods_nav_click,onButtonClick:p.goods_nav_button_click},null,8,["options","button-group","fill","onClick","onButtonClick"])])),_:1}),i(h,{ref:"image_popup",type:"share","safe-area":""},{default:a((()=>[i(z,{title:"上传图片",type:"square",style:{borderRadius:"10px 10px 0 0"}},{right:a((()=>[i(b,{class:"uni-section__right"},{default:a((()=>[i(Q,{type:"closeempty",size:"20",color:"#333",onClick:n[8]||(n[8]=e=>l.$refs.image_popup.close())})])),_:1})])),default:a((()=>[i(R,null,{default:a((()=>[(e(!0),k(v,null,w(c.image_fields,((s,l)=>(e(),t(g,{key:l,title:`图片 ${l+1}`,thumb:p.thumbnail_url(c.bd_material[s]),"thumb-size":"lg"},{footer:a((()=>[p.is_admin?(e(),t(b,{key:0,class:"uni-list-item__foot"},{default:a((()=>[c.bd_material[s].trim()?(e(),t(Q,{key:0,type:"trash",size:"24",color:"#dd524d",onClick:e=>p.if_image_delete(l),class:"uni-mr-5"},null,8,["onClick"])):y("",!0),i(O,{type:"primary",size:"mini",onClick:e=>p.image_upload(l)},{default:a((()=>[o("选择上传")])),_:2},1032,["onClick"])])),_:2},1024)):(e(),t(b,{key:1,class:"uni-list-item__foot text-grey text-sm"},{default:a((()=>[o(" 创建组织下才可上传 ")])),_:1}))])),_:2},1032,["title","thumb"])))),128))])),_:1})])),_:1})])),_:1},512),i(h,{ref:"qrcode_popup",type:"dialog"},{default:a((()=>[i(D,{title:"分享二维码",type:"info","confirm-text":"完成","show-close":!1,style:{"min-width":"320px"}},{default:a((()=>[i(b,{align:"center"},{default:a((()=>[i(U,{ref:"qrcode","canvas-id":c.canvas_id,value:c.bd_material.Number,size:270},null,8,["canvas-id","value"]),i(b,{class:"text-grey uni-mt-5"},{default:a((()=>[o(r(c.bd_material.Number),1)])),_:1})])),_:1})])),_:1})])),_:1},512),i(h,{ref:"edit_popup",type:"dialog"},{default:a((()=>[i(D,{title:c.edit_form.name,"confirm-text":"提交更新",onClose:n[12]||(n[12]=e=>l.$refs.edit_popup.close()),onConfirm:p.submit_edit_field,"before-close":!0,style:F({width:l.$store.state.system_info.windowWidth-20+"px",minWidth:"360px",maxWidth:"1200px"})},{default:a((()=>[i(b,{class:"edit-form"},{default:a((()=>["StockId"==c.edit_form.field?(e(),t(Y,{key:0,ref:"stock_id_data_picker",modelValue:c.edit_form.value,"onUpdate:modelValue":n[9]||(n[9]=e=>c.edit_form.value=e),localdata:l.$store.state.bd_stock_opts,"popup-title":"请选择仓库"},null,8,["modelValue","localdata"])):"CangGuanYuan"==c.edit_form.field?(e(),t(H,{key:1,modelValue:c.edit_form.value,"onUpdate:modelValue":n[10]||(n[10]=e=>c.edit_form.value=e),type:c.edit_form.type,placeholder:c.edit_form.placeholder,suffixIcon:"search",trim:"both"},null,8,["modelValue","type","placeholder"])):(e(),t(H,{key:2,modelValue:c.edit_form.value,"onUpdate:modelValue":n[11]||(n[11]=e=>c.edit_form.value=e),type:c.edit_form.type,placeholder:c.edit_form.placeholder,trim:"both"},null,8,["modelValue","type","placeholder"]))])),_:1})])),_:1},8,["title","onConfirm","style"])])),_:1},512)],64)}],["__scopeId","data-v-4e99cd5b"]]);export{U as default};
