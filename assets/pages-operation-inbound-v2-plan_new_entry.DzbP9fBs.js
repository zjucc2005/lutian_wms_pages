import{s as t,p as a,b as e,a as o,h as n,v as s,c as i,q as l,e as _,w as r,F as u,i as d,o as m,d as c,u as p,f,t as h,k,g as b}from"./index-DWoH3vfe.js";import{_ as v}from"./uni-list-item.DDtNoANW.js";import{r as g}from"./uni-app.es.BmoqNwAf.js";import{_ as F}from"./uni-list.BUls3DLZ.js";import{_ as y}from"./uni-section.iEIUA4ss.js";import{_ as x,a as I}from"./uni-forms.wqQOOOmn.js";import{_ as q}from"./uni-data-picker.CC4QJBkb.js";import{_ as S}from"./uni-easyinput.D91VfiYe.js";import{_ as j,a as C}from"./uni-swipe-action.CgJwlpZ9.js";import{_ as w}from"./uni-goods-nav.CFHsP2dB.js";import{p as N,i as R,a as T,b as V}from"./index.CbUtXxpp.js";import"./k3cloudapi.RL4SGN7f.js";import{a as D}from"./stock_loc.DkKMhjD6.js";import"./inv_log.B23E6Sfg.js";import{s as E}from"./scan_code.B9tgpVm4.js";import{_ as L}from"./_plugin-vue_export-helper.BCo6x5W8.js";import"./uni-icons.Btv09wDc.js";import"./uni-badge.Dyjwvs1c.js";import"./uni-load-more.BkwpJTRr.js";const M=L({data(){return{inbound_task:{},inv_plans:[],plan_form:{material_no:"",loc_no:"",op_qty:"",remark:"",base_unit:"Pcs",base_unit_name:"Pcs",decimal_unit:!1},plan_form_rules:{material_no:{rules:[{required:!0,errorMessage:"物料编号不能为空"}]},loc_no:{rules:[{required:!0,errorMessage:"库位号不能为空"},{validateFunction:(a,e,o,n)=>"C"!=t.state.stock_locs.find((t=>t.FNumber==e)).FDocumentStatus?n("此库位号未审核"):this.inv_plans.find((t=>t["FStockLocId.FNumber"]==e))?n("此库位号已有计划明细"):void 0}]},op_qty:{rules:[{required:!0,errorMessage:"计划上架数量不能为空"},{format:"number",errorMessage:"计划上架数量只能输入数字"},{validateFunction:(t,a,e,o)=>{if(a<=0)return o("计划上架数量必须大于0");if(!this.plan_form.decimal_unit&&!Number.isInteger(a))return o("计划上架数量必须为整数");let n=this.inbound_task.inbound_list.find((t=>t.material_no==this.plan_form.material_no)),s=this.sum_inv_plan_op_qty();return n&&a+s>n.base_unit_qty?o("计划上架数量超过上限"):void 0}}]}},swipe_options:[{text:"删除",style:{backgroundColor:"#dd524d"}}],goods_nav:{options:[{icon:"list",text:"物料"}],button_group:[{text:"扫码",backgroundColor:"linear-gradient(90deg, #FE6035, #EF1224)",color:"#fff"},{text:"新增",backgroundColor:"linear-gradient(90deg, #1E83FF, #0053B8)",color:"#fff"}]}}},onLoad(t){this.getOpenerEventChannel().on("sendInboundTask",(t=>{this.$logger.info("eventChannel.on sendInboundTask",t),this.inbound_task=t.inbound_task,t.material_no&&(this.set_plan_form(t.material_no),this.load_inv_plans(t.material_no))}))},mounted(){},methods:{swipe_action_click(t,a){0===t.index&&this.submit_delete(a)},goods_nav_click(t){0===t.index&&this.handle_material_no_click()},goods_nav_button_click(t){0===t.index&&this.scan_code(),1===t.index&&this.submit_save()},handle_material_no_click(){let e=this.inbound_task.inbound_list.filter((a=>a.dest_stock_id==t.state.cur_stock.FStockId)).map((t=>t.material_no));a({itemList:e,success:t=>{N("success"),this.plan_form.material_no=e[t.tapIndex],this.set_plan_form(e[t.tapIndex]),this.load_inv_plans(e[t.tapIndex])}})},scan_code(){E().then((t=>{this.handle_scan_code(t.result)})).catch((t=>{e({icon:"none",title:t})}))},handle_scan_code(t){R(t)?(this.set_plan_form(t),this.load_inv_plans(t)):T(t)?this.plan_form.loc_no=t:this.plan_form.material_no?plan.mount_form.loc_no||(this.plan_form.loc_no=t):(this.set_plan_form(t),this.load_inv_plans(t))},submit_save(){this.$refs.plan_form.validate().then((a=>{let s=this.inbound_task.inbound_list.find((t=>t.material_no==this.plan_form.material_no)),i=new D({FOpType:"in",FStockId:t.state.cur_stock.FStockId,FStockLocNo:this.plan_form.loc_no,FMaterialId:s.material_id,FOpQTY:1*this.plan_form.op_qty,FBatchNo:s.batch_no,FBillNo:this.inbound_task.bill_no,FOpStaffNo:t.state.cur_staff.FNumber,FRemark:this.plan_form.remark});o({title:"Loading"}),i.save().then((t=>{var a;N("success"),n(),t.data.Result.ResponseStatus.IsSuccess?(this.load_inv_plans(s.material_no),e({title:"保存成功"})):e({icon:"none",title:null==(a=t.data.Result.ResponseStatus.Errors[0])?void 0:a.Message}),this.reset_form()}))})).catch((t=>{}))},submit_delete(t){"A"==t.FDocumentStatu?(o({title:"Loading"}),D.delete([t.FID]).then((a=>{var o;if(n(),a.data.Result.ResponseStatus.IsSuccess){N("delete");let a=this.inv_plans.findIndex((a=>a.FID==t.FID));this.inv_plans.splice(a,1)}else e({icon:"none",title:null==(o=a.data.Result.ResponseStatus.Errors[0])?void 0:o.Message})}))):(this.$refs.inv_plan_swipe.closeAll(),e({icon:"error",title:"只能删除新增的计划"}))},load_inv_plans(a){o({title:"Loading"}),D.query({FStockId:t.state.cur_stock.FStockId,FBillNo:this.inbound_task.bill_no,"FMaterialId.FNumber":a,FOpType:"in"},{order:"FCreateTime DESC"}).then((a=>{this.inv_plans=a.data,this.inv_plans.forEach((a=>{"A"!=a.FDocumentStatu&&(a.status=t.state.document_status_dict[a.FDocumentStatu])})),n()}))},sum_inv_plan_op_qty(){return this.inv_plans.map((t=>t.FOpQTY)).concat([0]).reduce(((t,a)=>t+a))},set_plan_form(t){let a=this.inbound_task.inbound_list.find((a=>a.material_no==t));a?(this.plan_form.material_no=a.material_no,this.plan_form.base_unit_name=a.base_unit_name,this.plan_form.decimal_unit=V(a.base_unit_name)):(this.plan_form.material_no="",this.plan_form.base_unit_name="Pcs",this.plan_form.decimal_unit=!1)},reset_form(){this.plan_form.loc_no="",this.plan_form.op_qty="",this.plan_form.remark="",s({scrollTop:0})}}},[["render",function(t,a,e,o,n,s){const N=k,R=d,T=g(i("uni-list-item"),v),V=g(i("uni-list"),F),D=g(i("uni-section"),y),E=g(i("uni-forms-item"),x),L=g(i("uni-data-picker"),q),M=g(i("uni-easyinput"),S),O=g(i("uni-forms"),I),B=g(i("uni-swipe-action-item"),j),$=g(i("uni-swipe-action"),C),A=g(i("uni-goods-nav"),w);return m(),l(u,null,[_(D,{type:"square",title:"新增计划明细","sub-title":n.inbound_task.bill_no,"sub-title-color":"#007aff"},{default:r((()=>[n.plan_form.material_no?(m(),c(V,{key:0},{default:r((()=>[(m(!0),l(u,null,p(n.inbound_task.inbound_list,((e,o)=>(m(),l(u,{key:o},[e.material_no==n.plan_form.material_no&&e.dest_stock_id==t.$store.state.cur_stock.FStockId?(m(),c(T,{key:0,"right-text":[e.base_unit_qty,e.base_unit_name].join(" "),onClick:a[0]||(a[0]=t=>s.handle_material_no_click()),clickable:""},{body:r((()=>[_(R,{class:"uni-list-item__body"},{default:r((()=>[_(N,{class:"title"},{default:r((()=>[f(h(e.material_no),1)])),_:2},1024),_(R,{class:"note"},{default:r((()=>[_(R,null,{default:r((()=>[f("名称："+h(e.material_name),1)])),_:2},1024),_(R,null,{default:r((()=>[f("规格："+h(e.material_spec),1)])),_:2},1024),e.src_stock_name?(m(),c(R,{key:0},{default:r((()=>[f("调出仓库："+h(e.src_stock_name),1)])),_:2},1024)):b("",!0),_(R,null,{default:r((()=>[f("调入仓库："),_(N,{class:"text-primary"},{default:r((()=>[f(h(e.dest_stock_name),1)])),_:2},1024)])),_:2},1024),_(R,null,{default:r((()=>[f("批次："+h(e.batch_no),1)])),_:2},1024)])),_:2},1024)])),_:2},1024)])),_:2},1032,["right-text"])):b("",!0)],64)))),128))])),_:1})):(m(),c(V,{key:1},{default:r((()=>[_(T,{"show-extra-icon":!0,"extra-icon":{color:"#007bff",size:"24",type:"list"},title:"点击选择物料",onClick:s.handle_material_no_click,clickable:""},null,8,["onClick"])])),_:1}))])),_:1},8,["sub-title"]),_(R,{class:"container"},{default:r((()=>[_(O,{ref:"plan_form",model:n.plan_form,rules:n.plan_form_rules,labelWidth:"80px"},{default:r((()=>[_(E,{name:"material_no",style:{height:"0"}}),_(E,{label:"库位号",name:"loc_no",required:""},{default:r((()=>[_(L,{modelValue:n.plan_form.loc_no,"onUpdate:modelValue":a[1]||(a[1]=t=>n.plan_form.loc_no=t),localdata:t.$store.state.stock_loc_opts,split:"-","popup-title":"请选择库位"},null,8,["modelValue","localdata"])])),_:1}),_(E,{label:"上架数量",name:"op_qty",required:""},{default:r((()=>[_(M,{modelValue:n.plan_form.op_qty,"onUpdate:modelValue":a[2]||(a[2]=t=>n.plan_form.op_qty=t),type:"number"},{right:r((()=>[_(N,{class:"easyinput-suffix-text"},{default:r((()=>[f(h(n.plan_form.base_unit_name),1)])),_:1})])),_:1},8,["modelValue"])])),_:1}),_(E,{label:"备注",name:"remark"},{default:r((()=>[_(M,{modelValue:n.plan_form.remark,"onUpdate:modelValue":a[3]||(a[3]=t=>n.plan_form.remark=t),trim:"both"},null,8,["modelValue"])])),_:1})])),_:1},8,["model","rules"])])),_:1}),_(D,{type:"square",title:"当前计划明细",class:"above-uni-goods-nav"},{right:r((()=>[_(N,{class:"sum_op_qty"},{default:r((()=>[f("总和： "+h(s.sum_inv_plan_op_qty())+" "+h(n.plan_form.base_unit_name),1)])),_:1})])),default:r((()=>[_($,{ref:"inv_plan_swipe"},{default:r((()=>[(m(!0),l(u,null,p(n.inv_plans,((t,a)=>(m(),c(B,{key:a,threshold:60,"right-options":n.swipe_options,onClick:a=>s.swipe_action_click(a,t)},{default:r((()=>[_(T,{"show-extra-icon":!0,"extra-icon":{color:"#dd524d",size:"24",type:"arrow-up"},title:t["FStockLocId.FNumber"],note:t.FRemark},{footer:r((()=>[_(R,{class:"uni-list-item__foot"},{default:r((()=>[_(N,{class:"op_qty"},{default:r((()=>[f(h(t.FOpQTY)+" "+h(t["FStockUnitId.FName"]),1)])),_:2},1024),_(N,{class:"status"},{default:r((()=>[f(h(t.status),1)])),_:2},1024)])),_:2},1024)])),_:2},1032,["title","note"])])),_:2},1032,["right-options","onClick"])))),128))])),_:1},512)])),_:1}),_(R,{class:"uni-goods-nav-wrapper"},{default:r((()=>[_(A,{options:n.goods_nav.options,"button-group":n.goods_nav.button_group,fill:t.$store.state.goods_nav_fill,onClick:s.goods_nav_click,onButtonClick:s.goods_nav_button_click},null,8,["options","button-group","fill","onClick","onButtonClick"])])),_:1})],64)}],["__scopeId","data-v-433a4b81"]]);export{M as default};
