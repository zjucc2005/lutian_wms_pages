import{s as t,b as a,m as e,R as i,a as s,h as o,n,c as l,q as _,e as r,d as u,w as d,g as c,F as m,i as f,o as p,f as h,t as b,u as k,S as g,k as y,l as w,T as v,Q as F,M as C}from"./index-DjNCOAYS.js";import{_ as j}from"./uni-notice-bar.DbVVsFMY.js";import{r as q}from"./uni-app.es.Ch8d-HxS.js";import{_ as x}from"./uni-easyinput.C9ecXEkH.js";import{_ as I,a as $}from"./uni-forms.TRwwN9L2.js";import{_ as N}from"./uni-icons.CZYyaTue.js";import{_ as S,a as M}from"./uni-row.CNBrzn_m.js";import{_ as D}from"./uni-section.Cyvrqc16.js";import{_ as O}from"./uni-list-item.Dm5ieig7.js";import{_ as T}from"./uni-list.p66-62vf.js";import{_ as U}from"./uni-goods-nav.BCKosiBH.js";import{_ as V,a as B}from"./uni-swipe-action.nwLs6Yb7.js";import{_ as P}from"./uni-drawer.ByaJMmpI.js";import{p as Q,b as A}from"./index.uJty1kg6.js";import{a as z}from"./index.Bax3unEn.js";import{I as E}from"./inbound_task.DgvtGxBg.js";import"./k3cloudapi.B_cIKn_3.js";import{a as Y}from"./stock_loc.GXV191SF.js";import"./inv_log.B3mwqkWu.js";import{f as L}from"./date-format.Dm3Q97cL.js";import{s as R}from"./scan_code.DOvZ5dVY.js";import{_ as G}from"./yiwancheng_stamp.fi2kVvVZ.js";import{_ as H}from"./_plugin-vue_export-helper.BCo6x5W8.js";import"./uni-badge.DRmKIMEp.js";import"./bd_empinfo.DWgOFJvr.js";const J=H({data(){return{bd_materials:[],inbound_task:{},inv_plans:[],is_completed:!1,form:{raw:"",material_id:"",material_no:"",material_name:"",material_spec:"",base_unit_qty:"",base_unit_qty_focus:!1,base_unit_name:"Pcs",decimal_unit:!1},form_rules:{material_no:{rules:[{required:!0,errorMessage:"物料编号不能为空"},{validateFunction:(a,e,i,s)=>{let o=e,n=this.bd_materials.find((t=>t.FNumber==o));return n?"C"!=n.FDocumentStatus?s("物料编码未审核"):"A"!=n.FForbidStatus?s("物料编码被禁用"):void 0:z(o,t.state.cur_stock.FUseOrgId).then((a=>a.data[0]?(n=a.data[0],this.bd_materials.some((t=>t.FNumber==o))||this.bd_materials.push(a.data[0]),"C"!=n.FDocumentStatus?s("物料编码未审核"):"A"!=n.FForbidStatus?s("物料编码被禁用"):n):s(`[${t.state.cur_stock["FUseOrgId.FName"]}]不存在此物料编码`)))}}]},base_unit_qty:{rules:[{required:!0,errorMessage:"物料数量不能为空"},{format:"number",errorMessage:"物料数量只能输入数字"},{validateFunction:(t,a,e,i)=>a<=0?i("物料数量必须大于0"):this.form.decimal_unit||Number.isInteger(a)?void 0:i("物料数量必须为整数")}]}},swipe_options:[{text:"删除",style:{backgroundColor:"#dd524d"}}],goods_nav:{options:[{icon:"list",text:"明细",info:""}],button_group:[{text:"结束编辑入库计划",backgroundColor:t.state.goods_nav_color.grey,color:"#fff"},{text:"新增计划明细",backgroundColor:t.state.goods_nav_color.blue,color:"#fff"}]}}},onShow(){this.inbound_task=E.current()||new E({category:"pallet",stock_id:t.state.cur_stock.FStockId,stock_name:t.state.cur_stock.FName,staff_no:t.state.cur_staff.FNumber,bill_no:"IP"+L(Date.now(),"yyyyMMddhhmmss")}),"ongoing"==this.inbound_task.status&&this.load_inv_plans()},methods:{formatDate:L,add_to_inbound_task(){this.$refs.form.validate().then((t=>{let e=new E(this.inbound_task);this.inbound_task=e.add_pallet_info({raw:this.form.raw,material_id:this.form.material_id,material_no:this.form.material_no,material_name:this.form.material_name,material_spec:this.form.material_spec,base_unit_qty:Number(this.form.base_unit_qty),base_unit_name:this.form.base_unit_name,created_at:Date.now()}),this._init_form(),Q("success"),a({icon:"none",title:"提交成功"})})).catch((t=>{}))},after_scan_code(t){if(this.inbound_task.pallet_infos.find((a=>a.raw==t)))return void a({icon:"error",title:"标识卡已扫描过",duration:2e3});let e=t.split("||");this.form.raw=t,this.form.material_no=e[1],this.form.base_unit_qty_focus=!0,this.material_no_change()},delete_pallet_info(t){let a=new E(this.inbound_task);this.inbound_task=a.del_pallet_info(t),Q("delete")},form_icon_click(t){"scan"==t&&this.scan_code()},goods_nav_click(t){0===t.index&&(this.$refs.detail_drawer.open(),this.$logger.info("this.$data",this.$data))},goods_nav_button_click(t){0===t.index&&this.if_finish_inbound_task(),1===t.index&&this.if_new_plan()},if_finish_inbound_task(){e({title:"结束编辑入库计划",content:"结束编辑后，将会清除当前缓存的计划初始化信息，并且无法恢复。请在完成相关计划明细并确认无误后，再确认结束。",success:t=>{t.confirm&&(Q("delete"),E.destroy_all(),i())}})},if_new_plan(t){0!==this.inbound_task.inbound_list.length?"init"==this.inbound_task.status?e({title:"新增计划明细",content:"开始新增计划明细后，将不能继续录入物料标识卡信息。请确认已录完物料标识卡信息后，再新增计划明细。",success:a=>{a.confirm&&this.new_plan(t)}}):this.new_plan(t):a({icon:"none",title:"未添加物料信息"})},material_no_change(){let a=this.form.material_no;if(!a)return void this._set_base_unit();let e=this.bd_materials.find((t=>t.FNumber==a));e?this._set_base_unit(e):(s({title:"Loading"}),z(a,t.state.cur_stock.FUseOrgId).then((t=>{o(),t.data[0]?(e=t.data[0],this.bd_materials.some((t=>t.FNumber==a))||this.bd_materials.push(t.data[0]),this._set_base_unit(e)):this._set_base_unit()})))},new_plan(t){this.is_completed?a({icon:"none",title:"该计划已完成"}):n({url:"/pages/operation/inbound/v2/plan_new_pallet",success:a=>{Q("success");let e=new E(this.inbound_task);this.inbound_task=e.update({status:"ongoing"}),this.$logger.info("this.$data",this.$data),a.eventChannel.emit("sendInboundTask",{material_no:t})}})},scan_code(){R().then((t=>{this.after_scan_code(t.result)})).catch((t=>{a({icon:"none",title:t})}))},swipe_action_click(t,a){0===t.index&&"right"==t.position&&(this.delete_pallet_info(a),this.$refs.swipe_action.closeAll())},async load_inv_plans(){return Y.query({FStockId:t.state.cur_stock.FStockId,FBillNo:this.inbound_task.bill_no,FOpType:"in"},{}).then((t=>{this.inv_plans=t.data,this._calc_progress(t.data)}))},_calc_percentage(t){let a=0;return this.inv_plans.forEach((e=>{e.FMaterialId==t.material_id&&(a+=e.FOpQTY)})),a/t.base_unit_qty*100},_calc_progress(t=[]){if(0==this.inbound_task.inbound_list.length)return this.goods_nav.options[0].info="",void(this.is_completed=!1);let a=this.inbound_task.inbound_list.map((t=>t.base_unit_qty)).concat([0]).reduce(((t,a)=>t+a)),e=0,i=0;t.forEach((t=>{e+=t.FOpQTY,"C"==t.FDocumentStatu&&(i+=t.FOpQTY)}));let s=Math.floor(e/a*100);this.goods_nav.options[0].info=`${s}%`,this.is_completed=a==i},_init_form(){this.form={raw:"",material_id:"",material_no:"",material_name:"",material_spec:"",base_unit_qty:"",base_unit_name:"Pcs",decimal_unit:!1}},_pallet_count(t){return this.inbound_task.pallet_infos.filter((a=>a.material_no==t)).length},_set_base_unit(t){t?(this.form.material_id=t.FMaterialId,this.form.material_name=t.FName,this.form.material_spec=t.FSpecification,this.form.base_unit_name=t["FBaseUnitId.FName"],this.form.decimal_unit=A(t["FBaseUnitId.FName"])):(this.form.material_id="",this.form.material_name="",this.form.material_spec="",this.form.base_unit_name="Pcs",this.form.decimal_unit=!1)}}},[["render",function(t,a,e,i,s,o){var n;const Q=q(l("uni-notice-bar"),j),A=q(l("uni-easyinput"),x),z=f,E=q(l("uni-forms-item"),I),Y=y,L=q(l("uni-icons"),N),R=w,H=q(l("uni-col"),S),J=q(l("uni-row"),M),W=q(l("uni-forms"),$),Z=q(l("uni-section"),D),K=F,X=q(l("uni-list-item"),O),tt=q(l("uni-list"),T),at=q(l("uni-goods-nav"),U),et=C,it=q(l("uni-swipe-action-item"),V),st=q(l("uni-swipe-action"),B),ot=v,nt=q(l("uni-drawer"),P);return p(),_(m,null,[r(Q,{single:"",scrollable:"",text:"扫码获取物料标识卡信息后，下一步新增计划明细"}),"init"==s.inbound_task.status?(p(),u(Z,{key:0,title:"添加标识卡信息",type:"square","sub-title":"扫描物料标识卡获取物料信息"},{default:d((()=>[r(z,{class:"container"},{default:d((()=>[r(W,{ref:"form",model:s.form,rules:s.form_rules,labelWidth:"70px"},{default:d((()=>[r(E,{label:"物料编号",name:"material_no"},{default:d((()=>[r(A,{modelValue:s.form.material_no,"onUpdate:modelValue":a[0]||(a[0]=t=>s.form.material_no=t),trim:"both",focus:"","prefix-icon":"scan",onIconClick:a[1]||(a[1]=t=>o.form_icon_click("scan")),onChange:o.material_no_change,onClear:o.material_no_change},null,8,["modelValue","onChange","onClear"]),r(z,{class:"form-info"},{default:d((()=>[h("名称："+b(s.form.material_name||"-"),1)])),_:1}),r(z,{class:"form-info"},{default:d((()=>[h("规格："+b(s.form.material_spec||"-"),1)])),_:1})])),_:1}),r(E,{label:"物料数量",name:"base_unit_qty"},{default:d((()=>[r(A,{modelValue:s.form.base_unit_qty,"onUpdate:modelValue":a[2]||(a[2]=t=>s.form.base_unit_qty=t),type:"number",focus:s.form.base_unit_qty_focus,onConfirm:o.add_to_inbound_task},{right:d((()=>[r(Y,{class:"easyinput-suffix-text"},{default:d((()=>[h(b(s.form.base_unit_name),1)])),_:1})])),_:1},8,["modelValue","focus","onConfirm"])])),_:1}),r(J,null,{default:d((()=>[r(H,{span:12},{default:d((()=>[r(R,{onClick:o.scan_code,type:"warn",class:"form-btn left"},{default:d((()=>[r(L,{type:"scan",color:"#fff"}),h(" 扫码 ")])),_:1},8,["onClick"])])),_:1}),r(H,{span:12},{default:d((()=>[r(R,{onClick:o.add_to_inbound_task,type:"primary",class:"form-btn right"},{default:d((()=>[r(L,{type:"checkmarkempty",color:"#fff"}),h(" 提交 ")])),_:1},8,["onClick"])])),_:1})])),_:1})])),_:1},8,["model","rules"])])),_:1})])),_:1})):c("",!0),(null==(n=s.inbound_task.inbound_list)?void 0:n.length)?(p(),u(Z,{key:1,title:"当前物料信息(汇总)",type:"square","sub-title":s.inbound_task.bill_no,"sub-title-color":"#007aff",class:"above-uni-goods-nav"},{default:d((()=>[r(tt,null,{default:d((()=>[(p(!0),_(m,null,k(s.inbound_task.inbound_list,((t,a)=>(p(),u(X,{key:a,onClick:a=>o.if_new_plan(t.material_no),clickable:"","show-arrow":""},{body:d((()=>[r(z,{class:"uni-list-item__body"},{default:d((()=>[r(Y,{class:"title"},{default:d((()=>[h(b(t.material_no),1)])),_:2},1024),r(z,{class:"note"},{default:d((()=>[r(z,null,{default:d((()=>[h("名称："+b(t.material_name),1)])),_:2},1024),r(z,null,{default:d((()=>[h("规格："+b(t.material_spec),1)])),_:2},1024),t.src_stock_name?(p(),u(z,{key:0},{default:d((()=>[h("调出仓库："+b(t.src_stock_name),1)])),_:2},1024)):c("",!0),r(z,null,{default:d((()=>[h("调入仓库："),r(Y,{class:"text-primary"},{default:d((()=>[h(b(t.dest_stock_name),1)])),_:2},1024)])),_:2},1024),r(z,null,{default:d((()=>[h("批次："+b(t.batch_no),1)])),_:2},1024)])),_:2},1024)])),_:2},1024)])),footer:d((()=>[r(z,{class:"uni-list-item__foot"},{default:d((()=>[r(Y,null,{default:d((()=>[h(b(t.base_unit_qty)+" "+b(t.base_unit_name),1)])),_:2},1024),r(K,{percent:o._calc_percentage(t),"stroke-width":"2","active-color":100==o._calc_percentage(t)?"#4cd964":"#f0ad4e"},null,8,["percent","active-color"]),r(Y,{class:"status"},{default:d((()=>[h(b(o._pallet_count(t.material_no))+" 托",1)])),_:2},1024)])),_:2},1024)])),_:2},1032,["onClick"])))),128))])),_:1})])),_:1},8,["sub-title"])):c("",!0),r(z,{class:"uni-goods-nav-wrapper"},{default:d((()=>[r(at,{options:s.goods_nav.options,"button-group":s.goods_nav.button_group,fill:t.$store.state.goods_nav_fill,onClick:o.goods_nav_click,onButtonClick:o.goods_nav_button_click},null,8,["options","button-group","fill","onClick","onButtonClick"])])),_:1}),s.is_completed?(p(),u(et,{key:2,src:G,class:"cover-image"})):c("",!0),r(nt,{ref:"detail_drawer",width:t.$store.state.drawer_width},{default:d((()=>[r(ot,{"scroll-y":"",style:{height:"100%"},onTouchmove:a[4]||(a[4]=g((()=>{}),["stop"]))},{default:d((()=>[r(Z,{title:"操作明细",type:"square","sub-title":"init"==s.inbound_task.status&&"app-plus"==t.$store.state.device_type?"左滑可删除":""},{right:d((()=>[r(z,{class:"uni-section__right"},{default:d((()=>[r(L,{type:"closeempty",size:"24",color:"#333",onClick:a[3]||(a[3]=a=>t.$refs.detail_drawer.close())})])),_:1})])),default:d((()=>[r(st,{ref:"swipe_action"},{default:d((()=>[(p(!0),_(m,null,k(s.inbound_task.pallet_infos,((a,e)=>(p(),u(it,{key:e,threshold:60,"right-options":"init"==s.inbound_task.status?s.swipe_options:[],onClick:t=>o.swipe_action_click(t,a._id)},{default:d((()=>[r(X,null,{body:d((()=>[r(z,{class:"uni-list-item__body"},{default:d((()=>[r(Y,{class:"title"},{default:d((()=>[h(b(a.material_no),1)])),_:2},1024),r(z,{class:"note"},{default:d((()=>[r(z,null,{default:d((()=>[h("名称："+b(a.material_name),1)])),_:2},1024),r(z,null,{default:d((()=>[h("规格："+b(a.material_spec),1)])),_:2},1024),r(z,null,{default:d((()=>[h("提交时间："+b(o.formatDate(a.created_at,"yyyy-MM-dd hh:mm:ss")),1)])),_:2},1024)])),_:2},1024)])),_:2},1024)])),footer:d((()=>[r(z,{class:"uni-list-item__foot flex-row"},{default:d((()=>[r(z,null,{default:d((()=>[h(b(a.base_unit_qty)+" "+b(a.base_unit_name),1)])),_:2},1024),"h5"==t.$store.state.device_type?(p(),u(z,{key:0},{default:d((()=>[r(L,{type:"trash",size:"24",color:"#dd524d",onClick:t=>o.delete_pallet_info(a._id),class:"uni-ml-5"},null,8,["onClick"])])),_:2},1024)):c("",!0)])),_:2},1024)])),_:2},1024)])),_:2},1032,["right-options","onClick"])))),128))])),_:1},512)])),_:1},8,["sub-title"])])),_:1})])),_:1},8,["width"])],64)}],["__scopeId","data-v-609a77f1"]]);export{J as default};
