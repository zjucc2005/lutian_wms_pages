import{s as t,h as e,a,c as s,q as i,e as r,w as o,F as _,o as n,i as d}from"./index-DjNCOAYS.js";import{_ as h}from"./qiun-data-charts.ButfcOy6.js";import{r as l}from"./uni-app.es.Ch8d-HxS.js";import{_ as c}from"./uni-section.Cyvrqc16.js";import{_ as m}from"./uni-segmented-control.BrXUwpis.js";import{f as u}from"./date-format.Dm3Q97cL.js";import"./k3cloudapi.B_cIKn_3.js";import{I as p}from"./stock_loc.GXV191SF.js";import{I as y}from"./inv_log.B3mwqkWu.js";import{_ as g}from"./_plugin-vue_export-helper.BCo6x5W8.js";const f=g({data:()=>({raw_data:[],invs:[],sum_inv_qty:0,mode:"day",stime:null,type:"line",opts:{enableScroll:!0,scrollPosition:"right",xAxis:{scrollShow:!0,scrollAlign:"right",itemCount:Math.max(Math.floor(t.state.system_info.windowWidth/60),8)},extra:{line:{type:"curve",width:2,activeType:"hollow"}}},chart_data:{categories:[],series:[]}}),mounted(){this._get_stime(),this.load_data()},methods:{segment_click(t){0===t.currentIndex&&this._set_chart_data_day(),1===t.currentIndex&&this._set_chart_data_week(),2===t.currentIndex&&this._set_chart_data_month()},async load_invs(){const a={FStockId:t.state.cur_stock.FStockId};return p.get_all(a).then((t=>{e(),this.invs=t;let a=0;t.forEach((t=>{a+=t.FQty})),this.sum_inv_qty=a}))},async load_data(){try{let s={FOpType_in:["in","in_cl","out","out_cl","add","sub"],FStockId:t.state.cur_stock.FStockId,FCreateTime_ge:u(this.stime,"yyyy-MM-dd")};a({title:"Loading"}),await this.load_invs();let i=await y.inventory_record(s);e(),this.raw_data=i.map((t=>(t[4]=Number(new Date(t[3])),t))),this._set_chart_data_day()}catch(s){}},_set_chart_data_month(){this.mode="month";let t=[],e=[],a=this.stime.getFullYear(),s=this.stime.getMonth(),i=this.sum_inv_qty;for(let r=0;r<12;r++){let o=a,_=s+r;_>11&&(o+=1,_-=12);let n=new Date(o,_,1),d=o,h=_+1;h>11&&(d+=1,h-=12);let l=new Date(d,h,1);t.push(u(n,"yy.MM")),e.push(i),i-=this._sum_delta(n,l)}this.chart_data={categories:t,series:[{name:"库存量",data:e}]}},_set_chart_data_week(){this.mode="week";let t=[],e=[],a=this.stime,s=this._get_today(),i=this.sum_inv_qty,r=s.getDay();for(s=1===r?Number(s):Number(s)+24*(8-r)*3600*1e3;s>=a;){let a=s-6048e5;t.push(u(s,"MM.dd")),e.push(i),i-=this._sum_delta(a,s),s=a}t.reverse(),e.reverse(),this.chart_data={categories:t,series:[{name:"库存量",data:e}]}},_set_chart_data_day(){this.mode="day";let t=864e5,e=[],a=[],s=Number(this.stime),i=1*this._get_today(),r=this.sum_inv_qty;for(;i>=s;)e.push(u(i,"MM.dd")),a.push(r),r-=this._sum_delta(i,i+t),i-=t;e.reverse(),a.reverse(),this.chart_data={categories:e,series:[{name:"库存量",data:a}]}},_sum_delta(t,e){let a=0;return this.raw_data.forEach((s=>{s[4]>=t&&s[4]<e&&(s[2]<0?a+=s[1]-s[2]:a+=s[1])})),a},_get_stime(){let t=new Date(Date.now()-7776e6),e=t.getFullYear(),a=t.getMonth(),s=t.getDate();this.stime=new Date(e,a,s)},_get_today(){let t=new Date,e=t.getFullYear(),a=t.getMonth(),s=t.getDate();return new Date(e,a,s)},debug(t){this.$logger.info("debug",this.$data)}}},[["render",function(t,e,a,u,p,y){const g=l(s("qiun-data-charts"),h),f=l(s("uni-section"),c),w=l(s("uni-segmented-control"),m),v=d;return n(),i(_,null,[r(f,{title:"出入库数量统计",type:"square"},{default:o((()=>[r(g,{type:p.type,opts:p.opts,"chart-data":p.chart_data,ontouch:""},null,8,["type","opts","chart-data"])])),_:1}),r(f,{title:"设置",type:"square"},{default:o((()=>[r(v,{class:"container"},{default:o((()=>[r(w,{current:0,values:["日视图"],onClickItem:y.segment_click},null,8,["onClickItem"])])),_:1})])),_:1})],64)}]]);export{f as default};
