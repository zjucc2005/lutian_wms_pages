import{A as e,B as o,c as t,o as a,d as s,w as r,e as i,C as l,D as n,f as c,t as m,g as _,i as u,I as d,k as h,s as f,$ as p,E as v,n as y,b as g,a as b,h as k,q as x,u as F,F as C}from"./index-DsK9pIyj.js";import{_ as w}from"./uni-icons.DRoE6XYp.js";import{r as S}from"./uni-app.es.CSK8ITuj.js";import{_ as V}from"./_plugin-vue_export-helper.BCo6x5W8.js";import{_ as j}from"./uni-list-item.BkmqxiQh.js";import{_ as I}from"./uni-list.dJf-6p1_.js";import{_ as B}from"./uni-section.BpQrEx4g.js";import{_ as N}from"./uni-goods-nav.BN-nj5na.js";import{_ as q,a as T}from"./uni-row.CMhOpWuA.js";import{_ as $}from"./uni-data-picker.MxVuyZ-u.js";import{_ as E,a as z}from"./uni-forms.DoSYlyoS.js";import{_ as U}from"./uni-number-box.DOITgqEr.js";import{_ as A,a as L}from"./uni-popup.CPWlX1tX.js";import{a as Q}from"./index.DEl4oXeA.js";import{M as D}from"./move_cart.DtB91in8.js";import"./k3cloudapi.PCDjx1SF.js";import{I as M}from"./stock_loc.Bj3C3Byx.js";import"./inv_log.D0BShjlW.js";import{s as H}from"./scan_code.CGa79-3n.js";import"./uni-badge.CO78OwkC.js";import"./uni-load-more.CyJx3ZKG.js";import"./bd_empinfo.DSF0B_p6.js";const O={en:{"uni-search-bar.cancel":"cancel","uni-search-bar.placeholder":"Search enter content"},"zh-Hans":{"uni-search-bar.cancel":"取消","uni-search-bar.placeholder":"请输入搜索内容"},"zh-Hant":{"uni-search-bar.cancel":"取消","uni-search-bar.placeholder":"請輸入搜索內容"}},{t:P}=e(O);const G=V({name:"UniSearchBar",emits:["input","update:modelValue","clear","cancel","confirm","blur","focus"],props:{placeholder:{type:String,default:""},radius:{type:[Number,String],default:5},clearButton:{type:String,default:"auto"},cancelButton:{type:String,default:"auto"},cancelText:{type:String,default:""},bgColor:{type:String,default:"#F8F8F8"},textColor:{type:String,default:"#000000"},maxlength:{type:[Number,String],default:100},value:{type:[Number,String],default:""},modelValue:{type:[Number,String],default:""},focus:{type:Boolean,default:!1},readonly:{type:Boolean,default:!1}},data:()=>({show:!1,showSync:!1,searchVal:""}),computed:{cancelTextI18n(){return this.cancelText||P("uni-search-bar.cancel")},placeholderText(){return this.placeholder||P("uni-search-bar.placeholder")}},watch:{modelValue:{immediate:!0,handler(e){this.searchVal=e,e&&(this.show=!0)}},focus:{immediate:!0,handler(e){if(e){if(this.readonly)return;this.show=!0,this.$nextTick((()=>{this.showSync=!0}))}}},searchVal(e,o){this.$emit("input",e),this.$emit("update:modelValue",e)}},methods:{searchClick(){this.readonly||this.show||(this.show=!0,this.$nextTick((()=>{this.showSync=!0})))},clear(){this.searchVal="",this.$nextTick((()=>{this.$emit("clear",{value:""})}))},cancel(){this.readonly||(this.$emit("cancel",{value:this.searchVal}),this.searchVal="",this.show=!1,this.showSync=!1,o())},confirm(){o(),this.$emit("confirm",{value:this.searchVal})},blur(){o(),this.$emit("blur",{value:this.searchVal})},emitFocus(e){this.$emit("focus",e.detail)}}},[["render",function(e,o,f,p,v,y){const g=S(t("uni-icons"),w),b=u,k=d,x=h;return a(),s(b,{class:"uni-searchbar"},{default:r((()=>[i(b,{style:l({borderRadius:f.radius+"px",backgroundColor:f.bgColor}),class:"uni-searchbar__box",onClick:y.searchClick},{default:r((()=>[i(b,{class:"uni-searchbar__box-icon-search"},{default:r((()=>[n(e.$slots,"searchIcon",{},(()=>[i(g,{color:"#c0c4cc",size:"18",type:"search"})]),!0)])),_:3}),v.show||v.searchVal?(a(),s(k,{key:0,focus:v.showSync,disabled:f.readonly,placeholder:y.placeholderText,maxlength:f.maxlength,class:"uni-searchbar__box-search-input","confirm-type":"search",type:"text",modelValue:v.searchVal,"onUpdate:modelValue":o[0]||(o[0]=e=>v.searchVal=e),style:l({color:f.textColor}),onConfirm:y.confirm,onBlur:y.blur,onFocus:y.emitFocus},null,8,["focus","disabled","placeholder","maxlength","modelValue","style","onConfirm","onBlur","onFocus"])):(a(),s(x,{key:1,class:"uni-searchbar__text-placeholder"},{default:r((()=>[c(m(f.placeholder),1)])),_:1})),v.show&&("always"===f.clearButton||"auto"===f.clearButton&&""!==v.searchVal)&&!f.readonly?(a(),s(b,{key:2,class:"uni-searchbar__box-icon-clear",onClick:y.clear},{default:r((()=>[n(e.$slots,"clearIcon",{},(()=>[i(g,{color:"#c0c4cc",size:"20",type:"clear"})]),!0)])),_:3},8,["onClick"])):_("",!0)])),_:3},8,["style","onClick"]),"always"===f.cancelButton||v.show&&"auto"===f.cancelButton?(a(),s(x,{key:0,onClick:y.cancel,class:"uni-searchbar__cancel"},{default:r((()=>[c(m(y.cancelTextI18n),1)])),_:1},8,["onClick"])):_("",!0)])),_:3})}],["__scopeId","data-v-314f636a"]]);const J=V({data(){return{cur_stock:{},cur_staff:{},stock_locs:[],stock_loc_opts:[],bd_materials:[],invs:[],move_cart:{move_list:[]},material:{material_no:"",material_name:"",material_spec:"",base_unit_name:""},search_form:{no:""},move_dialog:{confirm_text:"新增"},move_form:{action:"new",inv:{},loc_no:"",qty:0},move_form_rules:{loc_no:{rules:[{required:!0,errorMessage:"库位号不能为空"},{validateFunction:(e,o,t,a)=>{if(o==this.move_form.inv["FStockLocId.FNumber"])return a("库位号不能相同")}}]},qty:{rules:[{validateFunction:(e,o,t,a)=>{if(o<0)return a("调整数量不能小于0");let s=this.move_form.inv.FQty;return this.move_cart.move_list.forEach((e=>{e.inv.FID==this.move_form.inv.FID&&e.loc_no!=this.move_form.loc_no&&(s-=e.qty)})),s<o?a("调整总数不能超过当前库存"):void 0}}]}},goods_nav:{options:[{icon:"cart",text:"计划",info:0}],button_group:[{text:"扫码查询",backgroundColor:"linear-gradient(90deg, #FE6035, #EF1224)",color:"#fff"},{text:"预览计划",backgroundColor:"linear-gradient(90deg, #1E83FF, #0053B8)",color:"#fff"}]}}},mounted(){this.cur_stock=f.state.cur_stock,this.cur_staff=f.state.cur_staff,this.move_cart=D.current(),this.refresh_cart_info(),this.load_stock_locs(),this.search_form.no&&this.handle_search();let e=this;p("syncMoveCart"),v("syncMoveCart",(function(o){e.move_cart=D.current(),e.refresh_cart_info(),e.handle_search()}))},methods:{goods_nav_click(e){0==e.index&&this.preview_cart()},goods_nav_button_click(e){0==e.index&&this.scan_code(),1==e.index&&this.preview_cart()},load_stock_locs(){this.stock_locs=f.state.stock_locs,this.stock_loc_opts=f.state.stock_loc_opts},preview_cart(){y({url:"/pages/operation/move/v1/move_cart"})},scan_code(){H().then((e=>{this.handle_inv_search(e.result)})).catch((e=>{g({icon:"none",title:e})}))},handle_inv_search(e){this.search_form.no=e,this.handle_search()},async handle_search(e){if(b({title:"Loading"}),this.search_form.no){let e=this.search_form.no,o=this.bd_materials.find((o=>o.FNumber==e));o||(o=await this.load_material(e)),this.set_material(o),o?this.load_invs(e):this.invs=[]}else this.set_material(),this.invs=[];k()},async load_material(e){let o=await Q(e,this.cur_stock.FUseOrgId);if(o.data[0])return this.bd_materials.push(o.data[0]),o.data[0]},set_material(e){e?(this.material.material_no=e.FNumber,this.material.material_name=e.FName,this.material.material_spec=e.FSpecification,this.material.base_unit_name=e["FBaseUnitId.FName"]):(this.material.material_no="",this.material.material_name="",this.material.material_spec="",this.material.base_unit_name="Pcs")},load_invs(e){M.query({FStockId:this.cur_stock.FStockId,"FMaterialId.FNumber":e,FQty_gt:0},{order:"FStockLocId.FNumber ASC, FBatchNo ASC"}).then((e=>{this.invs=e.data}))},open_move_dialog(e,o){this.move_form.inv=e,o?(this.move_form.loc_no=o.loc_no,this.move_form.qty=o.qty,this.move_form.action="edit",this.move_dialog.confirm_text="修改"):(this.move_form.action="new",this.move_dialog.confirm_text="新增"),this.$refs.move_dialog.open()},close_move_dialog(){this.$refs.move_dialog.close(),this.move_form={inv:{},loc_no:"",qty:0}},confirm_move_dialog(){this.$refs.move_form.validate().then((e=>{let o=new D(this.move_cart);this.move_cart=o.update(this.move_form),this.refresh_cart_info(),this.close_move_dialog()})).catch((e=>{}))},refresh_cart_info(){let e=0;this.move_cart.move_list.map((o=>e+=o.qty)),this.goods_nav.options[0].info=e}}},[["render",function(e,o,l,n,d,f){const p=S(t("uni-search-bar"),G),v=S(t("uni-list-item"),j),y=S(t("uni-list"),I),g=S(t("uni-section"),B),b=S(t("uni-goods-nav"),N),k=u,V=S(t("uni-col"),q),Q=S(t("uni-icons"),w),D=S(t("uni-data-picker"),$),M=S(t("uni-forms-item"),E),H=S(t("uni-row"),T),O=h,P=S(t("uni-number-box"),U),J=S(t("uni-forms"),z),K=S(t("uni-popup-dialog"),A),R=S(t("uni-popup"),L);return a(),s(k,null,{default:r((()=>[i(g,{title:"查询物料编码",type:"line"},{default:r((()=>[i(p,{modelValue:d.search_form.no,"onUpdate:modelValue":o[0]||(o[0]=e=>d.search_form.no=e),focus:!0,bgColor:"#EEEEEE",cancelButton:"none",onConfirm:f.handle_search,onClear:f.handle_search},null,8,["modelValue","onConfirm","onClear"]),d.material.material_no?(a(),s(y,{key:0},{default:r((()=>[i(v,{title:d.material.material_no,note:[d.material.material_name,d.material.material_spec].join("\n"),"show-extra-icon":!0,"extra-icon":{color:"#007bff",size:"24",type:"info"}},null,8,["title","note"])])),_:1})):_("",!0)])),_:1}),d.invs.length?(a(),s(g,{key:0,title:"库存列表",type:"line",class:"above-uni-goods-nav"},{default:r((()=>[i(y,null,{default:r((()=>[(a(!0),x(C,null,F(d.invs,((e,o)=>(a(),x(C,{key:o},[i(v,{title:e["FStockLocId.FNumber"],note:e.FBatchNo,rightText:[e.FQty,e["FStockUnitId.FName"]].join(" "),onClick:o=>f.open_move_dialog(e),clickable:"",showArrow:""},null,8,["title","note","rightText","onClick"]),(a(!0),x(C,null,F(d.move_cart.move_list.filter((o=>o.inv.FID==e.FID)),((o,t)=>(a(),s(v,{key:t,title:o.loc_no,rightText:[o.qty,o.inv["FStockUnitId.FName"]].join(" "),"show-extra-icon":!0,"extra-icon":{color:"#007bff",size:"24",type:"redo"},onClick:t=>f.open_move_dialog(e,o),clickable:"",showArrow:"",style:{"background-color":"#f0f0f0"}},null,8,["title","rightText","onClick"])))),128))],64)))),128))])),_:1})])),_:1})):_("",!0),i(k,{class:"uni-goods-nav-wrapper"},{default:r((()=>[i(b,{options:d.goods_nav.options,"button-group":d.goods_nav.button_group,onClick:f.goods_nav_click,onButtonClick:f.goods_nav_button_click},null,8,["options","button-group","onClick","onButtonClick"])])),_:1}),i(R,{ref:"move_dialog",type:"dialog"},{default:r((()=>[i(K,{type:"error",title:"调整计划",cancelText:"关闭",confirmText:d.move_dialog.confirm_text,onClose:f.close_move_dialog,onConfirm:f.confirm_move_dialog,beforeClose:!0},{default:r((()=>[i(k,{class:"move-form"},{default:r((()=>[i(J,{ref:"move_form",model:d.move_form,rules:d.move_form_rules},{default:r((()=>[i(H,null,{default:r((()=>[i(V,{span:8,class:"move-form-left"},{default:r((()=>[c(m(d.move_form.inv["FStockLocId.FNumber"]||"-"),1)])),_:1}),i(V,{span:4,class:"move-form-center"},{default:r((()=>[i(Q,{type:"redo",size:20,color:"#007bff"})])),_:1}),i(V,{span:12,class:"move-form-right"},{default:r((()=>[i(M,{name:"loc_no"},{default:r((()=>[i(D,{modelValue:d.move_form.loc_no,"onUpdate:modelValue":o[1]||(o[1]=e=>d.move_form.loc_no=e),localdata:d.stock_loc_opts,split:"-","popup-title":"请选择库位",readonly:"edit"==this.move_form.action},null,8,["modelValue","localdata","readonly"])])),_:1})])),_:1})])),_:1}),i(H,null,{default:r((()=>[i(V,{span:8,class:"move-form-left"},{default:r((()=>[c(m(d.move_form.inv.FBatchNo||"-"),1)])),_:1}),i(V,{span:4,class:"move-form-center"},{default:r((()=>[i(Q,{type:"redo",size:20,color:"#007bff"})])),_:1}),i(V,{span:12,class:"move-form-right"},{default:r((()=>[c(m(d.move_form.inv.FBatchNo),1)])),_:1})])),_:1}),i(H,null,{default:r((()=>[i(V,{span:8,class:"move-form-left"},{default:r((()=>[c(m(d.move_form.inv.FQty||"-")+" ",1),d.move_form.qty?(a(),s(O,{key:0,class:"moving-qty"},{default:r((()=>[c("- "+m(d.move_form.qty),1)])),_:1})):_("",!0)])),_:1}),i(V,{span:4,class:"move-form-center"},{default:r((()=>[i(Q,{type:"redo",size:20,color:"#007bff"})])),_:1}),i(V,{span:12,class:"move-form-right"},{default:r((()=>[i(M,{name:"qty",style:{"padding-top":"5px"}},{default:r((()=>[i(P,{modelValue:d.move_form.qty,"onUpdate:modelValue":o[2]||(o[2]=e=>d.move_form.qty=e),min:0,max:d.move_form.inv.FQty,width:60},null,8,["modelValue","max"])])),_:1})])),_:1})])),_:1})])),_:1},8,["model","rules"])])),_:1})])),_:1},8,["confirmText","onClose","onConfirm"])])),_:1},512)])),_:1})}],["__scopeId","data-v-828241b5"]]);export{J as default};
