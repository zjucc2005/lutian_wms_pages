import{s as t,b as o,a as e,h as a,n as s,c as n,d as i,w as l,i as r,o as _,e as u,f as c,t as d,g as h,q as p,u as m,F as f,M as b,k,Q as v}from"./index-MIvYX1nW.js";import{_ as g}from"./uni-notice-bar.BrdymbPY.js";import{r as y}from"./uni-app.es.B8zr0lZI.js";import{_ as w}from"./uni-easyinput.BboSH9MB.js";import{_ as I}from"./uni-list-item.Dk-snU2X.js";import{_ as x}from"./uni-list.zX7C8YBn.js";import{_ as C}from"./uni-section.C7O4oyAr.js";import{_ as j}from"./uni-goods-nav.DSaXBg-u.js";import{K as F}from"./k3cloudapi.DzDu3BGl.js";import{p as D}from"./index.DbF5UMRK.js";import{O as S}from"./outbound_task.D0tt6Qq5.js";import{a as q}from"./stock_loc.BckAHwoS.js";import"./inv_log.BJcJnepW.js";import{s as E}from"./scan_code.bSbj3X8t.js";import{a as N}from"./gen_pdf.D9XpIlx9.js";import{_ as T}from"./yiwancheng_stamp.fi2kVvVZ.js";import{_ as R}from"./_plugin-vue_export-helper.BCo6x5W8.js";import"./uni-icons.DEYikQDp.js";import"./uni-badge.DDwx_b0i.js";import"./date-format.Dm3Q97cL.js";const V=R({data:()=>({outbound_task:{},inv_plans:[],search_form:{bill_no:""},is_completed:!1,goods_nav:{options:[{icon:"cart",text:"计划",info:""},{icon:"map",text:"PDF"}],button_group:[{text:"扫码查询单据",backgroundColor:t.state.goods_nav_color.red,color:"#fff"},{text:"新增计划明细",backgroundColor:t.state.goods_nav_color.blue,color:"#fff"}]}}),onShow(){this.handle_search()},mounted(){this.outbound_task=new S},methods:{goods_nav_click(t){0===t.index&&this.$logger.info("this.$data",this.$data),1===t.index&&this.preview_pdf()},goods_nav_button_click(t){0===t.index&&this.scan_code(),1===t.index&&this.new_plan()},searchbar_icon_click(t){"prefix"==t&&this.scan_code()},scan_code(){E().then((t=>{this.search_form.bill_no=t.result,this.handle_search()})).catch((t=>{o({icon:"none",title:t})}))},async handle_search(t){this.is_completed=!1,this.outbound_task=new S,this.search_form.bill_no?(this.search_form.bill_no=this.search_form.bill_no.trim().toUpperCase(),this.search_form.bill_no.match(/^\d+$/)&&(this.search_form.bill_no="FHTZD"+this.search_form.bill_no),await this.load_bill(),await this.load_inv_plans()):this._calc_progress()},async load_bill(){let t=this.search_form.bill_no;if(t.startsWith("FHTZD"))return e({title:"Loading"}),F.view("SAL_DELIVERYNOTICE",{Number:t}).then((t=>{a(),this._handle_fhtzd_data(t)})).catch((t=>{o({icon:"none",title:t})}));this.outbound_task=new S,o({icon:"none",title:"未找到单据信息"})},async load_inv_plans(){let o=this.search_form.bill_no;if(o.startsWith("FHTZD"))return e({title:"Loading"}),q.query({FStockId:t.state.cur_stock.FStockId,FBillNo:o,FOpType:"out"},{}).then((t=>{a(),this.inv_plans=t.data,this._calc_progress(t.data)}));this.inv_plans=[]},async preview_pdf(){if(!this.inv_plans.length)return void o({icon:"none",title:"未找到计划信息"});let t=N(this.inv_plans,{receiver:this.outbound_task.receiver});window.open(`#/pages/my/preview_pdf?url=${t}`,"newWindow","width=800")},new_plan(t){this.search_form.bill_no?0!=this.outbound_task.outbound_list.length?this.is_completed?o({icon:"none",title:"该单据已完成"}):s({url:"/pages/operation/outbound/v2/plan_new",success:o=>{D("success"),o.eventChannel.emit("sendOutboundTask",{outbound_task:this.outbound_task,material_no:t})}}):o({icon:"none",title:"未找到单据信息"}):o({icon:"none",title:"单据编号不能为空"})},_calc_percentage(t){let o=0;return this.inv_plans.forEach((e=>{e.FMaterialId==t.material_id&&(o+=e.FOpQTY)})),o/t.base_unit_qty*100},_calc_progress(t=[]){if(0==this.outbound_task.outbound_list.length)return this.goods_nav.options[0].info="",void(this.is_completed=!1);let o=this.outbound_task.outbound_list.map((t=>t.base_unit_qty)).concat([0]).reduce(((t,o)=>t+o)),e=0,a=0;t.forEach((t=>{e+=t.FOpQTY,"C"==t.FDocumentStatu&&(a+=t.FOpQTY)}));let s=Math.floor(e/o*100);this.goods_nav.options[0].info=`${s}%`,this.is_completed=o==a},_handle_fhtzd_data(e){var a;if(e.data.Result.ResponseStatus.IsSuccess){const o=e.data.Result.Result;let a=[];o.SAL_DELIVERYNOTICEENTRY.forEach((t=>{var o,e,s,n;let i=a.find((o=>o.material_id==t.MaterialID_Id));i?i.base_unit_qty+=t.BaseUnitQty:a.push({material_id:t.MaterialID.Id,material_no:t.MaterialID.Number,material_name:null==(o=t.MaterialID.Name[0])?void 0:o.Value,material_spec:null==(e=t.MaterialID.Specification[0])?void 0:e.Value,base_unit_qty:t.BaseUnitQty,base_unit_name:null==(s=t.BaseUnitID.Name[0])?void 0:s.Value,base_unit_no:t.BaseUnitID.Number,stock_id:t.StockID.Id,stock_name:null==(n=t.StockID.Name[0])?void 0:n.Value,planned_qty:0,remain_out_qty:t.RemainOutQty})})),this.outbound_task.bill_no=o.BillNo,this.outbound_task.receiver=o.F_PAEZ_Text,this.outbound_task.stock_id=t.state.cur_stock.FStockId,this.outbound_task.staff_no=t.state.cur_staff.FNumber,this.outbound_task.outbound_list=a}else this.outbound_task=new S,o({icon:"none",title:null==(a=e.data.Result.ResponseStatus.Errors[0])?void 0:a.Message})}}},[["render",function(t,o,e,a,s,F){const D=y(n("uni-notice-bar"),g),S=y(n("uni-easyinput"),w),q=r,E=y(n("uni-list-item"),I),N=y(n("uni-list"),x),R=y(n("uni-section"),C),V=k,B=v,M=y(n("uni-goods-nav"),j),O=b;return _(),i(q,null,{default:l((()=>{var e;return[u(D,{single:"",scrollable:"",text:"扫码获取单据中物料清单后，下一步新增计划明细"}),u(R,{title:"查询单据编号",type:"square"},{default:l((()=>{var t;return[u(q,{class:"searchbar-container"},{default:l((()=>[u(S,{modelValue:s.search_form.bill_no,"onUpdate:modelValue":o[0]||(o[0]=t=>s.search_form.bill_no=t),placeholder:"请输入搜索内容","prefix-icon":"scan",onConfirm:F.handle_search,onClear:F.handle_search,onIconClick:F.searchbar_icon_click,"primary-color":"rgb(238, 238, 238)",styles:{color:"#000",backgroundColor:"rgb(238, 238, 238)",borderColor:"rgb(238, 238, 238)"}},null,8,["modelValue","onConfirm","onClear","onIconClick","styles"])])),_:1}),(null==(t=s.outbound_task)?void 0:t.receiver)?(_(),i(N,{key:0},{default:l((()=>[u(E,{"show-extra-icon":!0,"extra-icon":{type:"person",color:"#007bff"},title:"收货人"},{footer:l((()=>[u(q,{class:"uni-list-item__foot"},{default:l((()=>[u(q,{class:"text-dark text-lg text-bold"},{default:l((()=>[c(d(s.outbound_task.receiver),1)])),_:1})])),_:1})])),_:1})])),_:1})):h("",!0)]})),_:1}),(null==(e=s.outbound_task.outbound_list)?void 0:e.length)?(_(),i(R,{key:0,title:"出库物料信息",type:"square",class:"above-uni-goods-nav"},{default:l((()=>[u(N,null,{default:l((()=>[(_(!0),p(f,null,m(s.outbound_task.outbound_list,((o,e)=>(_(),i(E,{key:e,"show-arrow":"",onClick:t=>F.new_plan(o.material_no),clickable:o.stock_id==t.$store.state.cur_stock.FStockId,disabled:o.stock_id!=t.$store.state.cur_stock.FStockId},{body:l((()=>[u(q,{class:"uni-list-item__body"},{default:l((()=>[u(V,{class:"title"},{default:l((()=>[c(d(o.material_no),1)])),_:2},1024),u(q,{class:"note"},{default:l((()=>[u(q,null,{default:l((()=>[c("名称："+d(o.material_name),1)])),_:2},1024),u(q,null,{default:l((()=>[c("规格："+d(o.material_spec),1)])),_:2},1024),u(q,null,{default:l((()=>[c("出货仓库："),u(V,{class:"text-primary"},{default:l((()=>[c(d(o.stock_name),1)])),_:2},1024)])),_:2},1024),u(q,null,{default:l((()=>[c("未出库数量（仅供参考）："+d(o.remain_out_qty),1)])),_:2},1024)])),_:2},1024)])),_:2},1024)])),footer:l((()=>[u(q,{class:"uni-list-item__foot"},{default:l((()=>[u(V,null,{default:l((()=>[c(d(o.base_unit_qty)+" "+d(o.base_unit_name),1)])),_:2},1024),u(B,{percent:F._calc_percentage(o),"stroke-width":"2","active-color":100==F._calc_percentage(o)?"#4cd964":"#f0ad4e"},null,8,["percent","active-color"])])),_:2},1024)])),_:2},1032,["onClick","clickable","disabled"])))),128))])),_:1})])),_:1})):h("",!0),u(q,{class:"uni-goods-nav-wrapper"},{default:l((()=>[u(M,{options:s.goods_nav.options,"button-group":s.goods_nav.button_group,fill:t.$store.state.goods_nav_fill,onClick:F.goods_nav_click,onButtonClick:F.goods_nav_button_click},null,8,["options","button-group","fill","onClick","onButtonClick"])])),_:1}),s.is_completed?(_(),i(O,{key:1,src:T,class:"yiwancheng-stamp"})):h("",!0)]})),_:1})}]]);export{V as default};
