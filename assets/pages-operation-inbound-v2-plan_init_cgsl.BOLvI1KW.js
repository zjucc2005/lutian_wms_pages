import{s as t,U as e,b as a,n,a as i,h as s,c as l,q as o,e as _,w as r,d,g as c,F as u,i as m,o as p,f,u as h,t as b,L as k,k as g,Q as y,M as F}from"./index-MIvYX1nW.js";import{_ as v}from"./uni-easyinput.BboSH9MB.js";import{r as q}from"./uni-app.es.B8zr0lZI.js";import{_ as w}from"./uni-section.C7O4oyAr.js";import{_ as I,a as j,b as C}from"./uni-td.B3Sq6FHr.js";import{_ as x}from"./uqrcode.D6bSSUJv.js";import{_ as S}from"./uni-tag.DOImtkHb.js";import{_ as N}from"./uni-table.CMkDOYII.js";import{_ as $}from"./uni-list-item.Dk-snU2X.js";import{_ as M}from"./uni-list.zX7C8YBn.js";import{_ as Q}from"./uni-goods-nav.DSaXBg-u.js";import"./k3cloudapi.DzDu3BGl.js";import{p as T}from"./index.DbF5UMRK.js";import{I as U}from"./inbound_task.BSJaUx0d.js";import{a as B}from"./stock_loc.BckAHwoS.js";import"./inv_log.BJcJnepW.js";import{P as G}from"./pur_receive_bill.0AkCLPH4.js";import{s as L}from"./scan_code.bSbj3X8t.js";import{g as O}from"./gen_pdf.D9XpIlx9.js";import{_ as A}from"./yiwancheng_stamp.fi2kVvVZ.js";import{_ as R}from"./_plugin-vue_export-helper.BCo6x5W8.js";import{f as V}from"./date-format.Dm3Q97cL.js";import"./uni-icons.DEYikQDp.js";import"./uni-datetime-picker.D11eskE5.js";import"./uni-badge.DDwx_b0i.js";const Y=R({data:()=>({inbound_task:{},inv_plans:[],is_completed:!1,search_form:{bill_no:""},goods_nav:{options:[{icon:"cart",text:"计划",info:""}],button_group:[{text:"扫码查询单据",backgroundColor:t.state.goods_nav_color.red,color:"#fff"},{text:"新增计划明细",backgroundColor:t.state.goods_nav_color.blue,color:"#fff"}]}}),onShow(){this.$nextTick((()=>{this.handle_search()}))},mounted(){this.inbound_task=new U},methods:{gen_label(t,a){let n={no:t.material_no,name:t.material_name,spec:t.material_spec,supplier_name:t.supplier_name,inbound_time:V(Date.now(),"yyyy-MM-dd")};e({canvasId:a,success:function(t){let e=O({qr:t.tempFilePath,...n});window.open(`#/pages/my/preview_pdf?url=${e}`,"newWindow","width=800,height=600")}})},goods_nav_click(t){0===t.index&&this.$logger.info("this.$data",this.$data)},goods_nav_button_click(t){0===t.index&&this.scan_code(),1===t.index&&this.new_plan()},new_plan(){this.search_form.bill_no?0!=this.inbound_task.inbound_list.length?this.is_completed?a({icon:"none",title:"该计划已完成"}):n({url:"/pages/operation/inbound/v2/plan_new_cgsl",success:t=>{T("success"),t.eventChannel.emit("sendInboundTask",{inbound_task:this.inbound_task})}}):a({icon:"none",title:"未找到单据信息"}):a({icon:"none",title:"单据编号不能为空"})},planned_qty(t){let e=0;for(let a of this.inv_plans)a.FMaterialId==t&&(e+=a.FOpQTY);return e},scan_code(){L().then((t=>{this.search_form.bill_no=t.result,this.handle_search()})).catch((t=>{a({icon:"none",title:t})}))},searchbar_icon_click(t){"prefix"==t&&this.scan_code()},async handle_search(){this.is_completed=!1,this.inbound_task=new U,this.search_form.bill_no?(this.search_form.bill_no=this.search_form.bill_no.trim().toUpperCase(),this.search_form.bill_no.match(/^\d+$/)&&(this.search_form.bill_no="CGSL"+this.search_form.bill_no),await this.load_bill(),await this.load_inv_plans()):this.after_load_inv_plans()},async load_bill(){if(this.search_form.bill_no.startsWith("CGSL")){i({title:"Loading"});let t=await G.query({FBillNo:this.search_form.bill_no});s(),this.after_load_bill(t)}else this.inbound_task=new U,a({icon:"none",title:"未找到单据信息"})},async load_inv_plans(){let e=this.search_form.bill_no;if(e.startsWith("CGSL"))return B.query({FStockId:t.state.cur_stock.FStockId,FBillNo:e,FOpType:"in"},{}).then((t=>{this.inv_plans=t.data,this.after_load_inv_plans(t.data)}));this.inv_plans=[]},after_load_bill(e){if(e.data.length){let a=[];for(let t of e.data){let e=a.find((e=>e.material_id==t.FMaterialId));e?e.base_unit_qty+=t.FActReceiveQty:a.push({material_id:t.FMaterialId,material_no:t["FMaterialId.FNumber"],material_name:t["FMaterialId.FName"],material_spec:t["FMaterialId.FSpecification"],base_unit_qty:t.FActReceiveQty,base_unit_no:t["FUnitId.FNumber"],base_unit_name:t["FUnitId.FName"],supplier_id:t.FSupplierId,supplier_no:t["FSupplierId.FNumber"],supplier_name:t["FSupplierId.FName"],stock_id:t.FStockId,stock_no:t["FStockId.FNumber"],stock_name:t["FStockId.FName"],batch_no:V(Date.now(),"yyyyMMdd"),plt_std_qty:1*t["FMaterialId.F_RGEN_Text_qtr"],box_std_qty:t["FMaterialId.FBoxStandardQty"],planned_qty:0})}this.inbound_task.category="cgsl",this.inbound_task.bill_no=this.search_form.bill_no,this.inbound_task.stock_id=t.state.cur_stock.FStockId,this.inbound_task.stock_name=t.state.cur_stock.FName,this.inbound_task.staff_no=t.state.cur_staff.FNumber,this.inbound_task.inbound_list=a}else this.inbound_task=new U},after_load_inv_plans(t=[]){if(0==this.inbound_task.inbound_list.length)return this.goods_nav.options[0].info="",void(this.is_completed=!1);let e=0,a=0,n=0;for(let s of this.inbound_task.inbound_list)e+=s.base_unit_qty,s.planned_qty=this.planned_qty(s.material_id);for(let s of t)a+=s.FOpQTY,"C"==a.FDocumentStatu&&(n+=s.FOpQTY);let i=Math.floor(a/e*100);this.goods_nav.options[0].info=`${i}%`,this.is_completed=e==n},_calc_percentage:t=>t.planned_qty/t.base_unit_qty*100}},[["render",function(t,e,a,n,i,s){var T;const U=q(l("uni-easyinput"),v),B=m,G=q(l("uni-section"),w),L=q(l("uni-th"),I),O=q(l("uni-tr"),j),R=q(l("uni-td"),C),V=q(l("uqrcode"),x),Y=g,D=q(l("uni-tag"),S),P=q(l("uni-table"),N),W=y,z=q(l("uni-list-item"),$),E=q(l("uni-list"),M),J=q(l("uni-goods-nav"),Q),K=F;return p(),o(u,null,[_(G,{title:"查询单据编号",type:"square","sub-title":[t.$store.state.cur_stock["FUseOrgId.FName"],t.$store.state.cur_stock["FGroup.FName"]||"未分组",t.$store.state.cur_stock.FName].join(" / "),"sub-title-color":"#007aff"},{default:r((()=>[_(B,{class:"searchbar-container"},{default:r((()=>[_(U,{modelValue:i.search_form.bill_no,"onUpdate:modelValue":e[0]||(e[0]=t=>i.search_form.bill_no=t),placeholder:"请输入单据编号","prefix-icon":"scan",onConfirm:s.handle_search,onClear:s.handle_search,onIconClick:s.searchbar_icon_click,"primary-color":"rgb(238, 238, 238)",styles:{color:"#000",backgroundColor:"rgb(238, 238, 238)",borderColor:"rgb(238, 238, 238)"}},null,8,["modelValue","onConfirm","onClear","onIconClick","styles"])])),_:1})])),_:1},8,["sub-title"]),(null==(T=i.inbound_task.inbound_list)?void 0:T.length)?(p(),d(G,{key:0,title:"入库物料明细",type:"square",class:"above-uni-goods-nav"},{default:r((()=>["h5"===t.$store.state.screen_type?(p(),d(P,{key:0,ref:"table",border:"",stripe:""},{default:r((()=>[_(O,null,{default:r((()=>[_(L,{align:"center",width:"60"},{default:r((()=>[f("序号")])),_:1}),_(L,{align:"center",width:"60"},{default:r((()=>[f("QR")])),_:1}),_(L,{align:"center"},{default:r((()=>[f("物料编码")])),_:1}),_(L,{align:"center"},{default:r((()=>[f("物料名称")])),_:1}),_(L,{align:"center"},{default:r((()=>[f("规格型号")])),_:1}),_(L,{align:"center"},{default:r((()=>[f("仓库")])),_:1}),_(L,{align:"center"},{default:r((()=>[f("供应商")])),_:1}),_(L,{align:"center",width:"80"},{default:r((()=>[f("收料单位")])),_:1}),_(L,{align:"center",width:"80"},{default:r((()=>[f("交货数量")])),_:1}),_(L,{align:"center",width:"100"},{default:r((()=>[f("已计划数量")])),_:1}),_(L,{align:"center",width:"100"},{default:r((()=>[f("按托标签数")])),_:1}),_(L,{align:"center",width:"100"},{default:r((()=>[f("按箱标签数")])),_:1}),_(L,{align:"center",width:"100"},{default:r((()=>[f("操作")])),_:1})])),_:1}),(p(!0),o(u,null,h(i.inbound_task.inbound_list,((e,a)=>(p(),d(O,{key:a},{default:r((()=>[_(R,{align:"center"},{default:r((()=>[f(b(a+1),1)])),_:2},1024),_(R,{align:"center"},{default:r((()=>[_(V,{"canvas-id":`qrcode_${a}`,value:e.material_no,size:40},null,8,["canvas-id","value"])])),_:2},1024),_(R,null,{default:r((()=>[f(b(e.material_no),1)])),_:2},1024),_(R,null,{default:r((()=>[f(b(e.material_name),1)])),_:2},1024),_(R,null,{default:r((()=>[f(b(e.material_spec),1)])),_:2},1024),_(R,null,{default:r((()=>[_(Y,{class:k([e.stock_id==t.$store.state.cur_stock.FStockId?"text-primary":"text-error"])},{default:r((()=>[f(b(e.stock_name),1)])),_:2},1032,["class"])])),_:2},1024),_(R,null,{default:r((()=>[f(b(e.supplier_name),1)])),_:2},1024),_(R,{align:"center"},{default:r((()=>[f(b(e.base_unit_name),1)])),_:2},1024),_(R,{align:"center"},{default:r((()=>[f(b(e.base_unit_qty),1)])),_:2},1024),_(R,{align:"center"},{default:r((()=>[f(b(e.planned_qty),1)])),_:2},1024),_(R,{align:"center"},{default:r((()=>[f(b(e.plt_std_qty?4*Math.ceil(e.base_unit_qty/e.plt_std_qty):"NA"),1)])),_:2},1024),_(R,{align:"center"},{default:r((()=>[f(b(e.box_std_qty?Math.ceil(e.base_unit_qty/e.box_std_qty):"NA"),1)])),_:2},1024),_(R,{align:"center"},{default:r((()=>[_(D,{text:"生成标签",type:"primary",onClick:t=>s.gen_label(e,`qrcode_${a}`)},null,8,["onClick"])])),_:2},1024)])),_:2},1024)))),128))])),_:1},512)):(p(),d(E,{key:1},{default:r((()=>[(p(!0),o(u,null,h(i.inbound_task.inbound_list,((e,a)=>(p(),d(z,{key:a,onClick:t=>s.gen_label(e,`qrcode_${a}`),clickable:"","show-arrow":""},{header:r((()=>[_(B,{class:"uni-list-item__head"},{default:r((()=>[_(V,{"canvas-id":`qrcode_${a}`,value:e.material_no,size:40},null,8,["canvas-id","value"])])),_:2},1024)])),body:r((()=>[_(B,{class:"uni-list-item__body"},{default:r((()=>[_(Y,{class:"title"},{default:r((()=>[f(b(e.material_no),1)])),_:2},1024),_(B,{class:"note"},{default:r((()=>[_(B,null,{default:r((()=>[f("名称："+b(e.material_name),1)])),_:2},1024),_(B,null,{default:r((()=>[f("规格："+b(e.material_spec),1)])),_:2},1024),_(B,null,{default:r((()=>[f("仓库："),_(Y,{class:k([e.stock_id==t.$store.state.cur_stock.FStockId?"text-primary":"text-error"])},{default:r((()=>[f(b(e.stock_name),1)])),_:2},1032,["class"])])),_:2},1024),_(B,null,{default:r((()=>[f("供应商："+b(e.supplier_name),1)])),_:2},1024)])),_:2},1024)])),_:2},1024)])),footer:r((()=>[_(B,{class:"uni-list-item__foot"},{default:r((()=>[_(Y,null,{default:r((()=>[f(b(e.base_unit_qty)+" "+b(e.base_unit_name),1)])),_:2},1024),_(W,{percent:s._calc_percentage(e),"stroke-width":"2","active-color":100==s._calc_percentage(e)?"#4cd964":"#f0ad4e"},null,8,["percent","active-color"])])),_:2},1024)])),_:2},1032,["onClick"])))),128))])),_:1}))])),_:1})):c("",!0),_(B,{class:"uni-goods-nav-wrapper"},{default:r((()=>[_(J,{options:i.goods_nav.options,"button-group":i.goods_nav.button_group,fill:t.$store.state.goods_nav_fill,onClick:s.goods_nav_click,onButtonClick:s.goods_nav_button_click},null,8,["options","button-group","fill","onClick","onButtonClick"])])),_:1}),i.is_completed?(p(),d(K,{key:1,src:A,class:"cover-image"})):c("",!0)],64)}],["__scopeId","data-v-78510a8a"]]);export{Y as default};
