import{s as t,R as e,b as i,c as l,q as s,e as o,w as n,F as a,i as d,o as _,u as r,d as c,C as u,L as h,f as p,t as g,g as f,X as m,Y as y}from"./index-MIvYX1nW.js";import{_ as x}from"./uni-list-item.Dk-snU2X.js";import{r as b}from"./uni-app.es.B8zr0lZI.js";import{_ as w}from"./uni-list.zX7C8YBn.js";import{_ as k}from"./uni-icons.DEYikQDp.js";import{_ as v,a as q}from"./uni-grid.DLufXv4F.js";import{_ as j,a as C}from"./uni-collapse.DtdZAJ17.js";import{_ as F}from"./uni-section.C7O4oyAr.js";import{_ as M}from"./uni-goods-nav.DSaXBg-u.js";import{_ as $}from"./_plugin-vue_export-helper.BCo6x5W8.js";import"./uni-badge.DDwx_b0i.js";const P=$({onLoad(t){this.getOpenerEventChannel().on("initStockLocs",(t=>{this.stock_locs=t.stock_locs||[],this.pallet_qty=t.pallet_qty||0,this.get_grid_shelves(),this.get_grid_width()}))},data:()=>({stock_locs:[],pallet_qty:0,grid_group_width:0,grid_width:0,grid_shelves:[],allocate_info:[],goods_nav:{options:[{icon:"map-filled",text:"已分配",info:0}],button_group:[{text:"返回",backgroundColor:t.state.goods_nav_color.grey,color:"#fff"},{text:"预览",backgroundColor:t.state.goods_nav_color.yellow,color:"#fff"}]}}),computed:{column(){let e=Math.floor(t.state.system_info.windowWidth/48);return e<10&&(e=10),e}},methods:{goods_nav_click(t){0===t.index&&this.$logger.info("this.$data",this.$data)},goods_nav_button_click(t){0===t.index&&e(),1===t.index&&this.preview()},preview(){if(this.sum_plt_alloc()<this.pallet_qty)return void i({icon:"none",title:this.pallet_qty-this.sum_plt_alloc()+"个托盘未分配"});this.getOpenerEventChannel().emit("allocateInfo",{allocate_info:this.allocate_info}),e()},get_grid_shelves(){let t=[];for(let e of this.stock_locs){let i=e.FNumber,l=e.FGroup,s=i;i.startsWith(l)&&(s=i.substring(l.length,i.length),s.startsWith("-")&&(s=s.substring(1,s.length)));let o=e.FPosX,n=e.FPosY,a="",d="default",_=0,r=e.FPalletSpace;"B"==e.FForbidStatus?(a="forbidden",d="error"):0==r?d="warn":-1==r?d="default":e.idle||(d="success");let c=!1,u=0,h=this.allocate_info.find((t=>t.no==i));h&&(c=!0,u=h.v);let p=t.find((t=>t.name===e.FGroup));p?(p.bound.x=Math.max(p.bound.x,e.FPosX),p.bound.y=Math.max(p.bound.y,e.FPosY),p.grids.push({no:i,shelf:l,name:s,x:o,y:n,status:a,style:d,qty:_,plt_space:r,checked:c,checked_qty:u})):t.push({name:l,disabled:!0,bound:{x:o,y:n},grids:[{no:i,shelf:l,name:s,x:o,y:n,status:a,style:d,qty:_,plt_space:r,checked:c,checked_qty:u}]})}t.forEach((t=>{for(let e=1;e<=Math.ceil(t.bound.x/this.column)*this.column;e+=1)for(let i=1;i<=t.bound.y;i+=1){let{page:l,index:s}=this.get_grid_page_and_index(t.bound,{x:e,y:i}),o=this.get_grid_name({x:e,y:i}),n=[t.name,o].join("-"),a=t.grids.find((t=>t.x==e&&t.y==i));a?(a.page=l,a.index=s,a.no=a.no||n):(a={x:e,y:i,page:l,index:s,name:o,no:n,qty:0,status:"",style:"none"},t.grids.push(a))}})),t.sort(((t,e)=>t.name>=e.name?1:-1)),this.grid_shelves=t},get_grid_page_and_index(t={},e={}){return{page:Math.ceil(e.x/this.column),index:(t.y-e.y)*Math.ceil(t.x/this.column)*this.column+e.x}},get_grid_name:(t={})=>100*t.y+t.x,get_grid_width(){let e=t.state.system_info.windowWidth;this.grid_group_width=e,this.grid_width=(e-1)/this.column},filter_swiper_grids:(t,e)=>t.grids.filter((t=>t.page==e)).sort(((t,e)=>t.index-e.index)),get_swiper_pages(t){return Math.ceil(t.bound.x/this.column)},get_swiper_height(e){let i=t.state.system_info.windowWidth;return Math.ceil(i/this.column*(e.bound.y+.7))},grid_click(t,e){let l=e.grids.find((e=>e.index===t.detail.index));if(l&&"none"!=l.style&&"forbidden"!=l.status&&0!=l.plt_space){if(l.checked){let t=this.pallet_qty-this.sum_plt_alloc();if(l.plt_alloc===l.plt_space||0===t){l.checked=!1,l.plt_alloc=0;let t=this.allocate_info.findIndex((t=>t.no==l.no));t>=0&&this.allocate_info.splice(t,1)}else if(l.plt_alloc<l.plt_space){l.plt_alloc+=1,this.allocate_info.find((t=>t.no==l.no)).plt_qty+=1}}else{let t=this.pallet_qty-this.sum_plt_alloc();if(0===t)return void i({icon:"none",title:"分配库位已足够"});l.checked=!0,-1==l.plt_space?l.plt_alloc=t:l.plt_alloc=1,this.allocate_info.push({no:l.no,plt_qty:l.plt_alloc})}this.goods_nav.options[0].info=this.sum_plt_alloc()}},sum_plt_alloc(){let t=0;return this.allocate_info.forEach((e=>{t+=e.plt_qty})),t}}},[["render",function(t,e,i,$,P,W){const B=b(l("uni-list-item"),x),E=b(l("uni-list"),w),L=d,S=b(l("uni-icons"),k),I=b(l("uni-grid-item"),v),X=b(l("uni-grid"),q),Y=m,z=y,G=b(l("uni-collapse-item"),j),O=b(l("uni-collapse"),C),R=b(l("uni-section"),F),T=b(l("uni-goods-nav"),M);return _(),s(a,null,[o(R,{title:"分配托盘库位",type:"square","sub-title":"点击选择可以分配的托盘库位","sub-title-color":"#007aff",class:"above-uni-goods-nav"},{default:n((()=>[o(E,null,{default:n((()=>[o(B,{"show-extra-icon":!0,"extra-icon":{type:"right",color:"#007bff"},title:"已分配托盘数",rightText:`${W.sum_plt_alloc()} / ${P.pallet_qty}`},null,8,["rightText"])])),_:1}),o(O,null,{default:n((()=>[(_(!0),s(a,null,r(P.grid_shelves,(t=>(_(),c(G,{title:t.name,open:"","title-border":"show"},{default:n((()=>[o(L,{class:"content"},{default:n((()=>[o(z,{"indicator-dots":!0,style:u({height:`${W.get_swiper_height(t)}px`}),class:"shelf_swiper"},{default:n((()=>[(_(!0),s(a,null,r(W.get_swiper_pages(t),(e=>(_(),c(Y,{key:e},{default:n((()=>[o(X,{column:W.column,"show-border":!1,onChange:e=>W.grid_click(e,t),style:u({width:P.grid_group_width+"px"})},{default:n((()=>[(_(!0),s(a,null,r(W.filter_swiper_grids(t,e),(t=>(_(),c(I,{key:t.index,index:t.index,style:u({width:P.grid_width+"px",height:P.grid_width+"px"})},{default:n((()=>[o(L,{class:h(["grid-item-box",t.style])},{default:n((()=>[o(L,{class:"name"},{default:n((()=>[p(g(t.name),1)])),_:2},1024),t.checked?(_(),c(L,{key:0},{default:n((()=>[o(S,{type:"checkmarkempty",size:.5*P.grid_width},null,8,["size"]),o(L,{class:"pallet_qty"},{default:n((()=>[p(g(t.plt_alloc),1)])),_:2},1024)])),_:2},1024)):f("",!0)])),_:2},1032,["class"])])),_:2},1032,["index","style"])))),128))])),_:2},1032,["column","onChange","style"])])),_:2},1024)))),128))])),_:2},1032,["style"])])),_:2},1024)])),_:2},1032,["title"])))),256))])),_:1})])),_:1}),o(L,{class:"uni-goods-nav-wrapper"},{default:n((()=>[o(T,{options:P.goods_nav.options,"button-group":P.goods_nav.button_group,fill:t.$store.state.goods_nav_fill,onClick:W.goods_nav_click,onButtonClick:W.goods_nav_button_click},null,8,["options","button-group","fill","onClick","onButtonClick"])])),_:1})],64)}],["__scopeId","data-v-2dc3f94a"]]);export{P as default};
