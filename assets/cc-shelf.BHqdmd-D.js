import{x as e,s as t,b as l,p as s,a as i,h as o,c as a,o as r,q as d,d as n,w as c,e as _,f as u,t as f,g as y,F as m,u as h,S as p,i as g,l as b,T as k,C as w,L as x,X as F,Y as q,k as v}from"./index-MIvYX1nW.js";import{_ as I}from"./uni-list-item.Dk-snU2X.js";import{r as N}from"./uni-app.es.B8zr0lZI.js";import{_ as j}from"./uni-icons.DEYikQDp.js";import{_ as M}from"./uni-list.zX7C8YBn.js";import{_ as S,a as $}from"./uni-grid.DLufXv4F.js";import{_ as C,a as z}from"./uni-collapse.DtdZAJ17.js";import{_ as L}from"./uni-section.C7O4oyAr.js";import{_ as B}from"./uni-drawer.COomJS_R.js";import{l as E}from"./index.DbF5UMRK.js";import"./k3cloudapi.DzDu3BGl.js";import{S as P}from"./stock_loc.BckAHwoS.js";import"./inv_log.BJcJnepW.js";import{_ as W}from"./_plugin-vue_export-helper.BCo6x5W8.js";const G=W({name:"cc-shelf",props:{stock_locs:{type:Array,default:[]},invs:{type:Array,default:[]},cols:{type:Number,default:0},onlyInv:{type:Boolean,default:!1},open:{type:Boolean,default:!1},forbidable:{type:Boolean,default:!1}},data:()=>({grid_group_width:0,drawer_loc_no:"",accordion:"y"===e("shelf_accordion")}),mounted(){},computed:{column(){if(this.cols)return this.cols;let e=Math.floor(t.state.system_info.windowWidth/48);return e<10&&(e=10),e},grid_width(){let e=t.state.system_info.windowWidth;return this.grid_group_width=e,(e-1)/this.column},sum_qty(){let e=0;for(let t of this.invs)e+=t.FQty;return e},loc_qty(){let e={total:0,used:0,idle:0,disabled:0};return this.grid_shelves.forEach((t=>{t.sp||(e.total+=t.loc_qty.total,e.used+=t.loc_qty.used,e.idle+=t.loc_qty.idle,e.disabled+=t.loc_qty.disabled)})),e},grid_shelves(){let e=[];for(let t of this.stock_locs){let l=t.FNumber,s=t.FGroup,i=l;l.startsWith(s)&&(i=l.substring(s.length,l.length),i.startsWith("-")&&(i=i.substring(1,i.length)));let o=t.FPosX,a=t.FPosY,r="",d="default",n=0;"B"==t.FForbidStatus&&(r="forbidden",d="error");let c=e.find((e=>e.name===t.FGroup));c?(c.bound.x=Math.max(c.bound.x,t.FPosX),c.bound.y=Math.max(c.bound.y,t.FPosY),c.grids.push({no:l,shelf:s,name:i,x:o,y:a,status:r,style:d,qty:n})):e.push({name:s,disabled:!0,bound:{x:o,y:a},loc_qty:{total:0,used:0,idle:0,disabled:0},grids:[{no:l,shelf:s,name:i,x:o,y:a,status:r,style:d,qty:n}]})}return this.invs.forEach((t=>{let l=e.find((e=>e.name==t["FStockLocId.FGroup"]));if(l){l.disabled=!1;let e=l.grids.find((e=>e.no==t["FStockLocId.FNumber"]));""==e.status&&(e.style="success"),e.qty+=t.FQty}})),e.forEach((e=>{e.grids.forEach((t=>{e.loc_qty.total+=1,"error"==t.style?e.loc_qty.disabled+=1:"success"==t.style?e.loc_qty.used+=1:e.loc_qty.idle+=1}))})),e.forEach((e=>{for(let t=1;t<=Math.ceil(e.bound.x/this.column)*this.column;t+=1)for(let l=1;l<=e.bound.y;l+=1){let{page:s,index:i}=this.get_grid_page_and_index(e.bound,{x:t,y:l}),o=this.get_grid_name({x:t,y:l}),a=[e.name,o].join("-"),r=e.grids.find((e=>e.x==t&&e.y==l));r?(r.page=s,r.index=i,r.no=r.no||a):(r={x:t,y:l,page:s,index:i,name:o,no:a,qty:0,status:"",style:"none"},e.grids.push(r))}})),e.sort(((e,t)=>e.name>=t.name?1:-1)),this.onlyInv?e.filter((e=>!e.disabled)):e}},methods:{get_grid_page_and_index(e={},t={}){return{page:Math.ceil(t.x/this.column),index:(e.y-t.y)*Math.ceil(e.x/this.column)*this.column+t.x}},get_grid_name:(e={})=>100*e.y+e.x,filter_swiper_grids:(e,t)=>e.grids.filter((e=>e.page==t)).sort(((e,t)=>e.index-t.index)),get_swiper_pages(e){return Math.ceil(e.bound.x/this.column)},get_swiper_height(e){return Math.ceil(this.grid_width*(e.bound.y+.6))},grid_click(e,l){let s=l.grids.find((t=>t.index===e.detail.index));s&&"none"!=s.style&&(this.forbidable||"forbidden"!=s.status)&&(this.drawer_stock_loc=t.state.stock_locs.find((e=>e.FNumber==s.no)),this.$refs.inv_drawer.open())},drawer_close(){this.$refs.inv_drawer.close()},inv_menu(e){e.FMaterialId?s({itemList:["库存明细","库存调整","物料详情"],success:t=>{0===t.tapIndex&&E(`/pages/operation/manage/inv_search?t=${e["FMaterialId.FNumber"]}`),1===t.tapIndex&&E(`/pages/operation/move/v2/plan_new?material_no=${e["FMaterialId.FNumber"]}`),2===t.tapIndex&&E(`/pages/operation/material/show?id=${e.FMaterialId}`)}}):l({icon:"none",title:"物料ID不能为空"})},stock_loc_forbid(e){i({title:"Loading"}),P.forbid([e]).then((s=>{P.query({FStockId:t.state.cur_stock.FStockId}).then((s=>{o(),l({icon:"none",title:`${e} 禁用`}),this.$refs.inv_drawer.close(),t.commit("set_stock_locs",s.data)}))}))},stock_loc_enable(e){i({title:"Loading"}),P.enable([e]).then((s=>{P.query({FStockId:t.state.cur_stock.FStockId}).then((s=>{o(),l({icon:"none",title:`${e} 解除禁用`}),this.$refs.inv_drawer.close(),t.commit("set_stock_locs",s.data)}))}))}}},[["render",function(e,t,l,s,i,o){const E=N(a("uni-list-item"),I),P=g,W=N(a("uni-icons"),j),G=N(a("uni-list"),M),Q=N(a("uni-grid-item"),S),T=N(a("uni-grid"),$),A=F,R=q,X=N(a("uni-collapse-item"),C),Y=N(a("uni-collapse"),z),D=b,J=v,K=N(a("uni-section"),L),U=k,H=N(a("uni-drawer"),B);return r(),d(m,null,[l.invs.length?(r(),n(G,{key:0},{default:c((()=>[_(E,{"show-extra-icon":!0,"extra-icon":{type:"info",color:"#007bff",size:23},title:"库存总数",rightText:`${o.sum_qty}`},null,8,["rightText"]),l.onlyInv?y("",!0):(r(),n(E,{key:0,"show-extra-icon":!0,"extra-icon":{type:"info",color:"#007bff",size:23}},{body:c((()=>[_(P,{class:"uni-list-item__body"},{default:c((()=>[_(P,{class:"title"},{default:c((()=>[u("库位总数（货架）")])),_:1})])),_:1}),_(P,{class:"uni-list-item__foot"},{default:c((()=>[_(P,null,{default:c((()=>[u(f(o.loc_qty.total)+" ( ",1),_(W,{type:"smallcircle-filled",size:"18",color:"#67c23a"}),u(" "+f(o.loc_qty.used)+" ",1),_(W,{type:"smallcircle-filled",size:"18",color:"#f56c6c"}),u(" "+f(o.loc_qty.disabled)+" ",1),_(W,{type:"smallcircle-filled",size:"18",color:"#c0c0c0"}),u(" "+f(o.loc_qty.idle)+" ) ",1)])),_:1})])),_:1})])),_:1}))])),_:1})):y("",!0),_(Y,{accordion:i.accordion},{default:c((()=>[(r(!0),d(m,null,h(o.grid_shelves,((e,t)=>(r(),n(X,{key:t,title:e.name,open:i.accordion?0===t:l.open,"title-border":"show"},{title:c((()=>[_(P,{class:"collapse_header",style:{}},{default:c((()=>[_(P,{class:"shelf_name",style:{padding:"15px"}},{default:c((()=>[u(f(e.name),1)])),_:2},1024),!l.onlyInv&&l.invs.length?(r(),n(P,{key:0,class:"shelf_tips"},{default:c((()=>[u(" 库位数 "+f(e.loc_qty.total)+" （ ",1),_(W,{type:"smallcircle-filled",size:"18",color:"#67c23a"}),u(" "+f(e.loc_qty.used)+" ",1),_(W,{type:"smallcircle-filled",size:"18",color:"#f56c6c"}),u(" "+f(e.loc_qty.disabled)+" ",1),_(W,{type:"smallcircle-filled",size:"18",color:"#c0c0c0"}),u(" "+f(e.loc_qty.idle)+" ） ",1)])),_:2},1024)):y("",!0)])),_:2},1024)])),default:c((()=>[_(P,{class:"content"},{default:c((()=>[_(R,{"indicator-dots":!0,style:w({height:`${o.get_swiper_height(e)}px`}),class:"shelf_swiper"},{default:c((()=>[(r(!0),d(m,null,h(o.get_swiper_pages(e),(t=>(r(),n(A,{key:t},{default:c((()=>[_(T,{column:o.column,"show-border":!1,onChange:t=>o.grid_click(t,e),style:w({width:i.grid_group_width+"px"})},{default:c((()=>[(r(!0),d(m,null,h(o.filter_swiper_grids(e,t),(e=>(r(),n(Q,{key:e.index,index:e.index,style:w({width:o.grid_width+"px",height:o.grid_width+"px"})},{default:c((()=>[_(P,{class:x(["grid-item-box",e.style])},{default:c((()=>[_(P,{class:"name"},{default:c((()=>[u(f(e.name),1)])),_:2},1024),e.qty?(r(),n(P,{key:0,class:"qty"},{default:c((()=>[u(f(e.qty>99999?"99999+":e.qty),1)])),_:2},1024)):y("",!0)])),_:2},1032,["class"])])),_:2},1032,["index","style"])))),128))])),_:2},1032,["column","onChange","style"])])),_:2},1024)))),128))])),_:2},1032,["style"])])),_:2},1024)])),_:2},1032,["title","open"])))),128))])),_:1},8,["accordion"]),_(H,{ref:"inv_drawer",mode:"left",width:e.$store.state.drawer_width},{default:c((()=>[_(U,{"scroll-y":"",style:{height:"100%"},onTouchmove:t[2]||(t[2]=p((()=>{}),["stop"]))},{default:c((()=>[_(K,{title:`库位：${e.drawer_stock_loc.FNumber}`,"sub-title":e.drawer_stock_loc.FRemark?`备注：${e.drawer_stock_loc.FRemark}`:"",type:"square"},{right:c((()=>[_(P,{class:"uni-section__right"},{default:c((()=>[_(W,{type:"closeempty",size:"24",color:"#333",onClick:o.drawer_close},null,8,["onClick"])])),_:1})])),default:c((()=>[l.forbidable?(r(),d(m,{key:0},["A"==e.drawer_stock_loc.FForbidStatus?(r(),n(D,{key:0,type:"warn",style:{"border-radius":"0"},onClick:t[0]||(t[0]=t=>o.stock_loc_forbid(e.drawer_stock_loc.FNumber))},{default:c((()=>[u(" 库位报警 ")])),_:1})):y("",!0),"B"==e.drawer_stock_loc.FForbidStatus?(r(),n(D,{key:1,type:"primary",style:{"border-radius":"0"},onClick:t[1]||(t[1]=t=>o.stock_loc_enable(e.drawer_stock_loc.FNumber))},{default:c((()=>[u(" 解除库位报警 ")])),_:1})):y("",!0)],64)):y("",!0),_(G,null,{default:c((()=>[(r(!0),d(m,null,h(l.invs.filter((t=>t["FStockLocId.FNumber"]==e.drawer_stock_loc.FNumber)),((e,t)=>(r(),n(E,{key:t,onClick:t=>o.inv_menu(e),clickable:""},{body:c((()=>[_(P,{class:"uni-list-item__body"},{default:c((()=>[_(J,{class:"title"},{default:c((()=>[u(f(e["FMaterialId.FNumber"]),1)])),_:2},1024),_(P,{class:"note"},{default:c((()=>[_(P,null,{default:c((()=>[u("名称："+f(e["FMaterialId.FName"]),1)])),_:2},1024),_(P,null,{default:c((()=>[u("规格："+f(e["FMaterialId.FSpecification"]),1)])),_:2},1024),_(P,null,{default:c((()=>[u("批次："+f(e.FBatchNo),1)])),_:2},1024),_(P,null,{default:c((()=>[u("供应商："+f(e["FSupplierId.FName"]),1)])),_:2},1024)])),_:2},1024)])),_:2},1024)])),footer:c((()=>[_(P,{class:"uni-list-item__foot"},{default:c((()=>[_(P,null,{default:c((()=>[u(f(e.FQty)+" "+f(e["FStockUnitId.FName"]),1)])),_:2},1024)])),_:2},1024)])),_:2},1032,["onClick"])))),128))])),_:1})])),_:1},8,["title","sub-title"])])),_:1})])),_:1},8,["width"])],64)}],["__scopeId","data-v-f7516335"]]);export{G as _};
