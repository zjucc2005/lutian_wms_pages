import{s as t,b as s,n as a,a as o,h as e,c as n,q as i,e as l,w as _,d as r,g as c,F as d,i as u,o as m,u as h,f as p,t as b,k as f,Q as k,M as g}from"./index-DGWOUQdM.js";import{_ as v}from"./uni-notice-bar.BcgQPdeL.js";import{r as y}from"./uni-app.es.DKZsoyMd.js";import{_ as I}from"./uni-easyinput.l7FUzy_X.js";import{_ as j}from"./uni-section.Dvy4SRsN.js";import{_ as w}from"./uni-list-item.BnynrAPo.js";import{_ as C}from"./uni-list.Kn4QrsAX.js";import{_ as S}from"./uni-goods-nav.BwI3ErB8.js";import{K as x}from"./k3cloudapi.CbDqg_He.js";import{p as F}from"./index.JIux-90-.js";import{I as D}from"./inbound_task.DqmN0Qhk.js";import{a as B}from"./stock_loc.C36uFwb2.js";import"./inv_log.OihDyY2r.js";import{f as M}from"./date-format.Dm3Q97cL.js";import{s as N}from"./scan_code.CS8963f7.js";import{_ as q}from"./yiwancheng_stamp.fi2kVvVZ.js";import{_ as T}from"./_plugin-vue_export-helper.BCo6x5W8.js";import"./uni-icons.LDhtL0t0.js";import"./uni-badge._gn3hy42.js";const V=T({data:()=>({inbound_task:{},inv_plans:[],is_completed:!1,search_form:{bill_no:""},goods_nav:{options:[{icon:"cart",text:"计划",info:""}],button_group:[{text:"扫码查询单据",backgroundColor:t.state.goods_nav_color.red,color:"#fff"},{text:"新增计划明细",backgroundColor:t.state.goods_nav_color.blue,color:"#fff"}]}}),onShow(){this.handle_search()},mounted(){this.inbound_task=new D},methods:{goods_nav_click(t){0===t.index&&this.$logger.info("this.$data",this.$data)},goods_nav_button_click(t){0===t.index&&this.scan_code(),1===t.index&&this.new_plan()},new_plan(t){this.search_form.bill_no?0!=this.inbound_task.inbound_list.length?this.is_completed?s({icon:"none",title:"该计划已完成"}):a({url:"/pages/operation/inbound/v2/plan_new_pallet",success:s=>{F("success"),s.eventChannel.emit("sendInboundTask",{inbound_task:this.inbound_task,material_no:t})}}):s({icon:"none",title:"未找到单据信息"}):s({icon:"none",title:"单据编号不能为空"})},scan_code(){N().then((t=>{this.search_form.bill_no=t.result,this.handle_search()})).catch((t=>{s({icon:"none",title:t})}))},searchbar_icon_click(t){"prefix"==t&&this.scan_code()},async handle_search(){this.is_completed=!1,this.inbound_task=new D,this.search_form.bill_no?(this.search_form.bill_no=this.search_form.bill_no.trim().toUpperCase(),this.search_form.bill_no.match(/^\d+$/)&&(this.search_form.bill_no="ZJDB"+this.search_form.bill_no),await this.load_bill(),await this.load_inv_plans()):this._calc_progress()},async load_bill(){let t=this.search_form.bill_no;if(t.startsWith("ZJDB"))return o({title:"Loading"}),x.view("STK_TransferDirect",{Number:t}).then((t=>{e(),this._handle_zjdbd_data(t)})).catch((t=>{s({icon:"none",title:t})}));this.inbound_task=new D,s({icon:"none",title:"未找到单据信息"})},async load_inv_plans(){let s=this.search_form.bill_no;if(s.startsWith("ZJDB"))return B.query({FStockId:t.state.cur_stock.FStockId,FBillNo:s,FOpType:"in"},{}).then((t=>{this.inv_plans=t.data,this._calc_progress(t.data)}));this.inv_plans=[]},_calc_percentage(t){let s=0;return this.inv_plans.forEach((a=>{a.FMaterialId==t.material_id&&(s+=a.FOpQTY)})),s/t.base_unit_qty*100},_calc_progress(t=[]){if(0==this.inbound_task.inbound_list.length)return this.goods_nav.options[0].info="",void(this.is_completed=!1);let s=this.inbound_task.inbound_list.map((t=>t.base_unit_qty)).concat([0]).reduce(((t,s)=>t+s)),a=0,o=0;t.forEach((t=>{a+=t.FOpQTY,"C"==t.FDocumentStatu&&(o+=t.FOpQTY)}));let e=Math.floor(a/s*100);this.goods_nav.options[0].info=`${e}%`,this.is_completed=s==o},_handle_zjdbd_data(a){var o;if(a.data.Result.ResponseStatus.IsSuccess){const s=a.data.Result.Result;let o=[];s.TransferDirectEntry.forEach((t=>{var s,a,e,n,i;let l=o.find((s=>s.material_id==t.DestMaterialId_Id));l?l.base_unit_qty+=t.BaseQty:o.push({material_id:t.DestMaterialId_Id,material_no:t.MaterialId.Number,material_name:null==(s=t.MaterialId.Name[0])?void 0:s.Value,material_spec:null==(a=t.MaterialId.Specification[0])?void 0:a.Value,base_unit_qty:t.BaseQty,base_unit_name:null==(e=t.BaseUnitId.Name[0])?void 0:e.Value,base_unit_no:t.BaseUnitId.Number,src_stock_id:t.SrcStockId.Id,src_stock_name:null==(n=t.SrcStockId.Name[0])?void 0:n.Value,dest_stock_id:t.DestStockId.Id,dest_stock_name:null==(i=t.DestStockId.Name[0])?void 0:i.Value,batch_no:M(t.BusinessDate||Date.now(),"yyyyMMdd"),planned_qty:0})})),this.inbound_task.bill_no=s.BillNo,this.inbound_task.stock_id=t.state.cur_stock.FStockId,this.inbound_task.staff_no=t.state.cur_staff.FNumber,this.inbound_task.inbound_list=o}else this.inbound_task=new D,s({icon:"none",title:null==(o=a.data.Result.ResponseStatus.Errors[0])?void 0:o.Message})}}},[["render",function(t,s,a,o,e,x){var F;const D=y(n("uni-notice-bar"),v),B=y(n("uni-easyinput"),I),M=u,N=y(n("uni-section"),j),T=f,V=k,$=y(n("uni-list-item"),w),Q=y(n("uni-list"),C),R=y(n("uni-goods-nav"),S),E=g;return m(),i(d,null,[l(D,{single:"",scrollable:"",text:"扫码获取单据中物料清单后，下一步新增计划明细"}),l(N,{title:"查询单据编号","sub-title":"对直接调拨单扫码获取单据编号",type:"square"},{default:_((()=>[l(M,{class:"searchbar-container"},{default:_((()=>[l(B,{modelValue:e.search_form.bill_no,"onUpdate:modelValue":s[0]||(s[0]=t=>e.search_form.bill_no=t),placeholder:"请输入单据编号",focus:"","prefix-icon":"scan",onConfirm:x.handle_search,onClear:x.handle_search,onIconClick:x.searchbar_icon_click,"primary-color":"rgb(238, 238, 238)",styles:{color:"#000",backgroundColor:"rgb(238, 238, 238)",borderColor:"rgb(238, 238, 238)"}},null,8,["modelValue","onConfirm","onClear","onIconClick","styles"])])),_:1})])),_:1}),(null==(F=e.inbound_task.inbound_list)?void 0:F.length)?(m(),r(N,{key:0,title:"入库物料信息",type:"square",class:"above-uni-goods-nav"},{default:_((()=>[l(Q,null,{default:_((()=>[(m(!0),i(d,null,h(e.inbound_task.inbound_list,((s,a)=>(m(),r($,{key:a,onClick:t=>x.new_plan(s.material_no),clickable:s.dest_stock_id==t.$store.state.cur_stock.FStockId,disabled:s.dest_stock_id!=t.$store.state.cur_stock.FStockId,"show-arrow":""},{body:_((()=>[l(M,{class:"uni-list-item__body"},{default:_((()=>[l(T,{class:"title"},{default:_((()=>[p(b(s.material_no),1)])),_:2},1024),l(M,{class:"note"},{default:_((()=>[l(M,null,{default:_((()=>[p("名称："+b(s.material_name),1)])),_:2},1024),l(M,null,{default:_((()=>[p("规格："+b(s.material_spec),1)])),_:2},1024),l(M,null,{default:_((()=>[p("调入仓库："),l(T,{class:"text-primary"},{default:_((()=>[p(b(s.dest_stock_name),1)])),_:2},1024)])),_:2},1024),l(M,null,{default:_((()=>[p("批次："+b(s.batch_no),1)])),_:2},1024)])),_:2},1024)])),_:2},1024)])),footer:_((()=>[l(M,{class:"uni-list-item__foot"},{default:_((()=>[l(T,null,{default:_((()=>[p(b(s.base_unit_qty)+" "+b(s.base_unit_name),1)])),_:2},1024),l(V,{percent:x._calc_percentage(s),"stroke-width":"2","active-color":100==x._calc_percentage(s)?"#4cd964":"#f0ad4e"},null,8,["percent","active-color"])])),_:2},1024)])),_:2},1032,["onClick","clickable","disabled"])))),128))])),_:1})])),_:1})):c("",!0),l(M,{class:"uni-goods-nav-wrapper"},{default:_((()=>[l(R,{options:e.goods_nav.options,"button-group":e.goods_nav.button_group,fill:t.$store.state.goods_nav_fill,onClick:x.goods_nav_click,onButtonClick:x.goods_nav_button_click},null,8,["options","button-group","fill","onClick","onButtonClick"])])),_:1}),e.is_completed?(m(),r(E,{key:1,src:q,class:"cover-image"})):c("",!0)],64)}],["__scopeId","data-v-be15799e"]]);export{V as default};
