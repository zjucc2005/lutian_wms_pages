import{s as t,b as a,n as e,a as l,h as s,c as i,q as o,e as n,w as r,d as _,g as c,F as d,i as u,o as m,f,t as h,u as p,k as F,K as y,L as k,M as g}from"./index-DsK9pIyj.js";import{_ as b}from"./uni-easyinput.BfazFYzq.js";import{r as I}from"./uni-app.es.CSK8ITuj.js";import{_ as v}from"./uni-section.BpQrEx4g.js";import{_ as C,a as N,b as S}from"./uni-td.DKOxbdh1.js";import{_ as M}from"./uni-tag.DapJ5B6u.js";import{_ as B}from"./uni-table.BXeOwSLO.js";import{_ as j}from"./uni-list-item.BkmqxiQh.js";import{_ as w}from"./uni-list.dJf-6p1_.js";import{_ as q}from"./uni-card.CdeHcnQF.js";import{_ as x}from"./uni-goods-nav.BN-nj5na.js";import{p as A}from"./index.uHoH2c2-.js";import{s as P}from"./scan_code.CGa79-3n.js";import"./k3cloudapi.PCDjx1SF.js";import{a as $}from"./stock_loc.Bj3C3Byx.js";import"./inv_log.D0BShjlW.js";import{P as U}from"./prd_issue_mtr_notice.CNj_PT4N.js";import{S as D,P as Q}from"./sp_pick_mtrl.Da0mJRUw.js";import{_ as E}from"./yiwancheng_stamp.fi2kVvVZ.js";import{_ as Z}from"./_plugin-vue_export-helper.BCo6x5W8.js";import{f as L}from"./date-format.Dm3Q97cL.js";import"./uni-icons.DRoE6XYp.js";import"./uni-datetime-picker.Bsu03if5.js";import"./uni-badge.CO78OwkC.js";const R=Z({data:()=>({scfl:[],scfl_todo:[],inv_plans:[],inv_plans_map:{},multiuser:!1,search_form:{bill_no:""},goods_nav:{options:[{icon:"close",text:"清空",info:""}],button_group:[{text:"扫描单据",backgroundColor:t.state.goods_nav_color.red,color:"#fff"}]}}),onShow(){this.search_form.bill_no?this.load_inv_plans():this.load_scfl_todo()},mounted(){},computed:{is_completed(){let t=!0;if(this.scfl.length){for(let a of this.scfl)if(!this.inv_plans_map[a.material_id]||this.inv_plans_map[a.material_id]<a.must_qty){t=!1;break}}else t=!1;return t}},methods:{goods_nav_click(t){0===t.index&&(this.$logger.info("this.$data",this.$data),this.search_form.bill_no="",this.handle_search())},goods_nav_button_click(t){0===t.index&&this.scan_code()},searchbar_icon_click(t){"prefix"==t&&this.scan_code()},switch_click(t){this.multiuser=t.detail.value,this.handle_search()},scan_code(){P().then((t=>{if(this.scfl.length){let e=this.scfl.find((a=>a.material_no==t.result));e?this.allocate_loc_no(e):a({icon:"none",title:"物料编码不存在"})}else this.search_form.bill_no=t.result,this.handle_search()})).catch((t=>{a({icon:"none",title:t})}))},async handle_search(){this.scfl=[],this.inv_plans=[],this.search_form.bill_no&&(this.search_form.bill_no=this.search_form.bill_no.trim().toUpperCase(),this.search_form.bill_no.match(/^\d+$/)&&(this.search_form.bill_no="SCFLTZD"+this.search_form.bill_no),this.search_form.bill_no.startsWith("SCFLTZD")?await this.load_scfltzd():this.search_form.bill_no.startsWith("JSCLL")?await this.load_jscll():this.search_form.bill_no.startsWith("CGTL")&&await this.load_cgtl(),await this.load_inv_plans()),this.scfl.length?this.goods_nav.button_group[0]={text:"扫描物料",backgroundColor:t.state.goods_nav_color.yellow,color:"#fff"}:this.goods_nav.button_group[0]={text:"扫描单据",backgroundColor:t.state.goods_nav_color.red,color:"#fff"}},allocate_loc_no(t){e({url:"/pages/operation/move/unpack_allocate",events:{eventOutput:t=>{}},success:a=>{A("success"),a.eventChannel.emit("eventInput",{bill_no:this.search_form.bill_no,material:t})}})},async load_scfltzd(){try{l({title:"Loading"});let e={FBillNo:this.search_form.bill_no};this.multiuser?e.FStockId=t.state.cur_stock.FStockId:e.F_PAEZ_BaseProperty1=t.state.cur_staff.FName;let i=await U.query(e);if(s(),0===i.data.length)return void a({icon:"none",title:"没有相关数据"});let o=[];for(let t of i.data){let a=o.find((a=>a.material_id===t.FMaterialId));a?(a.must_qty+=t.FMustQty,a.base_must_qty+=t.FBaseMustQty):o.push({material_id:t.FMaterialId,material_no:t["FMaterialId.FNumber"],material_name:t["FMaterialId.FName"],material_spec:t["FMaterialId.FSpecification"],storekeeper:t.F_PAEZ_BaseProperty1,stock_id:t.FStockId,stock_name:t["FStockId.FName"],prd_line:t["F_PAEZ_Base.FName"],must_qty:t.FMustQty,unit_id:t.FUnitId1,unit_name:t["FUnitId1.FName"],base_must_qty:t.FBaseMustQty,base_unit_id:t.FBaseUnitId1,base_unit_name:t["FBaseUnitId1.FName"]})}this.scfl=o}catch(e){}},async load_jscll(){try{l({title:"Loading"});let e={FBillNo:this.search_form.bill_no};this.multiuser?e.FStockId=t.state.cur_stock.FStockId:e["FMaterialId.F_PAEZ_Base1"]=t.state.cur_staff.FName;let i=await D.query(e);if(s(),0===i.data.length)return void a({icon:"none",title:"没有相关数据"});let o=[];for(let t of i.data){let a=o.find((a=>a.material_id===t.FMaterialId));a?(a.must_qty+=t.FActualQty,a.base_must_qty+=t.FBaseActualQty):o.push({material_id:t.FMaterialId,material_no:t["FMaterialId.FNumber"],material_name:t["FMaterialId.FName"],material_spec:t["FMaterialId.FSpecification"],storekeeper:t["FMaterialId.F_PAEZ_Base1"],stock_id:t.FStockId,stock_name:t["FStockId.FName"],prd_line:t["FWorkShopId.FName"],must_qty:t.FActualQty,unit_id:t.FUnitId,unit_name:t["FUnitId.FName"],base_must_qty:t.FBaseActualQty,base_unit_id:t.FBaseUnitId,base_unit_name:t["FBaseUnitId.FName"]})}this.scfl=o}catch(e){}},async load_cgtl(){try{l({title:"Loading"});let e={FBillNo:this.search_form.bill_no,FStockId:t.state.cur_stock.FStockId},i=await Q.query(e);if(s(),0===i.data.length)return void a({icon:"none",title:"没有相关数据"});let o=[];for(let t of i.data){let a=o.find((a=>a.material_id===t.FMaterialId));a?(a.must_qty+=t.FRmRealQty,a.base_must_qty+=t.FRmRealQty):o.push({material_id:t.FMaterialId,material_no:t["FMaterialId.FNumber"],material_name:t["FMaterialId.FName"],material_spec:t["FMaterialId.FSpecification"],storekeeper:t["FMaterialId.F_PAEZ_Base1"],stock_id:t.FStockId,stock_name:t["FStockId.FName"],prd_line:t["FSupplierId.FName"],must_qty:t.FRmRealQty,unit_id:t.FUnitId,unit_name:t["FUnitId.FName"],base_must_qty:t.FRmRealQty,base_unit_id:t.FUnitId,base_unit_name:t["FUnitId.FName"]})}this.scfl=o}catch(e){}},async load_inv_plans(){var a;let e=await $.query({FBillNo:this.search_form.bill_no,FStockId:t.state.cur_stock.FStockId,FDocumentStatu:"C",FOpType:"mv"});this.inv_plans=e.data;let l={};for(let t of this.inv_plans)l[a=t.FMaterialId]||(l[a]=0),l[t.FMaterialId]+=t.FOpQTY;this.inv_plans_map=l},async load_scfl_todo(){let a=[];l({title:"Loading"});let e=await U.query({FDocumentStatus:"C",FCloseStatus:"A",F_PAEZ_BaseProperty1:t.state.cur_staff.FName,FCreateDate_ge:L(Date.now(),"yyyy-MM-dd")},{fields:["FBillNo","F_PAEZ_Base.FName"],order:"FCreateDate DESC"});for(let t of e.data){a.find((a=>a.bill_no==t.FBillNo))||a.push({bill_no:t.FBillNo,prd_line:t["F_PAEZ_Base.FName"]})}let i=await D.query({FDocumentStatus:"C","FMaterialId.F_PAEZ_Base1":t.state.cur_staff.FName,FCreateDate_ge:L(Date.now(),"yyyy-MM-dd")},{fields:["FBillNo","FWorkShopId.FName"],order:"FCreateDate DESC"});for(let t of i.data){a.find((a=>a.bill_no==t.FBillNo))||a.push({bill_no:t.FBillNo,prd_line:t["FWorkShopId.FName"]})}s(),this.scfl_todo=a}}},[["render",function(t,a,e,l,s,A){var P;const $=F,U=y,D=I(i("uni-easyinput"),b),Q=u,Z=I(i("uni-section"),v),L=I(i("uni-th"),C),R=I(i("uni-tr"),N),W=I(i("uni-td"),S),T=I(i("uni-tag"),M),O=I(i("uni-table"),B),z=I(i("uni-list-item"),j),G=I(i("uni-list"),w),V=I(i("uni-card"),q),J=I(i("uni-goods-nav"),x),H=g;return m(),o(d,null,[n(Z,{title:"查询单据编号",type:"square","sub-title":[t.$store.state.cur_stock["FUseOrgId.FName"],t.$store.state.cur_stock["FGroup.FName"]||"未分组",t.$store.state.cur_stock.FName].join(" / "),"sub-title-color":"#007aff",onClick:a[1]||(a[1]=a=>t.$logger.info(">>>",t.$data))},{right:r((()=>[n($,{class:"text-grey text-sm"},{default:r((()=>[f(h(s.multiuser?"多人":"单人"),1)])),_:1}),n(U,{onChange:A.switch_click,style:{transform:"scale(0.7)"}},null,8,["onChange"])])),default:r((()=>[n(Q,{class:"searchbar-container"},{default:r((()=>[n(D,{modelValue:s.search_form.bill_no,"onUpdate:modelValue":a[0]||(a[0]=t=>s.search_form.bill_no=t),placeholder:"请输入单据编号","prefix-icon":"scan",onConfirm:A.handle_search,onClear:A.handle_search,onIconClick:A.searchbar_icon_click,"primary-color":"rgb(238, 238, 238)",styles:{color:"#000",backgroundColor:"rgb(238, 238, 238)",borderColor:"rgb(238, 238, 238)",height:"60px"}},null,8,["modelValue","onConfirm","onClear","onIconClick","styles"])])),_:1})])),_:1},8,["sub-title"]),s.scfl.length?(m(),_(Z,{key:0,title:"子项明细",type:"square","sub-title":`${s.search_form.bill_no.startsWith("CGTL")?"供应商":"产线"}：${null==(P=s.scfl[0])?void 0:P.prd_line}`,"sub-title-color":"#007aff",class:"above-uni-goods-nav"},{default:r((()=>["h5"===t.$store.state.screen_type?(m(),_(O,{key:0,ref:"table",border:"",stripe:""},{default:r((()=>[n(R,null,{default:r((()=>[n(L,{align:"center",width:"60"},{default:r((()=>[f("序号")])),_:1}),n(L,{align:"center"},{default:r((()=>[f("物料编码")])),_:1}),n(L,{align:"center"},{default:r((()=>[f("物料名称")])),_:1}),n(L,{align:"center"},{default:r((()=>[f("规格型号")])),_:1}),n(L,{align:"center"},{default:r((()=>[f("单位")])),_:1}),n(L,{align:"center"},{default:r((()=>[f("应发数量")])),_:1}),n(L,{align:"center"},{default:r((()=>[f("已调拨数量")])),_:1}),n(L,{align:"center"},{default:r((()=>[f("仓库")])),_:1}),n(L,{align:"center"},{default:r((()=>[f("仓管员")])),_:1}),n(L,{align:"center"},{default:r((()=>[f("操作")])),_:1})])),_:1}),(m(!0),o(d,null,p(s.scfl,((a,e)=>(m(),_(R,{key:e},{default:r((()=>[n(W,{align:"center"},{default:r((()=>[f(h(e+1),1)])),_:2},1024),n(W,null,{default:r((()=>[f(h(a.material_no),1)])),_:2},1024),n(W,null,{default:r((()=>[f(h(a.material_name),1)])),_:2},1024),n(W,null,{default:r((()=>[f(h(a.material_spec),1)])),_:2},1024),n(W,{align:"center"},{default:r((()=>[f(h(a.unit_name),1)])),_:2},1024),n(W,{align:"center"},{default:r((()=>[f(h(a.must_qty),1)])),_:2},1024),n(W,{align:"center"},{default:r((()=>[f(h(s.inv_plans_map[a.material_id]),1)])),_:2},1024),n(W,null,{default:r((()=>[n($,{class:k([a.stock_id==t.$store.state.cur_stock.FStockId?"text-primary":"text-error"])},{default:r((()=>[f(h(a.stock_name),1)])),_:2},1032,["class"])])),_:2},1024),n(W,null,{default:r((()=>[f(h(a.storekeeper),1)])),_:2},1024),n(W,{align:"center"},{default:r((()=>[n(T,{text:"分配库位",type:"primary",onClick:t=>A.allocate_loc_no(a)},null,8,["onClick"])])),_:2},1024)])),_:2},1024)))),128))])),_:1},512)):(m(),_(G,{key:1},{default:r((()=>[(m(!0),o(d,null,p(s.scfl,((a,e)=>(m(),_(z,{key:e,onClick:t=>A.allocate_loc_no(a),clickable:"","show-arrow":""},{body:r((()=>[n(Q,{class:"uni-list-item__body"},{default:r((()=>[n($,{class:"title"},{default:r((()=>[f(h(a.material_no),1)])),_:2},1024),n(Q,{class:"note"},{default:r((()=>[n(Q,null,{default:r((()=>[f("名称："+h(a.material_name),1)])),_:2},1024),n(Q,null,{default:r((()=>[f("规格："+h(a.material_spec),1)])),_:2},1024),n(Q,null,{default:r((()=>[f("仓库："),n($,{class:k([a.stock_id==t.$store.state.cur_stock.FStockId?"text-primary":"text-error"])},{default:r((()=>[f(h(a.stock_name),1)])),_:2},1032,["class"])])),_:2},1024),n(Q,null,{default:r((()=>[f("仓管员："+h(a.storekeeper),1)])),_:2},1024)])),_:2},1024)])),_:2},1024)])),footer:r((()=>[n(Q,{class:"uni-list-item__foot"},{default:r((()=>[n(Q,null,{default:r((()=>[f(h(a.must_qty)+" "+h(a.unit_name),1)])),_:2},1024),s.inv_plans_map[a.material_id]?(m(),_(Q,{key:0},{default:r((()=>[f("已调拨："),n($,{class:"text-primary"},{default:r((()=>[f(h(s.inv_plans_map[a.material_id]),1)])),_:2},1024)])),_:2},1024)):c("",!0)])),_:2},1024)])),_:2},1032,["onClick"])))),128))])),_:1}))])),_:1},8,["sub-title"])):c("",!0),!s.scfl.length&&s.scfl_todo.length?(m(),_(Z,{key:1,title:"今日生产发料",type:"square"},{default:r((()=>[n(V,{spacing:"0",padding:"0"},{default:r((()=>[n(G,null,{default:r((()=>[(m(!0),o(d,null,p(s.scfl_todo,((t,a)=>(m(),_(z,{key:a,"extra-icon":{type:"chat",size:"24",color:"#007bff"},"show-extra-icon":"",title:t.bill_no,"right-text":t.prd_line,onClick:a=>{s.search_form.bill_no=t.bill_no,A.handle_search()},clickable:"","show-arrow":""},null,8,["title","right-text","onClick"])))),128))])),_:1})])),_:1})])),_:1})):c("",!0),"app-plus"===t.$store.state.screen_type?(m(),_(Q,{key:2,class:"uni-goods-nav-wrapper"},{default:r((()=>[n(J,{options:s.goods_nav.options,"button-group":s.goods_nav.button_group,fill:t.$store.state.goods_nav_fill,onClick:A.goods_nav_click,onButtonClick:A.goods_nav_button_click},null,8,["options","button-group","fill","onClick","onButtonClick"])])),_:1})):c("",!0),A.is_completed?(m(),_(H,{key:3,src:E,class:"yiwancheng-stamp"})):c("",!0)],64)}]]);export{R as default};
