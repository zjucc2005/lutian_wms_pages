import{s as t,p as o,n as e,b as a,v as i,c as s,d as n,w as r,i as _,o as l,e as m,f as u,t as c,q as d,u as f,F as h,k as p}from"./index-Bu7BB2Sn.js";import{_ as b}from"./uni-easyinput.rEyKZ7UZ.js";import{r as F}from"./uni-app.es.DqvpptM9.js";import{_ as g,a as k}from"./uni-forms.k46PHGUU.js";import{_ as v}from"./uni-data-picker.DTNU0gr_.js";import{_ as I}from"./uni-section.CtzwYLr2.js";import{_ as N}from"./uni-list-item.BEmCCMNu.js";import{_ as y,a as x}from"./uni-swipe-action.BVq5v1oq.js";import{_ as j}from"./uni-goods-nav.Dt0enr9c.js";import{d as C,i as S,a as O,p as q,b as T}from"./index.CjPNc-2-.js";import{a as B}from"./index.bLbHULXj.js";import{I as V}from"./inbound_task.-h5ZZVxe.js";import"./k3cloudapi.cCLE6bXq.js";import"./stock_loc.Bg1Allw4.js";import{I as w}from"./inv_log.CiTZZpLf.js";import{f as D}from"./date-format.Dm3Q97cL.js";import{s as M}from"./scan_code.D9UxMkiN.js";import{_ as R}from"./_plugin-vue_export-helper.BCo6x5W8.js";import"./uni-icons.BaZHZ2F1.js";import"./uni-load-more.eq_s4Sbp.js";import"./uni-badge.BY_L8vwX.js";import"./bd_empinfo.CoBO88he.js";const U=R({data(){return{cur_stock:{},cur_staff:{},cur_inbound_task:{},inv_logs:[],stock_locs:[],stock_loc_opts:[],bd_materials:[],mount_form:{material_no:"",material_name:"",material_spec:"",loc_no:"",op_qty:"",base_unit:"Pcs",base_unit_name:"Pcs",decimal_unit:!1,remark:""},mount_form_rules:{material_no:{rules:[{required:!0,errorMessage:"物料编号不能为空"},{validateFunction:(t,o,e,a)=>{let i=o;this.cur_inbound_task.inbound_list.find((t=>t.material_no==i));let s=this.bd_materials.find((t=>t.FNumber==i));return s?"C"!=s.FDocumentStatus?a("此物料编码未审核"):"A"!=s.FForbidStatus?a("此物料编码被禁用"):void 0:B(i,this.cur_stock.FUseOrgId).then((t=>t.data[0]?(s=t.data[0],this.bd_materials.some((t=>t.FNumber==i))||this.bd_materials.push(t.data[0]),"C"!=s.FDocumentStatus?a("此物料编码未审核"):"A"!=s.FForbidStatus?a("此物料编码被禁用"):s):a(`[${this.cur_stock["FUseOrgId.FName"]}]不存在此物料编码`)))}}]},loc_no:{rules:[{required:!0,errorMessage:"库位号不能为空"},{validateFunction:(t,o,e,a)=>{let i=this.stock_locs.find((t=>t.FNumber==o));return i?"C"!=i.FDocumentStatus?a("此库位号未审核"):void 0:a("不存在此库位号")}}]},op_qty:{rules:[{required:!0,errorMessage:"上架数量不能为空"},{format:"number",errorMessage:"上架数量只能输入数字"},{validateFunction:(t,o,e,a)=>o<=0?a("上架数量必须大于0"):this.mount_form.decimal_unit||Number.isInteger(o)?void 0:a("上架数量必须为整数")}]}},log_options:[{text:"取消",style:{backgroundColor:"#f56c6c"}}],goods_nav:{options:[{icon:"more-filled",text:"更多"}],button_group:[{text:"扫码",backgroundColor:"linear-gradient(90deg, #FE6035, #EF1224)",color:"#fff"},{text:"提交上架",backgroundColor:"linear-gradient(90deg, #1E83FF, #0053B8)",color:"#fff"}]}}},mounted(){this.cur_stock=t.state.cur_stock,this.cur_staff=t.state.cur_staff,this.cur_inbound_task=V.current(),this.stock_locs=t.state.stock_locs,this.stock_loc_opts=t.state.stock_loc_opts,w.query({FStockId:this.cur_stock.FStockId,FBatchNo:this.cur_inbound_task.batch_no,FOpType_in:["in","in_cl"]},{page:1,per_page:5,order:"FCreateTime DESC"}).then((t=>{t.data.reverse().forEach((t=>this.unshift_inv_log(t)))}))},methods:{describe_inv_log:C,formatDate:D,swipe_action_click(t,o){0===t.index&&this.submit_cancel(o)},goods_nav_click(t){0===t.index&&this.more_actions()},goods_nav_button_click(t){0===t.index&&this.scan_code(),1===t.index&&this.submit_mount()},handle_icon_click(t){if("material_no"==t){let t=this.cur_inbound_task.inbound_list.map((t=>t.material_no));o({itemList:t,success:o=>{this.mount_form.material_no=t[o.tapIndex],this.handle_material_no_change()}})}},handle_material_no_change(){let t=this.mount_form.material_no;if(!t)return void this.set_base_unit();let o=this.bd_materials.find((o=>o.FNumber==t));o?this.set_base_unit(o):B(t,this.cur_stock.FUseOrgId).then((e=>{e.data[0]?(o=e.data[0],this.bd_materials.some((o=>o.FNumber==t))||this.bd_materials.push(e.data[0]),this.set_base_unit(o)):this.set_base_unit()}))},more_actions(){o({itemList:["入库详情","操作日志","debug"],success:t=>{0===t.tapIndex&&e({url:"/pages/operation/inbound/v1/task"}),1===t.tapIndex&&e({url:"/pages/operation/inbound/v1/logs"}),2===t.tapIndex&&this.$logger.info("this.$data",this.$data)}})},scan_code(){M().then((t=>{this.handle_scan_code(t.result)})).catch((t=>{a({icon:"none",title:t})}))},handle_scan_code(t){S(t)?(this.mount_form.material_no=t,this.handle_material_no_change()):O(t)?this.mount_form.loc_no=t:this.mount_form.material_no?this.mount_form.loc_no||(this.mount_form.loc_no=t):(this.mount_form.material_no=t,this.handle_material_no_change())},submit_mount(){this.$refs.mount_form.validate().then((t=>{let o=this.bd_materials.find((t=>t.FNumber==this.mount_form.material_no)),e=this.stock_locs.find((t=>t.FNumber==this.mount_form.loc_no));new w({FOpType:"in",FStockId:this.cur_stock.FStockId,FStockLocNo:e.FNumber,FMaterialId:o.FMaterialId,FOpQTY:1*this.mount_form.op_qty,FBatchNo:this.cur_inbound_task.batch_no,FBillNo:this.cur_inbound_task.bill_no,FOpStaffNo:this.cur_staff.FNumber,FRemark:this.mount_form.remark}).save().then((t=>{q("success"),this.after_save(t),this.reset_form()}))})).catch((t=>{}))},submit_cancel(t){let o=this.inv_logs.find((o=>o.FID==t));if("in"!=o.FOpType||o.status)q("warn"),a({icon:"error",title:"ERROR"});else{new w({FOpType:"in_cl",FStockId:o.FStockId,FStockLocNo:o["FStockLocId.FNumber"],FMaterialId:o.FMaterialId,FOpQTY:o.FOpQTY,FBatchNo:o.FBatchNo,FBillNo:o.FBillNo,FOpStaffNo:this.cur_staff.FNumber,FReferId:o.FID}).save().then((t=>{q("success"),this.after_save(t),this.$refs.inv_log_swipe.closeAll()}))}},set_base_unit(t){t?(this.mount_form.material_name=t.FName,this.mount_form.material_spec=t.FSpecification,this.mount_form.base_unit=t["FBaseUnitId.FNumber"],this.mount_form.base_unit_name=t["FBaseUnitId.FName"],this.mount_form.decimal_unit=T(t["FBaseUnitId.FName"])):(this.mount_form.material_name="",this.mount_form.material_spec="",this.mount_form.base_unit="Pcs",this.mount_form.base_unit_name="Pcs",this.mount_form.decimal_unit=!1)},after_save(t){t.data.Result.ResponseStatus.IsSuccess?w.find(t.data.Result.Id).then((t=>{t.data[0]&&(this.unshift_inv_log(t.data[0]),a({title:"提交成功"}))})):a({title:"提交失败"})},reset_form(){this.mount_form={material_no:"",material_name:"",material_spec:"",loc_no:"",op_qty:"",base_unit:"Pcs",base_unit_name:"Pcs",decimal_unit:!1,remark:""},i({scrollTop:0})},unshift_inv_log(t){if("in_cl"==t.FOpType){let o=this.inv_logs.find((o=>o.FID===t.FReferId));o&&(o.status="已取消")}this.inv_logs.unshift(t),this.inv_logs.length>5&&(this.inv_logs=this.inv_logs.slice(0,5))}}},[["render",function(t,o,e,a,i,C){const S=F(s("uni-easyinput"),b),O=F(s("uni-forms-item"),g),q=F(s("uni-data-picker"),v),T=p,B=F(s("uni-forms"),k),V=_,w=F(s("uni-section"),I),D=F(s("uni-list-item"),N),M=F(s("uni-swipe-action-item"),y),R=F(s("uni-swipe-action"),x),U=F(s("uni-goods-nav"),j);return l(),n(V,null,{default:r((()=>[m(w,{title:"上架",type:"line","sub-title":i.mount_form.material_name?[i.mount_form.material_name,i.mount_form.material_spec].join("\n"):["-","-"].join("\n")},{default:r((()=>[m(V,{class:"container"},{default:r((()=>[m(B,{ref:"mount_form",model:i.mount_form,rules:i.mount_form_rules,labelWidth:"80px"},{default:r((()=>[m(O,{label:"物料编号",name:"material_no",required:""},{default:r((()=>[m(S,{modelValue:i.mount_form.material_no,"onUpdate:modelValue":o[0]||(o[0]=t=>i.mount_form.material_no=t),trim:"both","prefix-icon":"list",onIconClick:o[1]||(o[1]=t=>C.handle_icon_click("material_no")),onChange:C.handle_material_no_change,onClear:C.handle_material_no_change},null,8,["modelValue","onChange","onClear"])])),_:1}),m(O,{label:"库位号",name:"loc_no",required:""},{default:r((()=>[m(q,{modelValue:i.mount_form.loc_no,"onUpdate:modelValue":o[2]||(o[2]=t=>i.mount_form.loc_no=t),localdata:i.stock_loc_opts,split:"-","popup-title":"请选择库位"},null,8,["modelValue","localdata"])])),_:1}),m(O,{label:"上架数量",name:"op_qty",required:""},{default:r((()=>[m(S,{modelValue:i.mount_form.op_qty,"onUpdate:modelValue":o[3]||(o[3]=t=>i.mount_form.op_qty=t),type:"number"},{right:r((()=>[m(T,{class:"easyinput-suffix-text"},{default:r((()=>[u(c(i.mount_form.base_unit_name),1)])),_:1})])),_:1},8,["modelValue"])])),_:1}),m(O,{label:"备注",name:"remark"},{default:r((()=>[m(S,{modelValue:i.mount_form.remark,"onUpdate:modelValue":o[4]||(o[4]=t=>i.mount_form.remark=t),trim:"both"},null,8,["modelValue"])])),_:1})])),_:1},8,["model","rules"])])),_:1})])),_:1},8,["sub-title"]),m(w,{title:"最近操作日志",type:"line",style:{"padding-bottom":"60px"}},{default:r((()=>[m(R,{ref:"inv_log_swipe"},{default:r((()=>[(l(!0),d(h,null,f(i.inv_logs,((t,o)=>(l(),n(M,{key:o,threshold:60,"right-options":"in"!=t.FOpType||t.status?[]:i.log_options,onClick:o=>C.swipe_action_click(o,t.FID)},{default:r((()=>[m(D,{title:C.formatDate(t.FCreateTime,"yyyy-MM-dd hh:mm:ss"),note:C.describe_inv_log(t),rightText:t.status},{footer:r((()=>[m(T,{class:"uni-list-item-right-text"},{default:r((()=>[u(c(t.status),1)])),_:2},1024)])),_:2},1032,["title","note","rightText"])])),_:2},1032,["right-options","onClick"])))),128))])),_:1},512)])),_:1}),m(V,{class:"uni-goods-nav-wrapper"},{default:r((()=>[m(U,{options:i.goods_nav.options,"button-group":i.goods_nav.button_group,onClick:C.goods_nav_click,onButtonClick:C.goods_nav_button_click},null,8,["options","button-group","onClick","onButtonClick"])])),_:1})])),_:1})}]]);export{U as default};
