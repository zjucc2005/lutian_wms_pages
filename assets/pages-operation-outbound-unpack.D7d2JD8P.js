import{s as t,p as e,b as a,a as i,h as l,c as s,q as o,e as r,w as n,d as _,g as c,F as d,i as u,o as m,f,t as h,u as F,k as p,L as k,y,M as g}from"./index-DsK9pIyj.js";import{_ as b}from"./uni-easyinput.BfazFYzq.js";import{r as I}from"./uni-app.es.CSK8ITuj.js";import{_ as v}from"./uni-section.BpQrEx4g.js";import{_ as S,a as N,b as C}from"./uni-td.DKOxbdh1.js";import{_ as M}from"./uni-icons.DRoE6XYp.js";import{_ as x}from"./uni-table.BXeOwSLO.js";import{_ as q}from"./uni-list-item.BkmqxiQh.js";import{_ as B}from"./uni-list.dJf-6p1_.js";import{_ as w}from"./uni-card.CdeHcnQF.js";import{_ as j}from"./uni-goods-nav.BN-nj5na.js";import{f as Q}from"./date-format.Dm3Q97cL.js";import{s as L}from"./scan_code.CGa79-3n.js";import"./k3cloudapi.PCDjx1SF.js";import{I as U}from"./stock_loc.Bj3C3Byx.js";import{I as $}from"./inv_log.D0BShjlW.js";import{P as A}from"./prd_issue_mtr_notice.CNj_PT4N.js";import{S as D,P}from"./sp_pick_mtrl.Da0mJRUw.js";import{_ as T}from"./yiwancheng_stamp.fi2kVvVZ.js";import{_ as E}from"./_plugin-vue_export-helper.BCo6x5W8.js";import"./uni-datetime-picker.Bsu03if5.js";import"./uni-badge.CO78OwkC.js";const R=E({data:()=>({scfl:[],scfl_todo:[],invs:[],invs_map:{},inv_logs:[],inv_logs_map:{},filter_cond:"全部",search_form:{bill_no:""},goods_nav:{options:[{icon:"checkbox",text:"全选"},{icon:"settings",text:"全部"}],button_group:[{text:"扫码查询单据",backgroundColor:t.state.goods_nav_color.red,color:"#fff"},{text:"确认出库",backgroundColor:t.state.goods_nav_color.blue,color:"#fff"}]}}),onShow(){this.search_form.bill_no||this.load_scfl_todo()},computed:{scfl_filtered(){return"全部"===this.filter_cond?this.scfl:"未出库"===this.filter_cond?this.scfl.filter((t=>(this.inv_logs_map[t.material_id]||0)<t.must_qty)):"可出库"===this.filter_cond?this.scfl.filter((t=>this.can_outbound(t))):"已出库"===this.filter_cond?this.scfl.filter((t=>(this.inv_logs_map[t.material_id]||0)>=t.must_qty)):void 0},is_completed(){let t=!0;if(this.scfl.length){for(let e of this.scfl)if(!this.inv_logs_map[e.material_id]){t=!1;break}}else t=!1;return t}},methods:{check_all(){let t=this.scfl.some((t=>!t.checked&&this.can_outbound(t)));for(let e of this.scfl)this.can_outbound(e)&&(e.checked=t)},can_outbound(t){return(this.inv_logs_map[t.material_id]||0)<t.must_qty&&this.invs_map[t.material_id]},checkbox_click(t){let e=this.scfl.find((e=>e.material_id===t.target.dataset.id));e&&(e.checked=!e.checked)},goods_nav_click(t){0===t.index&&this.check_all(),1===t.index&&this.filter_list()},goods_nav_button_click(t){0===t.index&&this.scan_code(),1===t.index&&this.submit_outbound()},filter_list(){let t=["全部","未出库","可出库","已出库"];e({itemList:t,success:e=>{this.filter_cond=t[e.tapIndex],this.goods_nav.options[1].text=t[e.tapIndex]}})},searchbar_icon_click(t){"prefix"==t&&this.scan_code()},scan_code(){L().then((t=>{this.search_form.bill_no=t.result,this.handle_search()})).catch((t=>{a({icon:"none",title:t})}))},async handle_search(){this.scfl=[],this.invs=[],this.inv_logs=[],this.search_form.bill_no&&(this.search_form.bill_no=this.search_form.bill_no.trim().toUpperCase(),this.search_form.bill_no.match(/^\d+$/)&&(this.search_form.bill_no="SCFLTZD"+this.search_form.bill_no),this.search_form.bill_no.startsWith("SCFLTZD")?await this.load_scfltzd():this.search_form.bill_no.startsWith("JSCLL")?await this.load_jscll():this.search_form.bill_no.startsWith("CGTL")&&await this.load_cgtl(),await this.load_invs(),await this.load_inv_logs())},async load_scfltzd(){try{i({title:"Loading"});let e=await A.query({FBillNo:this.search_form.bill_no,FStockId:t.state.cur_stock.FStockId});if(l(),0==e.data.length)return void a({icon:"none",title:"没有相关数据"});let s=[];for(let t of e.data){let e=s.find((e=>e.material_id===t.FMaterialId));e?(e.must_qty+=t.FMustQty,e.base_must_qty+=t.FBaseMustQty):s.push({material_id:t.FMaterialId,material_no:t["FMaterialId.FNumber"],material_name:t["FMaterialId.FName"],material_spec:t["FMaterialId.FSpecification"],storekeeper:t.F_PAEZ_BaseProperty1,stock_id:t.FStockId,stock_name:t["FStockId.FName"],prd_line:t["F_PAEZ_Base.FName"],must_qty:t.FMustQty,unit_id:t.FUnitId1,unit_name:t["FUnitId1.FName"],base_must_qty:t.FBaseMustQty,base_unit_id:t.FBaseUnitId1,base_unit_name:t["FBaseUnitId1.FName"]})}this.scfl=s}catch(e){}},async load_jscll(){try{i({title:"Loading"});let e=await D.query({FBillNo:this.search_form.bill_no,FStockId:t.state.cur_stock.FStockId});if(l(),0==e.data.length)return void a({icon:"none",title:"没有相关数据"});let s=[];for(let t of e.data){let e=s.find((e=>e.material_id===t.FMaterialId));e?(e.must_qty+=t.FActualQty,e.base_must_qty+=t.FBaseActualQty):s.push({material_id:t.FMaterialId,material_no:t["FMaterialId.FNumber"],material_name:t["FMaterialId.FName"],material_spec:t["FMaterialId.FSpecification"],storekeeper:t["FMaterialId.F_PAEZ_Base1"],stock_id:t.FStockId,stock_name:t["FStockId.FName"],prd_line:t["FWorkShopId.FName"],must_qty:t.FActualQty,unit_id:t.FUnitId,unit_name:t["FUnitId.FName"],base_must_qty:t.FBaseActualQty,base_unit_id:t.FBaseUnitId,base_unit_name:t["FBaseUnitId.FName"]})}this.scfl=s}catch(e){}},async load_cgtl(){try{i({title:"Loading"});let e=await P.query({FBillNo:this.search_form.bill_no,FStockId:t.state.cur_stock.FStockId});if(l(),0===e.data.length)return void a({icon:"none",title:"没有相关数据"});let s=[];for(let t of e.data){let e=s.find((e=>e.material_id===t.FMaterialId));e?(e.must_qty+=t.FRmRealQty,e.base_must_qty+=t.FRmRealQty):s.push({material_id:t.FMaterialId,material_no:t["FMaterialId.FNumber"],material_name:t["FMaterialId.FName"],material_spec:t["FMaterialId.FSpecification"],storekeeper:t["FMaterialId.F_PAEZ_Base1"],stock_id:t.FStockId,stock_name:t["FStockId.FName"],prd_line:t["FSupplierId.FName"],must_qty:t.FRmRealQty,unit_id:t.FUnitId,unit_name:t["FUnitId.FName"],base_must_qty:t.FRmRealQty,base_unit_id:t.FUnitId,base_unit_name:t["FUnitId.FName"]})}this.scfl=s}catch(e){}},async load_invs(){var e;let a=await U.get_all({FStockId:t.state.cur_stock.FStockId,"FStockLocId.FName_lk":"拆包区"},{order:"FBatchNo ASC"});this.invs=a;let i={};for(let t of this.invs)i[e=t.FMaterialId]||(i[e]=0),i[t.FMaterialId]+=t.FQty;this.invs_map=i},async load_inv_logs(){var e;let a=await $.query({FBillNo:this.search_form.bill_no,FStockId:t.state.cur_stock.FStockId,FOpType:"out"});this.inv_logs=a.data;let i={};for(let t of this.inv_logs)i[e=t.FMaterialId]||(i[e]=0),i[t.FMaterialId]+=t.FOpQTY;this.inv_logs_map=i},async submit_outbound(){let e=this.scfl.filter((t=>t.checked));if(0!==e.length){i({title:"Loading",mask:!0});for(let a=0;a<e.length;a++){i({title:`${a}/${e.length}`,mask:!0});let l=e[a],s=this.invs.filter((t=>t.FMaterialId===l.material_id)),o=l.must_qty-(this.inv_logs_map[l.material_id]||0);for(let e of s){if(0===o)break;let a=e.FQty>=o?o:e.FQty,i=new $({FOpType:"out",FStockId:t.state.cur_stock.FStockId,FStockLocNo:e["FStockLocId.FNumber"],FMaterialId:e.FMaterialId,FOpQTY:a,FBatchNo:e.FBatchNo,FSupplierId:e.FSupplierId,FBillNo:this.search_form.bill_no,FOpStaffNo:t.state.cur_staff.FNumber});await i.save(),o-=a}l.checked=!1}await this.load_invs(),await this.load_inv_logs(),l(),a({title:"出库成功",mask:!0})}else a({icon:"none",title:"未勾选出库信息"})},async load_scfl_todo(){let e=[];i({title:"Loading"});let a=await A.query({FDocumentStatus:"C",FCloseStatus:"A",FStockId:t.state.cur_stock.FStockId,FCreateDate_ge:Q(Date.now(),"yyyy-MM-dd")},{fields:["FBillNo","F_PAEZ_Base.FName"],order:"FCreateDate DESC"});for(let t of a.data){e.find((e=>e.bill_no==t.FBillNo))||e.push({bill_no:t.FBillNo,prd_line:t["F_PAEZ_Base.FName"]})}let s=await D.query({FDocumentStatus:"C",FStockId:t.state.cur_stock.FStockId,FCreateDate_ge:Q(Date.now(),"yyyy-MM-dd")},{fields:["FBillNo","FWorkShopId.FName"],order:"FCreateDate DESC"});for(let t of s.data){e.find((e=>e.bill_no==t.FBillNo))||e.push({bill_no:t.FBillNo,prd_line:t["FWorkShopId.FName"]})}l(),this.scfl_todo=e}}},[["render",function(t,e,a,i,l,Q){var L;const U=I(s("uni-easyinput"),b),$=u,A=I(s("uni-section"),v),D=p,P=I(s("uni-th"),S),E=I(s("uni-tr"),N),R=I(s("uni-icons"),M),Z=y,O=I(s("uni-td"),C),W=I(s("uni-table"),x),z=I(s("uni-list-item"),q),G=I(s("uni-list"),B),V=I(s("uni-card"),w),J=I(s("uni-goods-nav"),j),Y=g;return m(),o(d,null,[r(A,{title:"查询单据编号",type:"square","sub-title":[t.$store.state.cur_stock["FUseOrgId.FName"],t.$store.state.cur_stock["FGroup.FName"]||"未分组",t.$store.state.cur_stock.FName].join(" / "),"sub-title-color":"#007aff",onClick:e[1]||(e[1]=e=>t.$logger.info(">>>",t.$data))},{default:n((()=>[r($,{class:"searchbar-container"},{default:n((()=>[r(U,{modelValue:l.search_form.bill_no,"onUpdate:modelValue":e[0]||(e[0]=t=>l.search_form.bill_no=t),placeholder:"请输入单据编号","prefix-icon":"scan",onConfirm:Q.handle_search,onClear:Q.handle_search,onIconClick:Q.searchbar_icon_click,"primary-color":"rgb(238, 238, 238)",styles:{color:"#000",backgroundColor:"rgb(238, 238, 238)",borderColor:"rgb(238, 238, 238)"}},null,8,["modelValue","onConfirm","onClear","onIconClick","styles"])])),_:1})])),_:1},8,["sub-title"]),l.scfl.length?(m(),_(A,{key:0,title:"子项明细",type:"square","sub-title":`${l.search_form.bill_no.startsWith("CGTL")?"供应商":"产线"}：${null==(L=l.scfl[0])?void 0:L.prd_line}`,"sub-title-color":"#007aff",class:"above-uni-goods-nav"},{right:n((()=>[r($,null,{default:n((()=>[f("已勾选 "),r(D,{class:"text-primary"},{default:n((()=>[f(h(l.scfl.filter((t=>t.checked)).length),1)])),_:1}),f(" 行")])),_:1})])),default:n((()=>["h5"===t.$store.state.screen_type?(m(),_(W,{key:0,ref:"table",border:"",stripe:""},{default:n((()=>[r(E,null,{default:n((()=>[r(P,{align:"center",width:"30"}),r(P,{align:"center",width:"60"},{default:n((()=>[f("序号")])),_:1}),r(P,{align:"center"},{default:n((()=>[f("物料编码")])),_:1}),r(P,{align:"center"},{default:n((()=>[f("物料名称")])),_:1}),r(P,{align:"center"},{default:n((()=>[f("规格型号")])),_:1}),r(P,{align:"center"},{default:n((()=>[f("单位")])),_:1}),r(P,{align:"center"},{default:n((()=>[f("应发数量")])),_:1}),r(P,{align:"center"},{default:n((()=>[f("拆包区数量")])),_:1}),r(P,{align:"center"},{default:n((()=>[f("实发数量")])),_:1}),r(P,{align:"center"},{default:n((()=>[f("仓库")])),_:1}),r(P,{align:"center"},{default:n((()=>[f("仓管员")])),_:1})])),_:1}),(m(!0),o(d,null,F(Q.scfl_filtered,((e,a)=>(m(),_(E,{key:a},{default:n((()=>[r(O,null,{default:n((()=>[l.inv_logs_map[e.material_id]>=e.must_qty?(m(),_(R,{key:0,type:"paperplane",size:"30",color:"#007aff"})):l.invs_map[e.material_id]&&l.invs_map[e.material_id]>0?(m(),_(Z,{key:1,checked:e.checked,onClick:Q.checkbox_click,"data-id":e.material_id},null,8,["checked","onClick","data-id"])):(m(),_(Z,{key:2,disabled:""}))])),_:2},1024),r(O,{align:"center"},{default:n((()=>[f(h(a+1),1)])),_:2},1024),r(O,null,{default:n((()=>[f(h(e.material_no),1)])),_:2},1024),r(O,null,{default:n((()=>[f(h(e.material_name),1)])),_:2},1024),r(O,null,{default:n((()=>[f(h(e.material_spec),1)])),_:2},1024),r(O,{align:"center"},{default:n((()=>[f(h(e.unit_name),1)])),_:2},1024),r(O,{align:"center"},{default:n((()=>[f(h(e.must_qty),1)])),_:2},1024),r(O,{align:"center"},{default:n((()=>[f(h(l.invs_map[e.material_id]||0),1)])),_:2},1024),r(O,{align:"center"},{default:n((()=>[f(h(l.inv_logs_map[e.material_id]),1)])),_:2},1024),r(O,null,{default:n((()=>[r(D,{class:k([e.stock_id==t.$store.state.cur_stock.FStockId?"text-primary":"text-error"])},{default:n((()=>[f(h(e.stock_name),1)])),_:2},1032,["class"])])),_:2},1024),r(O,null,{default:n((()=>[f(h(e.storekeeper),1)])),_:2},1024)])),_:2},1024)))),128))])),_:1},512)):(m(),_(G,{key:1},{default:n((()=>[(m(!0),o(d,null,F(Q.scfl_filtered,((e,a)=>(m(),_(z,{key:a},{header:n((()=>[r($,{class:"uni-list-item__head"},{default:n((()=>[l.inv_logs_map[e.material_id]>=e.must_qty?(m(),_(R,{key:0,type:"paperplane",size:"30",color:"#007aff"})):l.invs_map[e.material_id]&&l.invs_map[e.material_id]>0?(m(),_(Z,{key:1,checked:e.checked,onClick:Q.checkbox_click,"data-id":e.material_id},null,8,["checked","onClick","data-id"])):(m(),_(Z,{key:2,disabled:""}))])),_:2},1024)])),body:n((()=>[r($,{class:"uni-list-item__body"},{default:n((()=>[r(D,{class:"title"},{default:n((()=>[f(h(e.material_no),1)])),_:2},1024),r($,{class:"note"},{default:n((()=>[r($,null,{default:n((()=>[f("名称："+h(e.material_name),1)])),_:2},1024),r($,null,{default:n((()=>[f("规格："+h(e.material_spec),1)])),_:2},1024),r($,null,{default:n((()=>[f("仓库："),r(D,{class:k([e.stock_id==t.$store.state.cur_stock.FStockId?"text-primary":"text-error"])},{default:n((()=>[f(h(e.stock_name),1)])),_:2},1032,["class"])])),_:2},1024),r($,null,{default:n((()=>[f("单位："+h(e.unit_name),1)])),_:2},1024)])),_:2},1024)])),_:2},1024)])),footer:n((()=>[r($,{class:"uni-list-item__foot"},{default:n((()=>[r($,null,{default:n((()=>[f(" 应发："),r(D,{class:"text-lg"},{default:n((()=>[f(h(e.must_qty),1)])),_:2},1024)])),_:2},1024),l.inv_logs_map[e.material_id]?(m(),_($,{key:0},{default:n((()=>[f(" 实发："),r(D,{class:"text-primary text-lg"},{default:n((()=>[f(h(l.inv_logs_map[e.material_id]||0),1)])),_:2},1024)])),_:2},1024)):c("",!0),(l.inv_logs_map[e.material_id]||0)<e.must_qty?(m(),_($,{key:1},{default:n((()=>[f(" 拆包区："),r(D,{class:"text-lg"},{default:n((()=>[f(h(l.invs_map[e.material_id]||0),1)])),_:2},1024)])),_:2},1024)):c("",!0)])),_:2},1024)])),_:2},1024)))),128))])),_:1}))])),_:1},8,["sub-title"])):c("",!0),!l.scfl.length&&l.scfl_todo.length?(m(),_(A,{key:1,title:"今日生产发料",type:"square"},{default:n((()=>[r(V,{spacing:"0",padding:"0"},{default:n((()=>[r(G,null,{default:n((()=>[(m(!0),o(d,null,F(l.scfl_todo,((t,e)=>(m(),_(z,{key:e,"extra-icon":{type:"chat",size:"24",color:"#007bff"},"show-extra-icon":"",title:t.bill_no,"right-text":t.prd_line,onClick:e=>{l.search_form.bill_no=t.bill_no,Q.handle_search()},clickable:"","show-arrow":""},null,8,["title","right-text","onClick"])))),128))])),_:1})])),_:1})])),_:1})):c("",!0),r($,{class:"uni-goods-nav-wrapper"},{default:n((()=>[r(J,{options:l.goods_nav.options,"button-group":l.goods_nav.button_group,fill:t.$store.state.goods_nav_fill,onClick:Q.goods_nav_click,onButtonClick:Q.goods_nav_button_click},null,8,["options","button-group","fill","onClick","onButtonClick"])])),_:1}),Q.is_completed?(m(),_(Y,{key:2,src:T,class:"yiwancheng-stamp"})):c("",!0)],64)}]]);export{R as default};
