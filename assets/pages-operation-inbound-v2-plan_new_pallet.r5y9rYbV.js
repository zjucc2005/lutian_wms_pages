import{s as t,R as e,b as a,n as l,m as i,a as o,h as s,v as n,c as _,q as r,e as u,w as p,d,g as c,F as m,i as f,o as h,u as b,f as v,t as y,S as k,k as g,l as F,T as q}from"./index-DsK9pIyj.js";import{_ as w}from"./uni-steps.C5theenr.js";import{r as x}from"./uni-app.es.CSK8ITuj.js";import{_ as S}from"./uni-list-item.BkmqxiQh.js";import{_ as I}from"./uni-list.dJf-6p1_.js";import{_ as C}from"./uni-section.BpQrEx4g.js";import{_ as j,a as N,b as $}from"./uni-td.DKOxbdh1.js";import{_ as B}from"./uni-easyinput.BfazFYzq.js";import{_ as L}from"./uni-icons.DRoE6XYp.js";import{_ as T}from"./uni-table.BXeOwSLO.js";import{_ as O}from"./uni-goods-nav.BN-nj5na.js";import{_ as E}from"./uni-drawer.BPNIP2eu.js";import{I as A}from"./inbound_task.DN8rWXup.js";import"./k3cloudapi.PCDjx1SF.js";import{S as M,I as R,a as V}from"./stock_loc.Bj3C3Byx.js";import"./inv_log.D0BShjlW.js";import{p as z,a as D,b as Q}from"./index.uHoH2c2-.js";import{_ as U}from"./_plugin-vue_export-helper.BCo6x5W8.js";import"./uni-badge.CO78OwkC.js";import"./uni-datetime-picker.Bsu03if5.js";import"./date-format.Dm3Q97cL.js";const P=U({data:()=>({inbound_task:{},loc_nos:[],stock_loc_opts:[],invs:[],inv_plans:[],inv_plans_ex:[],inv_plans_preview:[],plan_form:{material_id:"",material_no:"",base_unit_name:"",decimal_unit:!1,pallet_infos:[]},step_options:[{title:"选择物料"},{title:"填写表单"},{title:"预览"},{title:"保存"}],step_active:0,goods_nav:{options:[{icon:"list",text:"物料"}],button_group:[{text:"返回",backgroundColor:t.state.goods_nav_color.grey,color:"#fff"},{text:"分配库位",backgroundColor:t.state.goods_nav_color.grey,color:"#fff"}]}}),onLoad(t){this.getOpenerEventChannel().on("sendInboundTask",(t=>{t.inbound_task?this.inbound_task=t.inbound_task:this.inbound_task=A.current(),this.load_data(t.material_no)}))},mounted(){M.query({FStockId:t.state.cur_stock.FStockId,FForbidStatus:"B"}).then((e=>{t.commit("update_stock_locs",e.data)}))},computed:{sum_pallet_qty(){let t=0;return this.plan_form.pallet_infos.forEach((e=>{e.per_qty&&e.pallet_qty&&(t+=Number(e.pallet_qty))})),t}},methods:{goods_nav_click(t){0===t.index&&this.$refs.material_drawer.open()},goods_nav_button_click(t){0===this.step_active||1===this.step_active?(0===t.index&&e(),1===t.index&&this.allocate_loc_no()):2===this.step_active?(0===t.index&&this.preview_close(),1===t.index&&this.submit_save()):3===this.step_active&&(0===t.index&&e(),1===t.index&&this.if_submit_delete())},allocate_loc_no(){if(console.log("this.$data",this.$data),2===this.step_active)return;if(!this.plan_form.material_no)return void a({icon:"none",title:"请先选择物料"});let t=this.inbound_task.inbound_list.find((t=>t.material_no==this.plan_form.material_no));this._sum_qty_of_pallet_info()===t.base_unit_qty?l({url:"/pages/operation/inbound/v2/allocate_loc_no_old",events:{allocateInfo:t=>{this.preview(t.allocate_info)}},success:t=>{z("success");let e=this.get_idle_stock_locs();t.eventChannel.emit("initStockLocs",{stock_locs:e,pallet_qty:this.sum_pallet_qty})}}):a({icon:"none",title:"物料数量不一致"})},material_no_click(t){this.$refs.material_drawer.close(),this.plan_form.material_no!=t&&(this.init_plan_form(t),z("success"))},preview(t){let e=[],a=JSON.parse(JSON.stringify(this.plan_form.pallet_infos));t.forEach((t=>{let l={loc_no:t.no,qty:0,pallet_infos:[]};for(let e of a)if(e.per_qty&&e.pallet_qty)for(;e.pallet_qty>0&&l.pallet_infos.length<t.plt_qty;)e.pallet_qty-=1,l.qty+=e.per_qty,l.pallet_infos.push(e.per_qty);e.push(l)})),this.inv_plans_preview=e,this._activate_step(2),z("success")},preview_close(){this.inv_plans_preview=[],this._activate_step(1),z("delete")},if_submit_delete(){i({title:"删除",content:"是否确定删除当前物料的全部计划明细？",success:t=>{t.confirm&&this.submit_delete()},fail:t=>{}})},add_pallet_info(){this.plan_form.pallet_infos.push({per_qty:"",pallet_qty:""})},del_pallet_info(t){this.plan_form.pallet_infos.splice(t,1)},validate_pallet_info(t,e,l){let i=Number(t.detail.value);i<=0?(e[l]="",i<0&&a({icon:"none",title:"数量必须大于0"})):e[l]=i},open_dialog(t){this.$refs[t].open()},op_loc_no_change(t){var e,a;D(null==(e=t.detail.value.slice(-1)[0])?void 0:e.value)?(a=this.plan_form).per_pallet_qty||(a.per_pallet_qty=2):this.plan_form.per_pallet_qty=0},async load_data(t=""){await this.load_invs(),await this.load_inv_plans(),await this.load_inv_plans_ex(),t&&this.init_plan_form(t)},async load_invs(){let e={FStockId:t.state.cur_stock.FStockId};return o({title:"Loading"}),R.get_all(e,{order:"FMaterialId.FNumber ASC, FStockLocId.FNumber ASC"}).then((t=>{this.$logger.info(">>> 加载库存，完毕"),s(),this.invs=t}))},async load_inv_plans(){return o({title:"Loading"}),V.query({FStockId:t.state.cur_stock.FStockId,FBillNo:this.inbound_task.bill_no,FOpType:"in"},{order:"FCreateTime ASC"}).then((e=>{this.$logger.info(">>> 加载入库计划，完毕"),s(),this.inv_plans=e.data,this.inv_plans.forEach((e=>{"A"!=e.FDocumentStatu&&(e.status=t.state.document_status_dict[e.FDocumentStatu])}))}))},async load_inv_plans_ex(){return o({title:"Loading"}),V.query({FStockId:t.state.cur_stock.FStockId,FBillNo_ne:this.inbound_task.bill_no,FOpType:"in",FDocumentStatu_in:["A","B"]},{order:"FCreateTime ASC"}).then((t=>{this.$logger.info(">>> 加载其余入库计划，完毕"),s(),this.inv_plans_ex=t.data}))},async submit_delete(){var t;if(3!==this.step_active)return;let e=this.inv_plans.filter((t=>t.FMaterialId===this.plan_form.material_id));if(e.some((t=>"A"!=t.FDocumentStatu)))return void a({icon:"none",title:"不能删除"});o({title:"Loading"});let l=await V.delete(e.map((t=>t.FID)));s(),l.data.Result.ResponseStatus.IsSuccess?(z("delete"),await this.load_inv_plans(),this.init_plan_form(this.plan_form.material_no)):a({icon:"none",title:null==(t=l.data.Result.ResponseStatus.Errors[0])?void 0:t.Message})},async submit_save(){if(2!==this.step_active)return;o({title:"Loading"});let e=this.inbound_task.inbound_list.find((t=>t.material_no==this.plan_form.material_no));for(let a=0;a<this.inv_plans_preview.length;a++){let l=this.inv_plans_preview[a],i=new V({FOpType:"in",FStockId:t.state.cur_stock.FStockId,FStockLocNo:l.loc_no,FMaterialId:e.material_id,FOpQTY:1*l.qty,FBatchNo:e.batch_no,FBillNo:this.inbound_task.bill_no,FOpStaffNo:t.state.cur_staff.FNumber,FRemark:l.pallet_infos.join(","),FPalletQty:l.pallet_infos.length});await i.save()}s(),z("success"),await this.load_inv_plans(),this._activate_step(3),n({scrollTop:0})},get_idle_stock_locs(){let e=[];return t.state.stock_locs.forEach((t=>{e.push({...t,idle:this._is_idle(t.FNumber)})})),e},init_plan_form(t){o({title:"初始化表单"});let e=this.inbound_task.inbound_list.find((e=>e.material_no==t));this.plan_form.pallet_infos=[{per_qty:"",pallet_qty:""}],e?(this.plan_form.material_id=e.material_id,this.plan_form.material_no=e.material_no,this.plan_form.base_unit_name=e.base_unit_name,this.plan_form.decimal_unit=Q(e.base_unit_name),"pallet"==this.inbound_task.category&&this._set_pallet_infos(t),this.inv_plans.some((t=>t.FMaterialId===e.material_id))?this._activate_step(3):this._activate_step(1)):(this.plan_form.material_id="",this.plan_form.material_no="",this.plan_form.base_unit_name="Pcs",this.plan_form.decimal_unit=!1,this._activate_step(0)),s()},_set_pallet_infos(t){let e=[];this.inbound_task.pallet_infos.forEach((a=>{if(a.material_no==t){let t=e.find((t=>t.per_qty==a.base_unit_qty));t?t.pallet_qty+=1:e.push({per_qty:a.base_unit_qty,pallet_qty:1})}})),e.length&&(this.plan_form.pallet_infos=e)},_is_idle(e){return!t.state.stock_locs.find((t=>t.FNumber==e&&"B"==t.FForbidStatus))&&(!D(e)||!this.invs.some((t=>t["FStockLocId.FNumber"]==e))&&!this.inv_plans.some((t=>t["FStockLocId.FNumber"]==e))&&!this.inv_plans_ex.some((t=>t["FStockLocId.FNumber"]==e)))},_activate_step(e){this.step_active=e,0===e?(this.goods_nav.button_group[1].text="分配库位",this.goods_nav.button_group[1].backgroundColor=t.state.goods_nav_color.grey):1===e?(this.goods_nav.button_group[1].text="分配库位",this.goods_nav.button_group[1].backgroundColor=t.state.goods_nav_color.yellow):2===e?(this.goods_nav.button_group[1].text="保存",this.goods_nav.button_group[1].backgroundColor=t.state.goods_nav_color.blue):3===e&&(this.goods_nav.button_group[1].text="删除",this.goods_nav.button_group[1].backgroundColor=t.state.goods_nav_color.red)},_sum_inv_plan_op_qty(){let t=0;return this.inv_plans.forEach((e=>{e.FMaterialId===this.plan_form.material_id&&(t+=e.FOpQTY)})),t},_sum_qty_of_pallet_info(){let t=0;return this.plan_form.pallet_infos.forEach((e=>{e.per_qty&&e.pallet_qty&&(t+=Number(e.per_qty)*Number(e.pallet_qty))})),t}}},[["render",function(t,e,a,l,i,o){const s=x(_("uni-steps"),w),n=f,A=g,M=x(_("uni-list-item"),S),R=x(_("uni-list"),I),V=x(_("uni-section"),C),z=x(_("uni-th"),j),D=x(_("uni-tr"),N),Q=x(_("uni-easyinput"),B),U=x(_("uni-td"),$),P=x(_("uni-icons"),L),J=x(_("uni-table"),T),Y=F,G=x(_("uni-goods-nav"),O),H=q,K=x(_("uni-drawer"),E);return h(),r(m,null,[u(V,{title:"新增计划明细",type:"square","sub-title":i.inbound_task.bill_no,"sub-title-color":"#007aff"},{default:p((()=>[u(s,{options:i.step_options,active:i.step_active,class:"uni-mt-5 uni-mb-5"},null,8,["options","active"]),i.plan_form.material_no?(h(),d(R,{key:0},{default:p((()=>[(h(!0),r(m,null,b(i.inbound_task.inbound_list,((a,l)=>(h(),r(m,{key:l},[a.material_no==i.plan_form.material_no&&a.dest_stock_id==t.$store.state.cur_stock.FStockId?(h(),d(M,{key:0,"right-text":[a.base_unit_qty,a.base_unit_name].join(" "),onClick:e[0]||(e[0]=e=>t.$refs.material_drawer.open()),clickable:"","show-arrow":""},{body:p((()=>[u(n,{class:"uni-list-item__body"},{default:p((()=>[u(n,{class:"title"},{default:p((()=>[v(y(a.material_no),1)])),_:2},1024),u(n,{class:"note"},{default:p((()=>[u(n,null,{default:p((()=>[v("名称："+y(a.material_name),1)])),_:2},1024),u(n,null,{default:p((()=>[v("规格："+y(a.material_spec),1)])),_:2},1024),u(n,null,{default:p((()=>[v("调入仓库："),u(A,{class:"text-primary"},{default:p((()=>[v(y(a.dest_stock_name),1)])),_:2},1024)])),_:2},1024),u(n,null,{default:p((()=>[v("批次："+y(a.batch_no),1)])),_:2},1024)])),_:2},1024)])),_:2},1024)])),_:2},1032,["right-text"])):c("",!0)],64)))),128))])),_:1})):(h(),d(R,{key:1},{default:p((()=>[u(M,{"show-extra-icon":!0,"extra-icon":{type:"list",size:"24",color:"#007bff"},title:"点击选择物料",onClick:e[1]||(e[1]=e=>t.$refs.material_drawer.open()),clickable:"","show-arrow":""})])),_:1}))])),_:1},8,["sub-title"]),1===i.step_active?(h(),d(V,{key:0,title:"填写托盘信息",type:"square","sub-title":"‌‌总和 = ∑ (每托数量 x 托数)"},{right:p((()=>[u(n,{class:"uni-section__right"},{default:p((()=>[u(n,null,{default:p((()=>[v(" 总和： "),u(A,{class:"sum_qty"},{default:p((()=>[v(y(o._sum_qty_of_pallet_info()),1)])),_:1}),v(" "+y(i.plan_form.base_unit_name),1)])),_:1})])),_:1})])),default:p((()=>[u(n,{class:"container"},{default:p((()=>[u(J,{ref:"pallet_infos",border:"",stripe:"",class:"pallet-infos"},{default:p((()=>[u(D,null,{default:p((()=>[u(z,{align:"center",width:"150"},{default:p((()=>[v("每托数量")])),_:1}),u(z,{align:"center",width:"150"},{default:p((()=>[v("托数")])),_:1}),u(z,{align:"center",width:"50"})])),_:1}),(h(!0),r(m,null,b(i.plan_form.pallet_infos,((t,e)=>(h(),d(D,{key:e},{default:p((()=>[u(U,{align:"center"},{default:p((()=>[u(Q,{type:"number",clearable:!1,"input-border":!1,modelValue:t.per_qty,"onUpdate:modelValue":e=>t.per_qty=e,onBlur:e=>o.validate_pallet_info(e,t,"per_qty"),style:{"text-align":"center"}},null,8,["modelValue","onUpdate:modelValue","onBlur"])])),_:2},1024),u(U,{align:"center"},{default:p((()=>[u(Q,{type:"number",clearable:!1,"input-border":!1,modelValue:t.pallet_qty,"onUpdate:modelValue":e=>t.pallet_qty=e,onBlur:e=>o.validate_pallet_info(e,t,"pallet_qty"),style:{"text-align":"center"}},null,8,["modelValue","onUpdate:modelValue","onBlur"])])),_:2},1024),u(U,{align:"center"},{default:p((()=>[i.plan_form.pallet_infos.length>1?(h(),d(P,{key:0,type:"minus",size:"24",color:"#dd524d",disabled:"",onClick:t=>o.del_pallet_info(e)},null,8,["onClick"])):c("",!0)])),_:2},1024)])),_:2},1024)))),128))])),_:1},512),i.plan_form.pallet_infos.length<5?(h(),d(Y,{key:0,type:"primary",onClick:o.add_pallet_info,class:"add-pallet-info-btn"},{default:p((()=>[v(" + 新增托盘规格 ")])),_:1},8,["onClick"])):c("",!0)])),_:1})])),_:1})):c("",!0),2===i.step_active?(h(),d(V,{key:1,title:"预览计划明细",type:"square","sub-title":"预览确认无误后，请保存计划",class:"above-uni-goods-nav"},{right:p((()=>[u(n,{class:"uni-section__right"},{default:p((()=>[u(P,{type:"closeempty",size:"24",color:"#333",onClick:o.preview_close},null,8,["onClick"])])),_:1})])),default:p((()=>[u(R,null,{default:p((()=>[(h(!0),r(m,null,b(i.inv_plans_preview,((t,e)=>(h(),d(M,{key:e,"show-extra-icon":!0,"extra-icon":{type:"arrow-up",size:"24",color:"#dd524d"},title:t.loc_no,note:`${t.pallet_infos.length} 托 (${t.pallet_infos.join(", ")})`,"right-text":`${t.qty} ${this.plan_form.base_unit_name}`},null,8,["title","note","right-text"])))),128))])),_:1})])),_:1})):c("",!0),3===i.step_active?(h(),d(V,{key:2,title:"当前计划明细",type:"square",class:"above-uni-goods-nav"},{right:p((()=>[u(n,{class:"uni-section__right"},{default:p((()=>[u(n,null,{default:p((()=>[v(" 总和： "),u(A,{class:"sum_qty"},{default:p((()=>[v(y(o._sum_inv_plan_op_qty()),1)])),_:1}),v(" "+y(i.plan_form.base_unit_name),1)])),_:1})])),_:1})])),default:p((()=>[u(R,null,{default:p((()=>[(h(!0),r(m,null,b(i.inv_plans.filter((t=>t.FMaterialId===i.plan_form.material_id)),((t,e)=>(h(),d(M,{key:e,"show-extra-icon":!0,"extra-icon":{type:"arrow-up",size:"24",color:"#dd524d"},title:t["FStockLocId.FNumber"],note:`${t.FPalletQty} 托(${t.FRemark})`},{footer:p((()=>[u(n,{class:"uni-list-item__foot"},{default:p((()=>[u(A,{class:"op_qty"},{default:p((()=>[v(y(t.FOpQTY)+" "+y(t["FStockUnitId.FName"]),1)])),_:2},1024),u(A,{class:"status"},{default:p((()=>[v(y(t.status),1)])),_:2},1024)])),_:2},1024)])),_:2},1032,["title","note"])))),128))])),_:1})])),_:1})):c("",!0),u(n,{class:"uni-goods-nav-wrapper"},{default:p((()=>[u(G,{options:i.goods_nav.options,"button-group":i.goods_nav.button_group,fill:t.$store.state.goods_nav_fill,onClick:o.goods_nav_click,onButtonClick:o.goods_nav_button_click},null,8,["options","button-group","fill","onClick","onButtonClick"])])),_:1}),u(K,{ref:"material_drawer",width:t.$store.state.drawer_width},{default:p((()=>[u(H,{"scroll-y":"",style:{height:"100%"},onTouchmove:e[3]||(e[3]=k((()=>{}),["stop"]))},{default:p((()=>[u(V,{title:"入库物料列表",type:"square","sub-title":"点击切换当前物料"},{right:p((()=>[u(n,{class:"uni-section__right"},{default:p((()=>[u(P,{type:"closeempty",size:"20",color:"#333",onClick:e[2]||(e[2]=e=>t.$refs.material_drawer.close())})])),_:1})])),default:p((()=>[u(R,null,{default:p((()=>[(h(!0),r(m,null,b(i.inbound_task.inbound_list,((e,a)=>(h(),r(m,{key:a},[e.dest_stock_id==t.$store.state.cur_stock.FStockId?(h(),d(M,{key:0,"right-text":[e.base_unit_qty,e.base_unit_name].join(" "),onClick:t=>o.material_no_click(e.material_no),clickable:"","show-arrow":""},{body:p((()=>[u(n,{class:"uni-list-item__body"},{default:p((()=>[u(n,{class:"title"},{default:p((()=>[this.plan_form.material_no==e.material_no?(h(),d(P,{key:0,type:"checkbox-filled",color:"#007aff"})):c("",!0),v(" "+y(e.material_no),1)])),_:2},1024),u(n,{class:"note"},{default:p((()=>[u(n,null,{default:p((()=>[v("名称："+y(e.material_name),1)])),_:2},1024),u(n,null,{default:p((()=>[v("规格："+y(e.material_spec),1)])),_:2},1024)])),_:2},1024)])),_:2},1024)])),_:2},1032,["right-text","onClick"])):c("",!0)],64)))),128))])),_:1})])),_:1})])),_:1})])),_:1},8,["width"])],64)}],["__scopeId","data-v-d07a2db7"]]);export{P as default};
