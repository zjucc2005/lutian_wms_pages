import{s as t,x as o,p as e,n as a,b as n,v as s,c as i,d as u,w as r,i as _,o as l,e as m,f as c,t as d,q as f,u as h,F as p,k as F}from"./index-DsK9pIyj.js";import{_ as b}from"./uni-easyinput.BfazFYzq.js";import{r as g}from"./uni-app.es.CSK8ITuj.js";import{_ as k,a as v}from"./uni-forms.DoSYlyoS.js";import{_ as I}from"./uni-section.BpQrEx4g.js";import{_ as y}from"./uni-list-item.BkmqxiQh.js";import{_ as N,a as S}from"./uni-swipe-action.BTWqdF-e.js";import{_ as x}from"./uni-goods-nav.BN-nj5na.js";import{a as j}from"./index.DEl4oXeA.js";import{d as C,i as q,a as B,b as O}from"./index.uHoH2c2-.js";import"./k3cloudapi.PCDjx1SF.js";import{I as T,S as V}from"./stock_loc.Bj3C3Byx.js";import{I as M}from"./inv_log.D0BShjlW.js";import{f as w}from"./date-format.Dm3Q97cL.js";import{s as D}from"./scan_code.CGa79-3n.js";import{_ as E}from"./_plugin-vue_export-helper.BCo6x5W8.js";import"./uni-icons.DRoE6XYp.js";import"./uni-badge.CO78OwkC.js";import"./bd_empinfo.DSF0B_p6.js";const U=E({data(){return{cur_stock:{},cur_staff:{},cur_outbound_task:{},invs:[],inv_logs:[],stock_locs:[],bd_materials:[],unmount_form:{material_no:"",material_name:"",material_spec:"",loc_no:"",op_qty:"",base_unit:"Pcs",base_unit_name:"Pcs",decimal_unit:!1,remark:""},unmount_form_rules:{material_no:{rules:[{required:!0,errorMessage:"物料编号不能为空"},{validateFunction:(t,o,e,a)=>{let n=o,s=this.cur_stock.FUseOrgId,i=this.bd_materials.find((t=>t.FNumber==n));return i?"C"!=i.FDocumentStatus?a("此物料编码未审核"):"A"!=i.FForbidStatus?a("此物料编码被禁用"):void 0:j(n,s).then((t=>t.data[0]?(i=t.data[0],this.bd_materials.some((t=>t.FNumber==n))||this.bd_materials.push(t.data[0]),"C"!=i.FDocumentStatus?a("此物料编码未审核"):"A"!=i.FForbidStatus?a("此物料编码被禁用"):i):a("不存在此物料编码")))}}]},loc_no:{rules:[{required:!0,errorMessage:"库位号不能为空"},{validateFunction:(t,o,e,a)=>{let n=this.stock_locs.find((t=>t.FNumber==o));return n?"C"!=n.FDocumentStatus?a("此库位号未审核"):void 0:a("不存在此库位号")}}]},op_qty:{rules:[{required:!0,errorMessage:"下架数量不能为空"},{format:"number",errorMessage:"下架数量只能输入数字"},{validateFunction:(t,o,e,a)=>o<=0?a("下架数量必须大于0"):this.unmount_form.decimal_unit||Number.isInteger(o)?T.query({FStockId:this.cur_stock.FStockId,"FMaterialId.FNumber":this.unmount_form.material_no,"FStockLocId.FNumber":this.unmount_form.loc_no,FQty_gt:0},{order:"FBatchNo ASC"}).then((t=>{this.invs=t.data;let e=0;if(t.data.forEach((t=>e+=t.FQty)),e<o)return a("此库位号库存数量不足")})):a("下架数量必须为整数")}]}},log_options:[{text:"取消",style:{backgroundColor:"#f56c6c"}}],goods_nav:{options:[{icon:"more-filled",text:"更多"}],button_group:[{text:"扫码",backgroundColor:"linear-gradient(90deg, #FE6035, #EF1224)",color:"#fff"},{text:"提交下架",backgroundColor:"linear-gradient(90deg, #1E83FF, #0053B8)",color:"#fff"}]}}},mounted(){this.cur_stock=t.state.cur_stock,this.cur_staff=t.state.cur_staff,this.cur_outbound_task=o("cur_outbound_task"),M.query({FStockId:this.cur_stock.FStockId,FBillNo:this.cur_outbound_task.bill_no,FOpType_in:["out","out_cl"]},{page:1,per_page:5,order:"FCreateTime DESC"}).then((t=>{t.data.reverse().forEach((t=>this.unshift_inv_log(t)))})),V.query({FStockId:this.cur_stock.FStockId}).then((t=>{this.stock_locs=t.data}))},methods:{describe_inv_log:C,formatDate:w,goods_nav_click(t){0===t.index&&this.more_actions()},goods_nav_button_click(t){0===t.index&&this.scan_code(),1===t.index&&this.submit_unmount()},swipe_action_click(t,o){0===t.index&&this.cancel_unmount(o)},more_actions(){e({itemList:["出库详情","操作日志"],success:t=>{0===t.tapIndex&&a({url:"/pages/operation/outbound/v1/task"}),1===t.tapIndex&&a({url:"/pages/operation/outbound/v1/logs"})}})},scan_code(){D().then((t=>{this.handle_scan_code(t.result)})).catch((t=>{n({icon:"none",title:t})}))},handle_scan_code(t){q(t)?(this.unmount_form.material_no=t,this.handle_material_no_change()):B(t)?this.unmount_form.loc_no=t:this.unmount_form.material_no?this.unmount_form.loc_no||(this.unmount_form.loc_no=t):(this.unmount_form.material_no=t,this.handle_material_no_change())},submit_unmount(){this.$refs.unmount_form.validate().then((t=>{this.auto_allocate(),this.invs.filter((t=>t.checked)).forEach((t=>{new M({FOpType:"out",FStockId:t.FStockId,FStockLocNo:t["FStockLocId.FNumber"],FMaterialId:t.FMaterialId,FOpQTY:t.checked_qty,FBatchNo:t.FBatchNo,FBillNo:this.cur_outbound_task.bill_no,FOpStaffNo:this.cur_staff.FNumber}).save().then((t=>{this.after_save(t),this.reset_form()}))}))})).catch((t=>{}))},cancel_unmount(t){let o=this.inv_logs.find((o=>o.FID===t));if("out"!=o.FOpType||o.status)n({icon:"error",title:"ERROR"});else{new M({FOpType:"out_cl",FStockId:o.FStockId,FStockLocNo:o["FStockLocId.FNumber"],FMaterialId:o.FMaterialId,FOpQTY:o.FOpQTY,FBatchNo:o.FBatchNo,FBillNo:o.FBillNo,FOpStaffNo:this.cur_staff.FNumber,FReferId:o.FID}).save().then((t=>{this.after_save(t),this.$refs.inv_log_swipe.closeAll()}))}},handle_material_no_change(){let t=this.unmount_form.material_no;if(!t)return void this.set_base_unit();let o=this.cur_stock.FUseOrgId,e=this.bd_materials.find((o=>o.FNumber==t));e?this.set_base_unit(e):j(t,o).then((o=>{o.data[0]?(e=o.data[0],this.bd_materials.some((o=>o.FNumber==t))||this.bd_materials.push(o.data[0]),this.set_base_unit(e)):this.set_base_unit()}))},set_base_unit(t){t?(this.unmount_form.material_name=t.FName,this.unmount_form.material_spec=t.FSpecification,this.unmount_form.base_unit=t["FBaseUnitId.FNumber"],this.unmount_form.base_unit_name=t["FBaseUnitId.FName"],this.unmount_form.decimal_unit=O(t["FBaseUnitId.FName"])):(this.unmount_form.material_name="",this.unmount_form.material_spec="",this.unmount_form.base_unit="Pcs",this.unmount_form.base_unit_name="Pcs",this.unmount_form.decimal_unit=!1)},reset_form(){this.unmount_form={material_no:"",material_name:"",material_spec:"",loc_no:"",op_qty:"",base_unit:"Pcs",base_unit_name:"Pcs",decimal_unit:!1,remark:""},s({scrollTop:0})},after_save(t){t.data.Result.ResponseStatus.IsSuccess?M.find(t.data.Result.Id).then((t=>{t.data[0]&&(this.unshift_inv_log(t.data[0]),n({title:"提交成功"}))})):n({title:"提交失败"})},unshift_inv_log(t){if("out_cl"==t.FOpType){let o=this.inv_logs.find((o=>o.FID===t.FReferId));o&&(o.status="已取消")}this.inv_logs.unshift(t),this.inv_logs.length>5&&(this.inv_logs=this.inv_logs.slice(0,5))},auto_allocate(){let t=this.unmount_form.op_qty,o=0;this.invs.forEach((e=>{if(o<t){let a=Math.min(e.FQty,t-o);e.checked=!0,e.checked_qty=a,o+=a}})),this.$logger.info("auto_allocate res",this.invs.filter((t=>t.checked)))}}},[["render",function(t,o,e,a,n,s){const j=g(i("uni-easyinput"),b),C=g(i("uni-forms-item"),k),q=F,B=g(i("uni-forms"),v),O=_,T=g(i("uni-section"),I),V=g(i("uni-list-item"),y),M=g(i("uni-swipe-action-item"),N),w=g(i("uni-swipe-action"),S),D=g(i("uni-goods-nav"),x);return l(),u(O,null,{default:r((()=>[m(T,{title:"下架",type:"line","sub-title":n.unmount_form.material_name?[n.unmount_form.material_name,n.unmount_form.material_spec].join("\n"):["-","-"].join("\n")},{default:r((()=>[m(O,{class:"container"},{default:r((()=>[m(B,{ref:"unmount_form",model:n.unmount_form,rules:n.unmount_form_rules,labelWidth:"80px"},{default:r((()=>[m(C,{label:"物料编号",name:"material_no",required:""},{default:r((()=>[m(j,{modelValue:n.unmount_form.material_no,"onUpdate:modelValue":o[0]||(o[0]=t=>n.unmount_form.material_no=t),trim:"both",onChange:s.handle_material_no_change,onClear:s.handle_material_no_change},null,8,["modelValue","onChange","onClear"])])),_:1}),m(C,{label:"库位号",name:"loc_no",required:""},{default:r((()=>[m(j,{modelValue:n.unmount_form.loc_no,"onUpdate:modelValue":o[1]||(o[1]=t=>n.unmount_form.loc_no=t),trim:"both"},null,8,["modelValue"])])),_:1}),m(C,{label:"下架数量",name:"op_qty",required:""},{default:r((()=>[m(j,{modelValue:n.unmount_form.op_qty,"onUpdate:modelValue":o[2]||(o[2]=t=>n.unmount_form.op_qty=t),type:"number"},{right:r((()=>[m(q,{class:"easyinput-suffix-text"},{default:r((()=>[c(d(n.unmount_form.base_unit_name),1)])),_:1})])),_:1},8,["modelValue"])])),_:1}),m(C,{label:"备注",name:"remark"},{default:r((()=>[m(j,{modelValue:n.unmount_form.remark,"onUpdate:modelValue":o[3]||(o[3]=t=>n.unmount_form.remark=t),trim:"both"},null,8,["modelValue"])])),_:1})])),_:1},8,["model","rules"])])),_:1})])),_:1},8,["sub-title"]),m(T,{title:"最近操作日志",type:"line",style:{"padding-bottom":"60px"}},{default:r((()=>[m(w,{ref:"inv_log_swipe"},{default:r((()=>[(l(!0),f(p,null,h(n.inv_logs,((t,o)=>(l(),u(M,{key:o,threshold:60,"right-options":"out"!=t.FOpType||t.status?[]:n.log_options,onClick:o=>s.swipe_action_click(o,t.FID)},{default:r((()=>[m(V,{title:s.formatDate(t.FCreateTime,"yyyy-MM-dd hh:mm:ss"),note:s.describe_inv_log(t),rightText:t.status},{footer:r((()=>[m(q,{class:"uni-list-item-right-text"},{default:r((()=>[c(d(t.status),1)])),_:2},1024)])),_:2},1032,["title","note","rightText"])])),_:2},1032,["right-options","onClick"])))),128))])),_:1},512)])),_:1}),m(O,{class:"uni-goods-nav-wrapper"},{default:r((()=>[m(D,{options:n.goods_nav.options,"button-group":n.goods_nav.button_group,onClick:s.goods_nav_click,onButtonClick:s.goods_nav_button_click},null,8,["options","button-group","onClick","onButtonClick"])])),_:1})])),_:1})}]]);export{U as default};
