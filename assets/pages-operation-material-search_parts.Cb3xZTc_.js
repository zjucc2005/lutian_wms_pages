import{s as e,aD as a,aE as t,b as r,a as l,h as s,c as o,q as i,F as _,e as c,w as m,g as d,d as n,i as h,o as u,u as f,f as p,t as g,k as b}from"./index-MIvYX1nW.js";import{_ as k}from"./uni-notice-bar.BrdymbPY.js";import{r as F}from"./uni-app.es.B8zr0lZI.js";import{_ as v}from"./uni-easyinput.BboSH9MB.js";import{_ as y,a as I}from"./uni-forms.C-YkALHf.js";import{_ as M}from"./uni-data-select.7wY52LM_.js";import{_ as V}from"./uni-section.C7O4oyAr.js";import{_ as C}from"./uni-data-picker.7TlEDIWg.js";import{_ as j}from"./uni-load-more.5aGCwx5G.js";import{_ as x}from"./uni-icons.DEYikQDp.js";import{_ as N}from"./uni-goods-nav.DSaXBg-u.js";import{K as U}from"./k3cloudapi.DzDu3BGl.js";import{B as w}from"./bd_material.CFPy7Ij-.js";import{E as B}from"./eng_bom.Cg1RpB00.js";import"./stock_loc.BckAHwoS.js";import"./inv_log.BJcJnepW.js";import{S}from"./stk_inventory.CzYeWlA0.js";import{s as L}from"./scan_code.bSbj3X8t.js";import{_ as q}from"./_plugin-vue_export-helper.BCo6x5W8.js";const O=q({data:()=>({step:"search",search_form:{material_no:"",material_name:"",material_spec:"",material_category_id:"",use_org_id:e.state.cur_stock.FUseOrgId,child_material_no:"",child_material_name:"",child_material_spec:"",child_stock_id:""},search_form_rules:{material_no:{rules:[{minLength:4,errorMessage:"物料编码不能少于4个字符"}]},material_name:{rules:[{minLength:2,errorMessage:"物料名称不能少于2个字符"}]},material_spec:{rules:[{minLength:4,errorMessage:"规格型号不能少于4个字符"}]},child_material_no:{rules:[{minLength:4,errorMessage:"物料编码不能少于4个字符"}]},child_material_name:{rules:[{required:!0,errorMessage:"物料名称不能为空"},{minLength:2,errorMessage:"物料名称不能少于2个字符"}]},child_material_spec:{rules:[{minLength:4,errorMessage:"规格型号不能少于4个字符"}]}},search_res:[],tree_data:[],stk_inventory:{},material_categories:[],goods_nav:{options:[{icon:"clear",text:"重置"}],button_group:[{text:"搜索",color:"#fff",backgroundColor:e.state.goods_nav_color.blue}]}}),onShow(){let e=this;a("navigateBack",{invoke:a=>"show"!=e.step||(e.activate_step("search"),!1)})},onHide(){t("navigateBack")},mounted(){this.load_bd_materialcategories()},methods:{activate_step(a){this.step=a,"search"==a&&(this.goods_nav.options[0]={icon:"clear",text:"清空"},this.goods_nav.button_group[0]={text:"搜索",color:"#fff",backgroundColor:e.state.goods_nav_color.blue}),"show"==a&&(this.goods_nav.options[0]={icon:"left",text:"返回"},this.goods_nav.button_group[0]={text:"返回",color:"#fff",backgroundColor:e.state.goods_nav_color.grey})},clear(){this.search_form.material_no="",this.search_form.material_name="",this.search_form.material_spec="",this.search_form.material_category_id="",this.search_form.use_org_id=e.state.cur_stock.FUseOrgId,this.search_form.child_material_no="",this.search_form.child_material_name="",this.search_form.child_material_spec="",this.search_form.child_stock_id=""},goods_nav_click(e){0===e.index&&("search"==this.step&&this.clear(),"show"==this.step&&this.activate_step("search"))},goods_nav_button_click(e){0===e.index&&("search"==this.step&&this.search(),"show"==this.step&&this.activate_step("search"))},scan_code(e){L().then((a=>{this.search_form[e]=a.result})).catch((e=>{r({icon:"none",title:e})}))},async search(){var e,a;try{await this.$refs.search_form.validate();let t={FForbidStatus:"A"};this.search_form.material_no&&(t["FMaterialId.FNumber_lk"]=this.search_form.material_no),this.search_form.material_name&&(t["FMaterialId.FName_lk"]=this.search_form.material_name),this.search_form.material_spec&&(t.FItemModel_lk=this.search_form.material_spec),this.search_form.material_category_id&&(t["FMaterialId.FCategoryId"]=this.search_form.material_category_id),this.search_form.use_org_id&&(t.FUseOrgId=this.search_form.use_org_id),this.search_form.child_material_no&&(t["FMaterialIdChild.FNumber_lk"]=this.search_form.child_material_no),this.search_form.child_material_name&&(t["FMaterialIdChild.FName_lk"]=this.search_form.child_material_name),this.search_form.child_material_spec&&(t.FChildItemModel_lk=this.search_form.child_material_spec),l({title:"查询BOM..."});let o=await B.query(t,{});if(s(),(null==(e=o.data)?void 0:e.Result)&&!o.data.Result.ResponseStatus.IsSuccess)return void r({icon:"none",title:null==(a=o.data.Result.ResponseStatus.Errors[0])?void 0:a.Message,duration:3e3});if(o.data.length>1e3)return void r({icon:"none",title:"查询超时",duration:3e3});l({title:"查询库存..."});for(let e of o.data){let a=e["FMaterialIdChild.FNumber"];if(!this.stk_inventory[a]){let e={"FMaterialId.FNumber":a};this.search_form.child_stock_id&&(e.FStockId=this.search_form.child_stock_id);let t=await S.query(e),r=[];for(let a of t.data){let e=r.find((e=>e.FStockId==a.FStockId));e?e.FBaseQty+=a.FBaseQty:r.push(a)}this.stk_inventory[a]=r}}s();let i=[];if(this.search_form.child_stock_id)for(let e of o.data)this.stk_inventory[e["FMaterialIdChild.FNumber"]].length&&i.push(e);else i=o.data;this.search_res=i;let _=[];for(let e of i){let a={material_id:e.FMaterialIdChild,material_no:e["FMaterialIdChild.FNumber"],material_name:e["FMaterialIdChild.FName"],material_spec:e.FChildItemModel,unit_id:e.FChildUnitId,unit_name:e["FChildUnitId.FName"]},t=_.find((a=>a.bom_id==e.FID));t?t.children.push(a):_.push({bom_id:e.FID,bom_no:e.FNumber,material_id:e.FMaterialId,material_no:e["FMaterialId.FNumber"],material_name:e["FMaterialId.FName"],material_spec:e.FItemModel,use_org_id:e.FUseOrgId,use_org_name:e["FUseOrgId.FName"],open:!0,children:[a]})}this.tree_data=_,this.activate_step("show")}catch(t){this.$logger.info("search err",t)}},async load_bd_materialcategories(){var a;(null==(a=e.state.bd_materialcategories)?void 0:a.length)||(l({title:"Loading"}),await w.categories().then((a=>{s(),e.commit("set_bd_materialcategories",a.data)}))),this.material_categories=e.state.bd_materialcategories.map((e=>({value:e.FName,text:e.FName})))},_thumbnail_url:e=>U.thumbnail_url(e)}},[["render",function(e,a,t,r,l,s){const U=F(o("uni-notice-bar"),k),w=F(o("uni-easyinput"),v),B=F(o("uni-forms-item"),y),S=F(o("uni-data-select"),M),L=h,q=F(o("uni-section"),V),O=F(o("uni-data-picker"),C),$=F(o("uni-forms"),I),R=F(o("uni-load-more"),j),D=b,E=F(o("uni-icons"),x),z=F(o("uni-goods-nav"),N);return u(),i(_,null,["search"==l.step?(u(),i(_,{key:0},[c(U,{single:"",scrollable:"",text:"请尽可能提供详细的查询条件,查询范围过大时,可能会超时导致失败,模糊查找时 %(百分号) 可以代替任意数个字符"}),c($,{ref:"search_form",model:l.search_form,rules:l.search_form_rules,labelWidth:"70px"},{default:m((()=>[c(q,{title:"整机信息",type:"square"},{default:m((()=>[c(L,{class:"container"},{default:m((()=>[c(B,{label:"编码",name:"material_no"},{default:m((()=>[c(w,{modelValue:l.search_form.material_no,"onUpdate:modelValue":a[0]||(a[0]=e=>l.search_form.material_no=e),trim:"both","prefix-icon":"scan",onIconClick:a[1]||(a[1]=e=>s.scan_code("material_no"))},null,8,["modelValue"])])),_:1}),c(B,{label:"名称",name:"material_name"},{default:m((()=>[c(w,{modelValue:l.search_form.material_name,"onUpdate:modelValue":a[2]||(a[2]=e=>l.search_form.material_name=e),trim:"both"},null,8,["modelValue"])])),_:1}),c(B,{label:"规格",name:"material_spec"},{default:m((()=>[c(w,{modelValue:l.search_form.material_spec,"onUpdate:modelValue":a[3]||(a[3]=e=>l.search_form.material_spec=e),trim:"both"},null,8,["modelValue"])])),_:1}),c(B,{label:"存货类别",name:"material_category_id"},{default:m((()=>[c(S,{modelValue:l.search_form.material_category_id,"onUpdate:modelValue":a[4]||(a[4]=e=>l.search_form.material_category_id=e),localdata:l.material_categories},null,8,["modelValue","localdata"])])),_:1}),c(B,{label:"使用组织",name:"use_org_id"},{default:m((()=>[c(S,{modelValue:l.search_form.use_org_id,"onUpdate:modelValue":a[5]||(a[5]=e=>l.search_form.use_org_id=e),localdata:e.$store.state.bd_stock_opts},null,8,["modelValue","localdata"])])),_:1})])),_:1})])),_:1}),c(q,{title:"配件信息",type:"square"},{default:m((()=>[c(L,{class:"container"},{default:m((()=>[c(B,{label:"编码",name:"child_material_no"},{default:m((()=>[c(w,{modelValue:l.search_form.child_material_no,"onUpdate:modelValue":a[6]||(a[6]=e=>l.search_form.child_material_no=e),trim:"both","prefix-icon":"scan",onIconClick:a[7]||(a[7]=e=>s.scan_code("child_material_no"))},null,8,["modelValue"])])),_:1}),c(B,{label:"名称",name:"child_material_name"},{default:m((()=>[c(w,{modelValue:l.search_form.child_material_name,"onUpdate:modelValue":a[8]||(a[8]=e=>l.search_form.child_material_name=e),trim:"both"},null,8,["modelValue"])])),_:1}),c(B,{label:"规格",name:"child_material_spec"},{default:m((()=>[c(w,{modelValue:l.search_form.child_material_spec,"onUpdate:modelValue":a[9]||(a[9]=e=>l.search_form.child_material_spec=e),trim:"both"},null,8,["modelValue"])])),_:1}),c(B,{label:"库存仓库"},{default:m((()=>[c(O,{ref:"stock_id_data_picker",modelValue:l.search_form.child_stock_id,"onUpdate:modelValue":a[10]||(a[10]=e=>l.search_form.child_stock_id=e),localdata:e.$store.state.bd_stock_opts,"popup-title":"请选择配件仓库"},null,8,["modelValue","localdata"])])),_:1})])),_:1})])),_:1})])),_:1},8,["model","rules"])],64)):d("",!0),"show"==l.step?(u(),n(q,{key:1,title:`搜索结果 ${l.search_res.length} 条`,"sub-title":"库存数据取自金蝶即时库存",type:"square",class:"above-uni-goods-nav"},{default:m((()=>[c(L,{class:"container"},{default:m((()=>[0===l.tree_data.length?(u(),n(R,{key:0,status:"nomore"})):d("",!0),(u(!0),i(_,null,f(l.tree_data,((a,t)=>(u(),n(L,{key:t,class:"cc-tree-card"},{default:m((()=>[c(L,{class:"cc-tree-card-item"},{default:m((()=>[c(L,{class:"cc-tree-card-item__section"},{default:m((()=>[c(L,{class:"cc-tree-card-item__card"},{default:m((()=>[c(L,{class:"cc-tree-card-item__body"},{default:m((()=>[c(L,{class:"title"},{default:m((()=>[p(g(a.material_no)+" / ",1),c(D,{class:"text-primary"},{default:m((()=>[p(g(a.bom_no),1)])),_:2},1024)])),_:2},1024),c(L,{class:"note"},{default:m((()=>[p("名称："+g(a.material_name),1)])),_:2},1024),c(L,{class:"note"},{default:m((()=>[p("规格："+g(a.material_spec),1)])),_:2},1024),c(L,{class:"note"},{default:m((()=>[p("使用组织："+g(a.use_org_name),1)])),_:2},1024)])),_:2},1024),c(L,{class:"cc-tree-card-item__foot"}),c(L,{class:"cc-tree-card-item__arrow"},{default:m((()=>[c(E,{type:"bottom",size:"14",color:"#999"})])),_:1})])),_:2},1024)])),_:2},1024),a.open?(u(),n(L,{key:0,class:"cc-tree-card__sub"},{default:m((()=>[(u(!0),i(_,null,f(a.children,((a,t)=>(u(),n(L,{key:t,class:"cc-tree-card-item"},{default:m((()=>[c(L,{class:"vertical-line"}),c(L,{class:"cc-tree-card-item__section"},{default:m((()=>[c(L,{class:"horizontal-line"}),c(L,{class:"cc-tree-card-item__card",onClick:t=>a.bom_id?e.search_bom(a.bom_id,a.material_no):""},{default:m((()=>[c(L,{class:"cc-tree-card-item__body"},{default:m((()=>[a.bom_id?(u(),n(L,{key:0,class:"title"},{default:m((()=>[p(g(a.material_no)+" / ",1),c(D,{class:"text-primary"},{default:m((()=>[p(g(a.bom_no),1)])),_:2},1024)])),_:2},1024)):(u(),n(L,{key:1,class:"title"},{default:m((()=>[p(g(a.material_no),1)])),_:2},1024)),c(L,{class:"note"},{default:m((()=>[p("名称："+g(a.material_name),1)])),_:2},1024),c(L,{class:"note"},{default:m((()=>[p("规格："+g(a.material_spec),1)])),_:2},1024),(u(!0),i(_,null,f(l.stk_inventory[a.material_no],((e,a)=>(u(),n(L,{key:a,class:"note"},{default:m((()=>[p("库存："+g(e.FStockName)+" ",1),c(D,{class:"text-primary"},{default:m((()=>[p(g(e.FBaseQty)+" "+g(e["FBaseUnitId.FName"]),1)])),_:2},1024)])),_:2},1024)))),128))])),_:2},1024),c(L,{class:"cc-tree-card-item__foot"}),a.bom_id?(u(),n(L,{key:0,class:"cc-tree-card-item__arrow"},{default:m((()=>[c(E,{type:"right",size:"14",color:"#999"})])),_:1})):d("",!0)])),_:2},1032,["onClick"])])),_:2},1024)])),_:2},1024)))),128))])),_:2},1024)):d("",!0)])),_:2},1024)])),_:2},1024)))),128))])),_:1})])),_:1},8,["title"])):d("",!0),c(L,{class:"uni-goods-nav-wrapper"},{default:m((()=>[c(z,{options:l.goods_nav.options,"button-group":l.goods_nav.button_group,fill:e.$store.state.goods_nav_fill,onClick:s.goods_nav_click,onButtonClick:s.goods_nav_button_click},null,8,["options","button-group","fill","onClick","onButtonClick"])])),_:1})],64)}],["__scopeId","data-v-1cf82337"]]);export{O as default};
