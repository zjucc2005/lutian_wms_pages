import{s as t,b as e,a,h as l,c as i,q as o,e as s,w as n,F as d,i as c,o as u,f as _,t as r,L as m,u as f,d as p,g as k,k as h,y as F}from"./index-DsK9pIyj.js";import{_ as y}from"./uni-list-item.BkmqxiQh.js";import{r as v}from"./uni-app.es.CSK8ITuj.js";import{_ as b}from"./uni-list.dJf-6p1_.js";import{_ as g}from"./uni-section.BpQrEx4g.js";import{_ as I}from"./uni-icons.DRoE6XYp.js";import{_ as q}from"./uni-load-more.CyJx3ZKG.js";import{_ as S}from"./uni-goods-nav.BN-nj5na.js";import{_ as N}from"./uni-number-box.DOITgqEr.js";import{_ as x,a as C}from"./uni-popup.CPWlX1tX.js";import"./k3cloudapi.PCDjx1SF.js";import{I as j,a as w}from"./stock_loc.Bj3C3Byx.js";import"./inv_log.D0BShjlW.js";import{_ as L}from"./_plugin-vue_export-helper.BCo6x5W8.js";import"./uni-badge.CO78OwkC.js";const B=L({data:()=>({bill_no:"",material:{},invs:[],inv_plans:[],inv_editing:{},goods_nav:{options:[],button_group:[{text:"新增调拨",backgroundColor:t.state.goods_nav_color.blue,color:"#fff"}]}}),onLoad(t){this.getOpenerEventChannel().on("eventInput",(t=>{this.$logger.info("eventChannel res:",t),this.bill_no=t.bill_no,this.material=t.material,this.load_invs(),this.load_inv_plans()}))},computed:{sum_checked_qty(){let t=0;for(let e of this.invs)e.checked&&(t+=e.checked_qty);return t},sum_moved_qty(){let t=0;for(let e of this.inv_plans)t+=e.FOpQTY;return t}},methods:{checkbox_click(t){let a=this.invs.find((e=>e.FID==t.target.dataset.id));a.checked?(a.checked=!1,a.checked_qty=0):(a.checked=!0,a.checked_qty=a.FQty,this.sum_checked_qty>=this.material.must_qty&&e({icon:"none",title:"已选择足够数量"}))},edit_checked_qty(t){t.checked&&(this.$refs.checked_qty_dialog.open(),this.inv_editing=t)},update_checked_qty(t){this.inv_editing.checked=t>0},goods_nav_click(t){0===t.index&&this.$logger.info("this.$data",this.$data)},goods_nav_button_click(t){0===t.index&&this.submit_move()},async load_invs(){let e={FStockId:t.state.cur_stock.FStockId,"FMaterialId.FNumber":this.material.material_no,FQty_gt:0},a=await j.query(e,{order:"FSupplierId ASC, FBatchNo ASC, FStockLocId.FNumber ASC"});this.invs=a.data},async load_inv_plans(){let e={FStockId:t.state.cur_stock.FStockId,"FMaterialId.FNumber":this.material.material_no,FBillNo:this.bill_no,FDocumentStatu:"C",FOpType:"mv"},a=await w.query(e);this.inv_plans=a.data},async submit_move(){a({title:"Loading",mask:!0});for(let e of this.invs){let a=`${e["FStockLocId.FNumber"].split("-")[0]}-拆包区`;if(e.checked&&e["FStockLocId.FNumber"]!==a){let l=new w({FOpType:"mv",FStockId:t.state.cur_stock.FStockId,FStockLocNo:e["FStockLocId.FNumber"],FDestStockLocNo:a,FMaterialId:e.FMaterialId,FOpQTY:e.checked_qty,FBatchNo:e.FBatchNo,FSupplierId:e.FSupplierId,FOpStaffNo:t.state.cur_staff.FNumber,FBillNo:this.bill_no}),i=await l.save(),o=await w.query({FID:i.data.Result.Id});await w.audit([i.data.Result.Id]),await w.execute(o.data[0])}}await this.load_invs(),await this.load_inv_plans(),l()}}},[["render",function(t,e,a,l,j,w){const L=h,B=c,$=v(i("uni-list-item"),y),O=v(i("uni-list"),b),Q=v(i("uni-section"),g),D=v(i("uni-icons"),I),T=v(i("uni-load-more"),q),A=F,M=v(i("uni-goods-nav"),S),U=v(i("uni-number-box"),N),V=v(i("uni-popup-dialog"),x),Y=v(i("uni-popup"),C);return u(),o(d,null,[s(Q,{title:"发料信息",type:"square","sub-title":j.bill_no,"sub-title-color":"#007aff"},{default:n((()=>[s(O,null,{default:n((()=>[s($,null,{body:n((()=>[s(B,{class:"uni-list-item__body"},{default:n((()=>[s(L,{class:"title"},{default:n((()=>[_(r(j.material.material_no),1)])),_:1}),s(B,{class:"note"},{default:n((()=>[s(B,null,{default:n((()=>[_("名称："+r(j.material.material_name),1)])),_:1}),s(B,null,{default:n((()=>[_("规格："+r(j.material.material_spec),1)])),_:1}),s(B,null,{default:n((()=>[_("仓库："),s(L,{class:m([j.material.stock_id==t.$store.state.cur_stock.FStockId?"text-primary":"text-error"])},{default:n((()=>[_(r(j.material.stock_name),1)])),_:1},8,["class"])])),_:1}),s(B,null,{default:n((()=>[_("仓管员："+r(j.material.storekeeper),1)])),_:1})])),_:1})])),_:1})])),footer:n((()=>[s(B,{class:"uni-list-item__foot"},{default:n((()=>[s(B,null,{default:n((()=>[_(r(j.material.must_qty)+" "+r(j.material.unit_name),1)])),_:1})])),_:1})])),_:1})])),_:1})])),_:1},8,["sub-title"]),s(Q,{title:"调拨日志",type:"square"},{right:n((()=>[s(B,null,{default:n((()=>[_("已调拨："),s(L,{class:"text-primary"},{default:n((()=>[_(r(w.sum_moved_qty),1)])),_:1})])),_:1})])),default:n((()=>[s(O,null,{default:n((()=>[(u(!0),o(d,null,f(j.inv_plans,((t,e)=>(u(),p($,{key:e},{body:n((()=>[s(B,{class:"uni-list-item__body"},{default:n((()=>[s(B,{class:"title"},{default:n((()=>[_(r(t["FStockLocId.FNumber"])+" ",1),s(D,{type:"redo",size:"20",color:"#007bff"}),s(L,{class:"dest_loc_no uni-ml-2"},{default:n((()=>[_(r(t["FDestStockLocId.FNumber"]),1)])),_:2},1024)])),_:2},1024),s(B,{class:"note"},{default:n((()=>[s(B,null,{default:n((()=>[_("批次："+r(t.FBatchNo),1)])),_:2},1024),s(B,null,{default:n((()=>[_("供应商："+r(t["FSupplierId.FName"]),1)])),_:2},1024)])),_:2},1024)])),_:2},1024)])),footer:n((()=>[s(B,{class:"uni-list-item__foot"},{default:n((()=>[s(B,{class:"op_qty"},{default:n((()=>[s(L,null,{default:n((()=>[_(r(t.FOpQTY)+" "+r(t["FStockUnitId.FName"]),1)])),_:2},1024)])),_:2},1024)])),_:2},1024)])),_:2},1024)))),128))])),_:1}),0===j.inv_plans.length?(u(),p(T,{key:0,status:"nomore"})):k("",!0)])),_:1}),s(Q,{title:"库存信息",type:"square","sub-title":"可修改选择的库存数",class:"above-uni-goods-nav"},{right:n((()=>[s(B,null,{default:n((()=>[_("已选择："),s(L,{class:"text-primary"},{default:n((()=>[_(r(w.sum_checked_qty),1)])),_:1})])),_:1})])),default:n((()=>[(u(!0),o(d,null,f(j.invs,((t,e)=>(u(),p($,{key:e,onClick:e=>w.edit_checked_qty(t),clickable:"","show-arrow":""},{header:n((()=>[s(B,{class:"uni-list-item__head"},{default:n((()=>[s(A,{checked:t.checked,onClick:w.checkbox_click,"data-id":t.FID},null,8,["checked","onClick","data-id"])])),_:2},1024)])),body:n((()=>[s(B,{class:"uni-list-item__body"},{default:n((()=>[s(B,{class:"title"},{default:n((()=>[_(r(t["FStockLocId.FNumber"]),1)])),_:2},1024),s(B,{class:"note"},{default:n((()=>[s(B,null,{default:n((()=>[_("批次："+r(t.FBatchNo),1)])),_:2},1024),s(B,null,{default:n((()=>[_("供应商："+r(t["FSupplierId.FName"]),1)])),_:2},1024)])),_:2},1024)])),_:2},1024)])),footer:n((()=>[s(B,{class:"uni-list-item__foot"},{default:n((()=>[s(B,null,{default:n((()=>[_(r(t.FQty)+" "+r(t["FStockUnitId.FName"]),1)])),_:2},1024),t.checked?(u(),p(B,{key:0,class:"text-primary"},{default:n((()=>[_("已选择："+r(t.checked_qty),1)])),_:2},1024)):k("",!0)])),_:2},1024)])),_:2},1032,["onClick"])))),128)),0===j.invs.length?(u(),p(T,{key:0,status:"nomore"})):k("",!0)])),_:1}),s(B,{class:"uni-goods-nav-wrapper"},{default:n((()=>[s(M,{options:j.goods_nav.options,"button-group":j.goods_nav.button_group,fill:t.$store.state.goods_nav_fill,onClick:w.goods_nav_click,onButtonClick:w.goods_nav_button_click},null,8,["options","button-group","fill","onClick","onButtonClick"])])),_:1}),s(Y,{ref:"checked_qty_dialog",type:"dialog"},{default:n((()=>[s(V,{title:"修改选择的库存数",type:"error","show-close":!1},{default:n((()=>[s(B,{class:"plan-form"},{default:n((()=>[s(U,{modelValue:j.inv_editing.checked_qty,"onUpdate:modelValue":e[0]||(e[0]=t=>j.inv_editing.checked_qty=t),min:0,max:j.inv_editing.FQty,onChange:e[1]||(e[1]=t=>j.inv_editing.checked=j.inv_editing.checked_qty>0)},null,8,["modelValue","max"])])),_:1})])),_:1})])),_:1},512)],64)}]]);export{B as default};
