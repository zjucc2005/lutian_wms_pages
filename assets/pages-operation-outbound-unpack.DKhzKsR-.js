import{s as t,p as a,b as e,a as i,h as l,c as s,q as o,e as r,w as _,d as n,g as c,F as d,i as u,o as m,f,t as h,u as F,k as p,L as k,y,M as g}from"./index-DjNCOAYS.js";import{_ as b}from"./uni-easyinput.C9ecXEkH.js";import{r as I}from"./uni-app.es.Ch8d-HxS.js";import{_ as v}from"./uni-section.Cyvrqc16.js";import{_ as S,a as N,b as M}from"./uni-td.xx2RVe4L.js";import{_ as q}from"./uni-icons.CZYyaTue.js";import{_ as C}from"./uni-table.BDa3YjjO.js";import{_ as B}from"./uni-list-item.Dm5ieig7.js";import{_ as x}from"./uni-list.p66-62vf.js";import{_ as w}from"./uni-card.BxqS3xBq.js";import{_ as j}from"./uni-goods-nav.BCKosiBH.js";import{f as Q}from"./date-format.Dm3Q97cL.js";import{s as U}from"./scan_code.DOvZ5dVY.js";import"./k3cloudapi.B_cIKn_3.js";import{I as L}from"./stock_loc.GXV191SF.js";import{I as D}from"./inv_log.B3mwqkWu.js";import{P as A}from"./prd_issue_mtr_notice.Cp0yTTyv.js";import{S as $,a as P,P as E}from"./stk_out_stock_apply.DDkKCJdz.js";import{_ as T}from"./yiwancheng_stamp.fi2kVvVZ.js";import{_ as Z}from"./_plugin-vue_export-helper.BCo6x5W8.js";import"./uni-datetime-picker.CBY8aiXR.js";import"./uni-badge.DRmKIMEp.js";const R=Z({data:()=>({scfl:[],scfl_todo:[],invs:[],invs_map:{},inv_logs:[],inv_logs_map:{},filter_cond:"全部",search_form:{bill_no:""},goods_nav:{options:[{icon:"checkbox",text:"全选"},{icon:"settings",text:"全部"}],button_group:[{text:"扫码查询单据",backgroundColor:t.state.goods_nav_color.red,color:"#fff"},{text:"确认出库",backgroundColor:t.state.goods_nav_color.blue,color:"#fff"}]}}),onShow(){this.search_form.bill_no||this.load_scfl_todo()},computed:{scfl_filtered(){return"全部"===this.filter_cond?this.scfl:"未出库"===this.filter_cond?this.scfl.filter((t=>(this.inv_logs_map[t.material_id]||0)<t.must_qty)):"可出库"===this.filter_cond?this.scfl.filter((t=>this.can_outbound(t))):"已出库"===this.filter_cond?this.scfl.filter((t=>(this.inv_logs_map[t.material_id]||0)>=t.must_qty)):void 0},is_completed(){let t=!0;if(this.scfl.length){for(let a of this.scfl)if(!this.inv_logs_map[a.material_id]){t=!1;break}}else t=!1;return t}},methods:{check_all(){let t=this.scfl.some((t=>!t.checked&&this.can_outbound(t)));for(let a of this.scfl)this.can_outbound(a)&&(a.checked=t)},can_outbound(t){return(this.inv_logs_map[t.material_id]||0)<t.must_qty&&this.invs_map[t.material_id]},checkbox_click(t){let a=this.scfl.find((a=>a.material_id===t.target.dataset.id));a&&(a.checked=!a.checked)},goods_nav_click(t){0===t.index&&this.check_all(),1===t.index&&this.filter_list()},goods_nav_button_click(t){0===t.index&&this.scan_code(),1===t.index&&this.submit_outbound()},filter_list(){let t=["全部","未出库","可出库","已出库"];a({itemList:t,success:a=>{this.filter_cond=t[a.tapIndex],this.goods_nav.options[1].text=t[a.tapIndex]}})},searchbar_icon_click(t){"prefix"==t&&this.scan_code()},scan_code(){U().then((t=>{this.search_form.bill_no=t.result,this.handle_search()})).catch((t=>{e({icon:"none",title:t})}))},async handle_search(){this.scfl=[],this.invs=[],this.inv_logs=[],this.search_form.bill_no&&(this.search_form.bill_no=this.search_form.bill_no.trim().toUpperCase(),this.search_form.bill_no.match(/^\d+$/)&&(this.search_form.bill_no="SCFLTZD"+this.search_form.bill_no),this.search_form.bill_no.startsWith("SCFLTZD")?await this.load_scfltzd():this.search_form.bill_no.startsWith("CKSQD")?await this.load_cksqd():this.search_form.bill_no.startsWith("JSCLL")?await this.load_jscll():this.search_form.bill_no.startsWith("CGTL")&&await this.load_cgtl(),await this.load_invs(),await this.load_inv_logs())},async load_scfltzd(){try{i({title:"Loading"});let a=await A.query({FBillNo:this.search_form.bill_no,FStockId:t.state.cur_stock.FStockId});if(l(),0==a.data.length)return void e({icon:"none",title:"没有相关数据"});let s=[];for(let t of a.data){let a=s.find((a=>a.material_id===t.FMaterialId));a?(a.must_qty+=t.FMustQty,a.base_must_qty+=t.FBaseMustQty):s.push({material_id:t.FMaterialId,material_no:t["FMaterialId.FNumber"],material_name:t["FMaterialId.FName"],material_spec:t["FMaterialId.FSpecification"],storekeeper:t.F_PAEZ_BaseProperty1,stock_id:t.FStockId,stock_name:t["FStockId.FName"],prd_line:t["F_PAEZ_Base.FName"],must_qty:t.FMustQty,unit_id:t.FUnitId1,unit_name:t["FUnitId1.FName"],base_must_qty:t.FBaseMustQty,base_unit_id:t.FBaseUnitId1,base_unit_name:t["FBaseUnitId1.FName"]})}this.scfl=s}catch(a){}},async load_cksqd(){try{i({title:"Loading"});let a=await $.query({FBillNo:this.search_form.bill_no,FStockId:t.state.cur_stock.FStockId});if(l(),0===a.data.length)return void e({icon:"none",title:"没有相关数据"});let s=[];for(let t of a.data){let a=s.find((a=>a.material_id===t.FMaterialId));a?(a.must_qty+=t.FQty,a.base_must_qty+=t.FBaseQty):s.push({material_id:t.FMaterialId,material_no:t["FMaterialId.FNumber"],material_name:t["FMaterialId.FName"],material_spec:t["FMaterialId.FSpecification"],storekeeper:t["FMaterialId.F_PAEZ_Base1"],stock_id:t.FStockId,stock_name:t["FStockId.FName"],prd_line:t["FDeptId.FName"],must_qty:t.FQty,unit_id:t.FUnitId,unit_name:t["FUnitId.FName"],base_must_qty:t.FBaseQty,base_unit_id:t.FBaseUnitId,base_unit_name:t["FBaseUnitId.FName"]})}this.scfl=s}catch(a){}},async load_jscll(){try{i({title:"Loading"});let a=await P.query({FBillNo:this.search_form.bill_no,FStockId:t.state.cur_stock.FStockId});if(l(),0==a.data.length)return void e({icon:"none",title:"没有相关数据"});let s=[];for(let t of a.data){let a=s.find((a=>a.material_id===t.FMaterialId));a?(a.must_qty+=t.FActualQty,a.base_must_qty+=t.FBaseActualQty):s.push({material_id:t.FMaterialId,material_no:t["FMaterialId.FNumber"],material_name:t["FMaterialId.FName"],material_spec:t["FMaterialId.FSpecification"],storekeeper:t["FMaterialId.F_PAEZ_Base1"],stock_id:t.FStockId,stock_name:t["FStockId.FName"],prd_line:t["FWorkShopId.FName"],must_qty:t.FActualQty,unit_id:t.FUnitId,unit_name:t["FUnitId.FName"],base_must_qty:t.FBaseActualQty,base_unit_id:t.FBaseUnitId,base_unit_name:t["FBaseUnitId.FName"]})}this.scfl=s}catch(a){}},async load_cgtl(){try{i({title:"Loading"});let a=await E.query({FBillNo:this.search_form.bill_no,FStockId:t.state.cur_stock.FStockId});if(l(),0===a.data.length)return void e({icon:"none",title:"没有相关数据"});let s=[];for(let t of a.data){let a=s.find((a=>a.material_id===t.FMaterialId));a?(a.must_qty+=t.FRmRealQty,a.base_must_qty+=t.FRmRealQty):s.push({material_id:t.FMaterialId,material_no:t["FMaterialId.FNumber"],material_name:t["FMaterialId.FName"],material_spec:t["FMaterialId.FSpecification"],storekeeper:t["FMaterialId.F_PAEZ_Base1"],stock_id:t.FStockId,stock_name:t["FStockId.FName"],prd_line:t["FSupplierId.FName"],must_qty:t.FRmRealQty,unit_id:t.FUnitId,unit_name:t["FUnitId.FName"],base_must_qty:t.FRmRealQty,base_unit_id:t.FUnitId,base_unit_name:t["FUnitId.FName"]})}this.scfl=s}catch(a){}},async load_invs(){var a;let e=await L.get_all({FStockId:t.state.cur_stock.FStockId,"FStockLocId.FName_lk":"拆包区"},{order:"FBatchNo ASC"});this.invs=e;let i={};for(let t of this.invs)i[a=t.FMaterialId]||(i[a]=0),i[t.FMaterialId]+=t.FQty;this.invs_map=i},async load_inv_logs(){var a;let e=await D.query({FBillNo:this.search_form.bill_no,FStockId:t.state.cur_stock.FStockId,FOpType:"out"});this.inv_logs=e.data;let i={};for(let t of this.inv_logs)i[a=t.FMaterialId]||(i[a]=0),i[t.FMaterialId]+=t.FOpQTY;this.inv_logs_map=i},async submit_outbound(){let a=this.scfl.filter((t=>t.checked));if(0!==a.length){i({title:"Loading",mask:!0});for(let e=0;e<a.length;e++){i({title:`${e}/${a.length}`,mask:!0});let l=a[e],s=this.invs.filter((t=>t.FMaterialId===l.material_id)),o=l.must_qty-(this.inv_logs_map[l.material_id]||0);for(let a of s){if(0===o)break;let e=a.FQty>=o?o:a.FQty,i=new D({FOpType:"out",FStockId:t.state.cur_stock.FStockId,FStockLocNo:a["FStockLocId.FNumber"],FMaterialId:a.FMaterialId,FOpQTY:e,FBatchNo:a.FBatchNo,FSupplierId:a.FSupplierId,FBillNo:this.search_form.bill_no,FOpStaffNo:t.state.cur_staff.FNumber});await i.save(),o-=e}l.checked=!1}await this.load_invs(),await this.load_inv_logs(),l(),e({title:"出库成功",mask:!0})}else e({icon:"none",title:"未勾选出库信息"})},async load_scfl_todo(){let a=[];i({title:"Loading"});let e=await A.query({FDocumentStatus:"C",FCloseStatus:"A",FStockId:t.state.cur_stock.FStockId,FCreateDate_ge:Q(Date.now(),"yyyy-MM-dd")},{fields:["FBillNo","F_PAEZ_Base.FName"],order:"FCreateDate DESC"});for(let t of e.data){a.find((a=>a.bill_no==t.FBillNo))||a.push({bill_no:t.FBillNo,prd_line:t["F_PAEZ_Base.FName"]})}let s=await P.query({FDocumentStatus:"C",FStockId:t.state.cur_stock.FStockId,FCreateDate_ge:Q(Date.now(),"yyyy-MM-dd")},{fields:["FBillNo","FWorkShopId.FName"],order:"FCreateDate DESC"});for(let t of s.data){a.find((a=>a.bill_no==t.FBillNo))||a.push({bill_no:t.FBillNo,prd_line:t["FWorkShopId.FName"]})}l(),this.scfl_todo=a}}},[["render",function(t,a,e,i,l,Q){var U;const L=I(s("uni-easyinput"),b),D=u,A=I(s("uni-section"),v),$=p,P=I(s("uni-th"),S),E=I(s("uni-tr"),N),Z=I(s("uni-icons"),q),R=y,W=I(s("uni-td"),M),O=I(s("uni-table"),C),z=I(s("uni-list-item"),B),G=I(s("uni-list"),x),V=I(s("uni-card"),w),J=I(s("uni-goods-nav"),j),Y=g;return m(),o(d,null,[r(A,{title:"查询单据编号",type:"square","sub-title":[t.$store.state.cur_stock["FUseOrgId.FName"],t.$store.state.cur_stock["FGroup.FName"]||"未分组",t.$store.state.cur_stock.FName].join(" / "),"sub-title-color":"#007aff",onClick:a[1]||(a[1]=a=>t.$logger.info(">>>",t.$data))},{default:_((()=>[r(D,{class:"searchbar-container"},{default:_((()=>[r(L,{modelValue:l.search_form.bill_no,"onUpdate:modelValue":a[0]||(a[0]=t=>l.search_form.bill_no=t),placeholder:"请输入单据编号","prefix-icon":"scan",onConfirm:Q.handle_search,onClear:Q.handle_search,onIconClick:Q.searchbar_icon_click,"primary-color":"rgb(238, 238, 238)",styles:{color:"#000",backgroundColor:"rgb(238, 238, 238)",borderColor:"rgb(238, 238, 238)"}},null,8,["modelValue","onConfirm","onClear","onIconClick","styles"])])),_:1})])),_:1},8,["sub-title"]),l.scfl.length?(m(),n(A,{key:0,title:"子项明细",type:"square","sub-title":`${l.search_form.bill_no.startsWith("CGTL")?"供应商":"领用部门"}：${null==(U=l.scfl[0])?void 0:U.prd_line}`,"sub-title-color":"#007aff",class:"above-uni-goods-nav"},{right:_((()=>[r(D,null,{default:_((()=>[f("已勾选 "),r($,{class:"text-primary"},{default:_((()=>[f(h(l.scfl.filter((t=>t.checked)).length),1)])),_:1}),f(" 行")])),_:1})])),default:_((()=>["h5"===t.$store.state.screen_type?(m(),n(O,{key:0,ref:"table",border:"",stripe:""},{default:_((()=>[r(E,null,{default:_((()=>[r(P,{align:"center",width:"30"}),r(P,{align:"center",width:"60"},{default:_((()=>[f("序号")])),_:1}),r(P,{align:"center"},{default:_((()=>[f("物料编码")])),_:1}),r(P,{align:"center"},{default:_((()=>[f("物料名称")])),_:1}),r(P,{align:"center"},{default:_((()=>[f("规格型号")])),_:1}),r(P,{align:"center"},{default:_((()=>[f("单位")])),_:1}),r(P,{align:"center"},{default:_((()=>[f("应发数量")])),_:1}),r(P,{align:"center"},{default:_((()=>[f("拆包区数量")])),_:1}),r(P,{align:"center"},{default:_((()=>[f("实发数量")])),_:1}),r(P,{align:"center"},{default:_((()=>[f("仓库")])),_:1}),r(P,{align:"center"},{default:_((()=>[f("仓管员")])),_:1})])),_:1}),(m(!0),o(d,null,F(Q.scfl_filtered,((a,e)=>(m(),n(E,{key:e},{default:_((()=>[r(W,null,{default:_((()=>[l.inv_logs_map[a.material_id]>=a.must_qty?(m(),n(Z,{key:0,type:"paperplane",size:"30",color:"#007aff"})):l.invs_map[a.material_id]&&l.invs_map[a.material_id]>0?(m(),n(R,{key:1,checked:a.checked,onClick:Q.checkbox_click,"data-id":a.material_id},null,8,["checked","onClick","data-id"])):(m(),n(R,{key:2,disabled:""}))])),_:2},1024),r(W,{align:"center"},{default:_((()=>[f(h(e+1),1)])),_:2},1024),r(W,null,{default:_((()=>[f(h(a.material_no),1)])),_:2},1024),r(W,null,{default:_((()=>[f(h(a.material_name),1)])),_:2},1024),r(W,null,{default:_((()=>[f(h(a.material_spec),1)])),_:2},1024),r(W,{align:"center"},{default:_((()=>[f(h(a.unit_name),1)])),_:2},1024),r(W,{align:"center"},{default:_((()=>[f(h(a.must_qty),1)])),_:2},1024),r(W,{align:"center"},{default:_((()=>[f(h(l.invs_map[a.material_id]||0),1)])),_:2},1024),r(W,{align:"center"},{default:_((()=>[f(h(l.inv_logs_map[a.material_id]),1)])),_:2},1024),r(W,null,{default:_((()=>[r($,{class:k([a.stock_id==t.$store.state.cur_stock.FStockId?"text-primary":"text-error"])},{default:_((()=>[f(h(a.stock_name),1)])),_:2},1032,["class"])])),_:2},1024),r(W,null,{default:_((()=>[f(h(a.storekeeper),1)])),_:2},1024)])),_:2},1024)))),128))])),_:1},512)):(m(),n(G,{key:1},{default:_((()=>[(m(!0),o(d,null,F(Q.scfl_filtered,((a,e)=>(m(),n(z,{key:e},{header:_((()=>[r(D,{class:"uni-list-item__head"},{default:_((()=>[l.inv_logs_map[a.material_id]>=a.must_qty?(m(),n(Z,{key:0,type:"paperplane",size:"30",color:"#007aff"})):l.invs_map[a.material_id]&&l.invs_map[a.material_id]>0?(m(),n(R,{key:1,checked:a.checked,onClick:Q.checkbox_click,"data-id":a.material_id},null,8,["checked","onClick","data-id"])):(m(),n(R,{key:2,disabled:""}))])),_:2},1024)])),body:_((()=>[r(D,{class:"uni-list-item__body"},{default:_((()=>[r($,{class:"title"},{default:_((()=>[f(h(a.material_no),1)])),_:2},1024),r(D,{class:"note"},{default:_((()=>[r(D,null,{default:_((()=>[f("名称："+h(a.material_name),1)])),_:2},1024),r(D,null,{default:_((()=>[f("规格："+h(a.material_spec),1)])),_:2},1024),r(D,null,{default:_((()=>[f("仓库："),r($,{class:k([a.stock_id==t.$store.state.cur_stock.FStockId?"text-primary":"text-error"])},{default:_((()=>[f(h(a.stock_name),1)])),_:2},1032,["class"])])),_:2},1024),r(D,null,{default:_((()=>[f("单位："+h(a.unit_name),1)])),_:2},1024)])),_:2},1024)])),_:2},1024)])),footer:_((()=>[r(D,{class:"uni-list-item__foot"},{default:_((()=>[r(D,null,{default:_((()=>[f(" 应发："),r($,{class:"text-lg"},{default:_((()=>[f(h(a.must_qty),1)])),_:2},1024)])),_:2},1024),l.inv_logs_map[a.material_id]?(m(),n(D,{key:0},{default:_((()=>[f(" 实发："),r($,{class:"text-primary text-lg"},{default:_((()=>[f(h(l.inv_logs_map[a.material_id]||0),1)])),_:2},1024)])),_:2},1024)):c("",!0),(l.inv_logs_map[a.material_id]||0)<a.must_qty?(m(),n(D,{key:1},{default:_((()=>[f(" 拆包区："),r($,{class:"text-lg"},{default:_((()=>[f(h(l.invs_map[a.material_id]||0),1)])),_:2},1024)])),_:2},1024)):c("",!0)])),_:2},1024)])),_:2},1024)))),128))])),_:1}))])),_:1},8,["sub-title"])):c("",!0),!l.scfl.length&&l.scfl_todo.length?(m(),n(A,{key:1,title:"今日生产发料",type:"square"},{default:_((()=>[r(V,{spacing:"0",padding:"0"},{default:_((()=>[r(G,null,{default:_((()=>[(m(!0),o(d,null,F(l.scfl_todo,((t,a)=>(m(),n(z,{key:a,"extra-icon":{type:"chat",size:"24",color:"#007bff"},"show-extra-icon":"",title:t.bill_no,"right-text":t.prd_line,onClick:a=>{l.search_form.bill_no=t.bill_no,Q.handle_search()},clickable:"","show-arrow":""},null,8,["title","right-text","onClick"])))),128))])),_:1})])),_:1})])),_:1})):c("",!0),r(D,{class:"uni-goods-nav-wrapper"},{default:_((()=>[r(J,{options:l.goods_nav.options,"button-group":l.goods_nav.button_group,fill:t.$store.state.goods_nav_fill,onClick:Q.goods_nav_click,onButtonClick:Q.goods_nav_button_click},null,8,["options","button-group","fill","onClick","onButtonClick"])])),_:1}),Q.is_completed?(m(),n(Y,{key:2,src:T,class:"yiwancheng-stamp"})):c("",!0)],64)}]]);export{R as default};
