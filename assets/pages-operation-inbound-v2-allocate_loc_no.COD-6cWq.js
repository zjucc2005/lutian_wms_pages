import{x as e,W as t,s as i,b as s,c as o,o as l,d as a,w as n,q as c,u as d,F as r,e as _,C as h,L as u,f,t as p,g,i as y,X as m,Y as k,R as x,O as q}from"./index-DGWOUQdM.js";import{_ as b}from"./uni-list-item.BnynrAPo.js";import{r as w}from"./uni-app.es.DKZsoyMd.js";import{_ as v}from"./uni-list.Kn4QrsAX.js";import{_ as $}from"./uni-icons.LDhtL0t0.js";import{_ as C}from"./uni-section.Dvy4SRsN.js";import{_ as F,a as j}from"./uni-grid.T2dTchQc.js";import{_ as M,a as P}from"./uni-collapse.uyOh-RLk.js";import{_ as I}from"./_plugin-vue_export-helper.BCo6x5W8.js";import"./uni-badge._gn3hy42.js";const O=I({components:{ccShelfAllocate:I({name:"cc-shelf-allocate",props:{stock_locs:{type:Array,default:[]},strict:{type:Boolean,default:!0},demand_qty:{type:Number},cols:{type:Number,default:0},open:{type:Boolean,default:!1}},data:()=>({grid_shelves:[],allocate_info:[],grid_group_width:0,accordion:"y"===e("shelf_accordion")}),mounted(){this.$nextTick((()=>{this.get_grid_shelves()})),t((e=>{this.get_grid_shelves()}))},computed:{column(){if(this.cols)return this.cols;let e=Math.floor(i.state.system_info.windowWidth/48);return e<10&&(e=10),e},grid_width(){let e=i.state.system_info.windowWidth;return this.grid_group_width=e,(e-1)/this.column},checked_qty(){let e=0;for(let t of this.allocate_info)e+=t.v;return e}},methods:{get_grid_shelves(){let e=[];for(let t of this.stock_locs){let i=t.FNumber,s=t.FGroup,o=i;i.startsWith(s)&&(o=i.substring(s.length,i.length),o.startsWith("-")&&(o=o.substring(1,o.length)));let l=t.FPosX,a=t.FPosY,n="",c="default",d=0,r=t.FPalletSpace;"B"==t.FForbidStatus?(n="forbidden",c="error"):0==r?c="warn":-1==r?c="default":t.idle||(c="success");let _=!1,h=0,u=this.allocate_info.find((e=>e.no==i));u&&(_=!0,h=u.v);let f=e.find((e=>e.name===t.FGroup));f?(f.bound.x=Math.max(f.bound.x,t.FPosX),f.bound.y=Math.max(f.bound.y,t.FPosY),f.grids.push({no:i,shelf:s,name:o,x:l,y:a,status:n,style:c,qty:d,plt_space:r,checked:_,checked_qty:h})):e.push({name:s,disabled:!0,bound:{x:l,y:a},grids:[{no:i,shelf:s,name:o,x:l,y:a,status:n,style:c,qty:d,plt_space:r,checked:_,checked_qty:h}]})}e.forEach((e=>{for(let t=1;t<=Math.ceil(e.bound.x/this.column)*this.column;t+=1)for(let i=1;i<=e.bound.y;i+=1){let{page:s,index:o}=this.get_grid_page_and_index(e.bound,{x:t,y:i}),l=this.get_grid_name({x:t,y:i}),a=[e.name,l].join("-"),n=e.grids.find((e=>e.x==t&&e.y==i));n?(n.page=s,n.index=o,n.no=n.no||a):(n={x:t,y:i,page:s,index:o,name:l,no:a,qty:0,status:"",style:"none"},e.grids.push(n))}})),e.sort(((e,t)=>e.name>=t.name?1:-1)),this.grid_shelves=e},get_grid_page_and_index(e={},t={}){return{page:Math.ceil(t.x/this.column),index:(e.y-t.y)*Math.ceil(e.x/this.column)*this.column+t.x}},get_grid_name:(e={})=>100*e.y+e.x,filter_swiper_grids:(e,t)=>e.grids.filter((e=>e.page==t)).sort(((e,t)=>e.index-t.index)),get_swiper_pages(e){return Math.ceil(e.bound.x/this.column)},get_swiper_height(e){return Math.ceil(this.grid_width*(e.bound.y+.6))},grid_click(e,t){let i=t.grids.find((t=>t.index===e.detail.index));if(i&&0!==i.plt_space&&!["error","none","warn"].includes(i.style)&&(!this.strict||!["success"].includes(i.style))){if(i.checked){let e=this.demand_qty-this.checked_qty;if(i.checked_qty===i.plt_space||0===e){let e=this.allocate_info.findIndex((e=>e.no==i.no));e>=0&&this.allocate_info.splice(e,1),i.checked=!1,i.checked_qty=0}else if(i.checked_qty<i.plt_space){this.allocate_info.find((e=>e.no==i.no)).v+=1,i.checked_qty+=1}}else{let e=this.demand_qty-this.checked_qty;if(0===e)return void s({icon:"none",title:"分配库位已足够"});-1==i.plt_space?i.checked_qty=e:i.checked_qty=1,i.checked=!0,this.allocate_info.push({no:i.no,v:i.checked_qty})}this.$emit("update:modelValue",this.allocate_info)}}}},[["render",function(e,t,i,s,x,q){const b=y,v=w(o("uni-icons"),$),C=w(o("uni-grid-item"),F),I=w(o("uni-grid"),j),O=m,W=k,z=w(o("uni-collapse-item"),M),E=w(o("uni-collapse"),P);return l(),a(E,{accordion:x.accordion},{default:n((()=>[(l(!0),c(r,null,d(x.grid_shelves,((e,s)=>(l(),a(z,{title:e.name,open:x.accordion?0===s:i.open,key:s,"title-border":"show",onClick:t[0]||(t[0]=e=>console.log("this.$data",this.$data))},{default:n((()=>[_(b,{class:"content"},{default:n((()=>[_(W,{"indicator-dots":!0,style:h({height:`${q.get_swiper_height(e)}px`}),class:"shelf_swiper"},{default:n((()=>[(l(!0),c(r,null,d(q.get_swiper_pages(e),(t=>(l(),a(O,{key:t},{default:n((()=>[_(I,{column:q.column,"show-border":!1,onChange:t=>q.grid_click(t,e),style:h({width:x.grid_group_width+"px"})},{default:n((()=>[(l(!0),c(r,null,d(q.filter_swiper_grids(e,t),(e=>(l(),a(C,{key:e.index,index:e.index,style:h({width:q.grid_width+"px",height:q.grid_width+"px"})},{default:n((()=>[_(b,{class:u(["grid-item-box",e.style])},{default:n((()=>[_(b,{class:"name"},{default:n((()=>[f(p(e.name),1)])),_:2},1024),e.checked?(l(),a(b,{key:0},{default:n((()=>[_(v,{type:"checkmarkempty",size:.5*q.grid_width},null,8,["size"]),_(b,{class:"pallet_qty"},{default:n((()=>[f(p(e.checked_qty),1)])),_:2},1024)])),_:2},1024)):g("",!0)])),_:2},1032,["class"])])),_:2},1032,["index","style"])))),128))])),_:2},1032,["column","onChange","style"])])),_:2},1024)))),128))])),_:2},1032,["style"])])),_:2},1024)])),_:2},1032,["title","open"])))),128))])),_:1},8,["accordion"])}],["__scopeId","data-v-13fb77d0"]])},onLoad(e){this.getOpenerEventChannel().on("initStockLocs",(e=>{this.stock_locs=e.stock_locs||[],this.pallet_qty=e.pallet_qty||0}))},data:()=>({allocate_info:[],stock_locs:[],pallet_qty:0,strict:!0,goods_nav:{options:[{icon:"map-filled",text:"已分配",info:0}],button_group:[{text:"返回",backgroundColor:i.state.goods_nav_color.grey,color:"#fff"},{text:"预览",backgroundColor:i.state.goods_nav_color.yellow,color:"#fff"}]}}),computed:{sum_checked_qty(){let e=0;for(let t of this.allocate_info)e+=t.v;return e},checked_percentage(){return(this.sum_checked_qty/this.pallet_qty*100).toFixed()+"%"}},methods:{click_confirm(){if(this.sum_checked_qty<this.pallet_qty)return void s({icon:"error",title:"未分配完毕"});this.getOpenerEventChannel().emit("allocateInfo",{allocate_info:this.allocate_info}),x()},goods_nav_click(e){0===e.index&&this.$logger.info("this.$data",this.$data)},goods_nav_button_click(e){0===e.index&&x(),1===e.index&&this.preview()},preview(){if(this.sum_plt_alloc()<this.pallet_qty)return void s({icon:"none",title:this.pallet_qty-this.sum_plt_alloc()+"个托盘未分配"});this.getOpenerEventChannel().emit("allocateInfo",{allocate_info:this.allocate_info}),x()}}},[["render",function(e,t,i,s,c,d){const r=w(o("uni-list-item"),b),u=w(o("uni-list"),v),m=q("cc-shelf-allocate"),k=y,x=w(o("uni-icons"),$),F=w(o("uni-section"),C);return l(),a(F,{title:"分配托盘库位",type:"square","sub-title":"点击闲置库位进行分配","sub-title-color":"#007aff",class:"above-uni-goods-nav",onClick:t[1]||(t[1]=e=>console.log("view",this.$data))},{default:n((()=>[_(u,null,{default:n((()=>[_(r,{"show-extra-icon":!0,"extra-icon":{type:"right",color:"#007bff"},title:"已分配托盘数",rightText:`${d.sum_checked_qty} / ${c.pallet_qty}`},null,8,["rightText"])])),_:1}),c.stock_locs.length?(l(),a(m,{key:0,modelValue:c.allocate_info,"onUpdate:modelValue":t[0]||(t[0]=e=>c.allocate_info=e),stock_locs:c.stock_locs,demand_qty:c.pallet_qty,strict:c.strict,open:""},null,8,["modelValue","stock_locs","demand_qty","strict"])):g("",!0),_(k,{class:"fixed-btn",style:h({background:`linear-gradient(to top, #007aff ${d.checked_percentage}, #c0c0c0 ${d.checked_percentage})`}),onClick:d.click_confirm},{default:n((()=>[d.sum_checked_qty<c.pallet_qty?(l(),a(k,{key:0},{default:n((()=>[f(p(d.sum_checked_qty),1)])),_:1})):(l(),a(x,{key:1,type:"checkmarkempty",size:"40",color:"#fff"}))])),_:1},8,["style","onClick"])])),_:1})}],["__scopeId","data-v-0d32902f"]]);export{O as default};
