import{s as t,a as e,h as o,b as a,ap as i,m as s,R as r,c as l,q as n,e as c,w as _,F as d,i as u,o as m,f as h,u as p,S as f,T as F,d as k,t as b,g as y}from"./index-DsK9pIyj.js";import{_ as g}from"./uni-notice-bar.B8OA6Exg.js";import{r as v}from"./uni-app.es.CSK8ITuj.js";import{_ as x,a as w,b as I}from"./uni-td.DKOxbdh1.js";import{_ as N}from"./uni-icons.DRoE6XYp.js";import{_ as S}from"./uni-table.BXeOwSLO.js";import{_ as q}from"./uni-section.BpQrEx4g.js";import{_ as M}from"./uni-goods-nav.BN-nj5na.js";import{_ as j}from"./uni-list-item.BkmqxiQh.js";import{_ as L}from"./uni-list.dJf-6p1_.js";import{_ as C}from"./uni-drawer.BPNIP2eu.js";import{X as U}from"./xlsx.uBlg2PW8.js";import{c as Q,d as T}from"./gen_pdf.C89vt95K.js";import{c as $,s as B,p as O}from"./index.uHoH2c2-.js";import"./k3cloudapi.PCDjx1SF.js";import{B as R}from"./bd_material.d9K6JZK2.js";import{I as z}from"./stock_loc.Bj3C3Byx.js";import{I as D}from"./inv_log.D0BShjlW.js";import{S as E}from"./stk_inventory.Tp2E6wVT.js";import{f as W}from"./date-format.Dm3Q97cL.js";import{_ as A}from"./_plugin-vue_export-helper.BCo6x5W8.js";import"./uni-datetime-picker.Bsu03if5.js";import"./uni-badge.CO78OwkC.js";const P=A({data:()=>({step:"export",only_different:!1,invs:[],check_invs:[],goods_nav:{options:[{icon:"circle",text:"盘盈盘亏"}],button_group:[{text:"下载盘点模板",backgroundColor:t.state.goods_nav_color.yellow,color:"#fff"},{text:"导入盘点数据",backgroundColor:t.state.goods_nav_color.green,color:"#fff"}]}}),mounted(){this.$nextTick((a=>{this.invs.length||(e({title:"Loading"}),z.get_all({FStockId:t.state.cur_stock.FStockId}).then((t=>{o(),this.invs=t,this._init_check_invs()})),E.query({FStockId:this.$store.state.cur_stock.FStockId},{order:"FMaterialId.FNumber ASC"}))}))},computed:{check_invs_filtered(){return this.only_different?this.check_invs.filter((t=>t.qty!=t.check_qty)):this.check_invs}},methods:{goods_nav_click(t){0===t.index&&(this.only_different=!this.only_different,this.only_different?(this.goods_nav.options[0].icon="checkbox",a({icon:"none",title:"只显示盘盈盘亏"})):(this.goods_nav.options[0].icon="circle",a({icon:"none",title:"显示全部"})))},goods_nav_button_click(t){"export"===this.step&&(0===t.index&&this.check_template_download(),1===t.index&&this.check_data_import()),"import"===this.step&&(0===t.index&&this.back(),1===t.index&&this.if_submit_confirm())},back(){this._activate_step("export"),this._init_check_invs()},check_template_download(){this.$refs.dl_drawer.open()},check_template_pdf(t){"loc_no"==t?this.invs.sort(((t,e)=>$(t["FStockLocId.FNumber"],e["FStockLocId.FNumber"]))):"material_no"==t&&this.invs.sort(((t,e)=>t["FMaterialId.FNumber"]>e["FMaterialId.FNumber"]?1:-1));let e=Q(this.invs);window.open(`#/pages/my/preview_pdf?url=${e}`,"newWindow","width=800")},check_template_excel(t){"loc_no"==t?this.invs.sort(((t,e)=>$(t["FStockLocId.FNumber"],e["FStockLocId.FNumber"]))):"material_no"==t&&this.invs.sort(((t,e)=>t["FMaterialId.FNumber"]>e["FMaterialId.FNumber"]?1:-1));let e=[["物料编码","物料名称","规格型号","库位","批次","单位","账面数量","盘点数量"]];for(let l of this.invs)e.push([l["FMaterialId.FNumber"],l["FMaterialId.FName"],l["FMaterialId.FSpecification"],l["FStockLocId.FNumber"],l.FBatchNo,l["FStockUnitId.FName"],l.FQty,""]);let o=U.utils.aoa_to_sheet(e),a=U.utils.book_new();U.utils.book_append_sheet(a,o,"Sheet1");var i=U.write(a,{bookType:"xlsx",bookSST:!0,type:"binary"});const s=new Blob([B(i)],{type:"application/octet-stream"});let r=document.createElement("a");r.href=URL.createObjectURL(s),r.download=`库存盘点模板_${Date.now()}.xlsx`,r.click(),URL.revokeObjectURL(r.href)},async export_invs_pdf(){let t=await this.get_inv_groups(),e=T(t);window.open(`#/pages/my/preview_pdf?url=${e}`,"newWindow","width=800")},async export_invs_excel(){let t=await this.get_inv_groups(),e=[["物料编码","物料名称","规格型号","单位","WMS库存","金蝶账面","差异","WMS库位"]];for(let l of t){let t=[];for(let e of Object.keys(l.loc_nos))t.push(`${e.match("[A-Za-z0-9]+-(.+)")[1]}:${l.loc_nos[e]}`);t.sort(),e.push([l.material_no,l.material_name,l.material_spec,l.base_unit_name,l.qty,l.stk_qty,l.qty-l.stk_qty,t.join(", ")])}let o=U.utils.aoa_to_sheet(e),a=U.utils.book_new();U.utils.book_append_sheet(a,o,"Sheet1");var i=U.write(a,{bookType:"xlsx",bookSST:!0,type:"binary"});const s=new Blob([B(i)],{type:"application/octet-stream"});let r=document.createElement("a");r.href=URL.createObjectURL(s),r.download=`即时库存对照_${Date.now()}.xlsx`,r.click(),URL.revokeObjectURL(r.href)},check_data_import(){let t=this;i({count:1,extension:[".xlsx",".xls"],success(a){let i=a.tempFiles[0];i.name.split(".").pop();var s=new FileReader;s.onload=function(a){let i=a.target.result,s=U.read(i,{type:"binary"}),r=s.Sheets[s.SheetNames[0]],l=U.utils.sheet_to_json(r,{header:1});e({title:"解析数据..."}),t._merge_check_invs(l),t._activate_step("import"),o()},s.readAsBinaryString(i)}})},if_submit_confirm(){s({title:"确认盘点结果",content:"提交确认后，系统会根据盘点结果更新账面数据。",success:t=>{t.confirm&&(O("success"),this.submit_confirm())}})},async submit_confirm(){let i=this.check_invs.filter((t=>t.qty!=t.check_qty));if(0!==i.length){e({title:"更新库存..."});for(let e of i){let o={FStockId:t.state.cur_stock.FStockId,FStockLocNo:e.stock_no,FMaterialId:e.material_id,FOpQTY:Math.abs(e.qty-e.check_qty),FBatchNo:e.batch_no,FOpStaffNo:t.state.cur_staff.FNumber,FRemark:"库存盘点"};if(e.qty>e.check_qty?o.FOpType="sub":e.qty<e.check_qty&&(o.FOpType="add"),!o.FMaterialId){let a=await R.query({FNumber:e.material_no,FUseOrgId:t.state.cur_stock.FUseOrgId});a.data&&(o.FMaterialId=a.data[0].FMaterialId)}let a=new D(o);await a.save()}o(),a({title:"更新库存成功"}),r({delta:2})}else a({icon:"none",title:"库存数量无误"})},async get_inv_groups(){e({title:"Loading"});let t=await E.query({FStockId:this.$store.state.cur_stock.FStockId},{order:"FMaterialId.FNumber ASC"}),a=[],i=0,s=0;for(;i<t.data.length||s<this.invs.length;){let e=t.data[i],o=this.invs[s];if(!o||e&&e.FMaterialId<=o.FMaterialId){let t=a.find((t=>t.material_id==e.FMaterialId));t?t.stk_qty+=e.FBaseQty:(t={material_id:e.FMaterialId,material_no:e["FMaterialId.FNumber"],material_name:e["FMaterialId.FName"],material_spec:e["FMaterialId.FSpecification"],stk_qty:e.FBaseQty,qty:0,base_unit_name:e["FBaseUnitId.FName"],loc_nos:{}},a.push(t)),i+=1,t.material_id==(null==o?void 0:o.FMaterialId)&&(t.qty+=o.FQty,t.loc_nos[o["FStockLocId.FNumber"]]?t.loc_nos[o["FStockLocId.FNumber"]]+=o.FQty:t.loc_nos[o["FStockLocId.FNumber"]]=o.FQty,s+=1)}else{let t=a.find((t=>t.material_id==o.FMaterialId));if(t)t.qty+=o.FQty,t.loc_nos[o["FStockLocId.FNumber"]]?t.loc_nos[o["FStockLocId.FNumber"]]+=o.FQty:t.loc_nos[o["FStockLocId.FNumber"]]=o.FQty;else{let t={};t[o["FStockLocId.FNumber"]]=o.FQty,a.push({material_id:o.FMaterialId,material_no:o["FMaterialId.FNumber"],material_name:o["FMaterialId.FName"],material_spec:o["FMaterialId.FSpecification"],stk_qty:0,qty:o.FQty,base_unit_name:o["FStockUnitId.FName"],loc_nos:t})}s+=1}}return o(),console.log("inv_groups:",a),a},_init_check_invs(){let t=[];for(let e of this.invs)t.push({material_id:e.FMaterialId,material_no:e["FMaterialId.FNumber"],material_name:e["FMaterialId.FName"],material_spec:e["FMaterialId.FSpecification"],stock_no:e["FStockLocId.FNumber"],batch_no:e.FBatchNo,base_unit_name:e["FStockUnitId.FName"],qty:e.FQty});this.check_invs=t},_merge_check_invs(t){"物料编码"==t[0][0]&&t.shift();let e=[];for(let o of this.invs){let a={material_id:o.FMaterialId,material_no:o["FMaterialId.FNumber"],material_name:o["FMaterialId.FName"],material_spec:o["FMaterialId.FSpecification"],stock_no:o["FStockLocId.FNumber"],batch_no:o.FBatchNo,base_unit_name:o["FStockUnitId.FName"],qty:o.FQty,check_qty:o.FQty},i=t.find((t=>t[0]==o["FMaterialId.FNumber"]&&t[3]==o["FStockLocId.FNumber"]&&t[4]==o.FBatchNo));if(i){let t=parseFloat(i[7]);(t||0==t)&&(a.check_qty=t),i[8]=!0}e.push(a)}for(let o of t.filter((t=>t[0]&&!t[8]))){let t=this.invs.find((t=>t["FMaterialId.FNumber"]==o[0].trim())),a={material_id:null==t?void 0:t.FMaterialId,material_no:o[0].trim(),material_name:o[1],material_spec:o[2],stock_no:o[3],batch_no:o[4]||(null==t?void 0:t.FBatchNo)||W(Date.now(),"yyyyMMdd"),base_unit_name:o[5],qty:0,check_qty:parseFloat(o[7])};o[8]=!0,e.push(a)}e.sort(((t,e)=>t.material_no<e.material_no?-1:1)),this.check_invs=e},_activate_step(e){this.step=e,"import"==this.step&&(this.goods_nav.button_group[0]={text:"返回",backgroundColor:t.state.goods_nav_color.grey,color:"#fff"},this.goods_nav.button_group[1]={text:"提交确认",backgroundColor:t.state.goods_nav_color.blue,color:"#fff"}),"export"==this.step&&(this.goods_nav.button_group[0]={text:"下载盘点模板",backgroundColor:t.state.goods_nav_color.yellow,color:"#fff"},this.goods_nav.button_group[1]={text:"导入盘点数据",backgroundColor:t.state.goods_nav_color.green,color:"#fff"})}}},[["render",function(t,e,o,a,i,s){const r=v(l("uni-notice-bar"),g),U=v(l("uni-th"),x),Q=v(l("uni-tr"),w),T=v(l("uni-td"),I),$=v(l("uni-icons"),N),B=u,O=v(l("uni-table"),S),R=v(l("uni-section"),q),z=v(l("uni-goods-nav"),M),D=v(l("uni-list-item"),j),E=v(l("uni-list"),L),W=F,A=v(l("uni-drawer"),C);return m(),n(d,null,[c(r,{single:"",scrollable:"",text:"盘点数量和账面数量一致时,可不填写盘点数量"}),c(R,{title:"当前仓库",type:"square","sub-title":[t.$store.state.cur_stock["FUseOrgId.FName"],t.$store.state.cur_stock["FGroup.FName"]||"未分组",t.$store.state.cur_stock.FName].join(" / "),class:"above-uni-goods-nav"},{default:_((()=>[c(O,{ref:"table",class:"table-sm",border:"",stripe:""},{default:_((()=>[c(Q,null,{default:_((()=>[c(U,{align:"center",width:"140",sortable:""},{default:_((()=>[h("物料编码")])),_:1}),c(U,{align:"center",width:"140"},{default:_((()=>[h("物料名称")])),_:1}),c(U,{align:"center"},{default:_((()=>[h("规格型号")])),_:1}),c(U,{align:"center",width:"106",sortable:""},{default:_((()=>[h("库位")])),_:1}),c(U,{align:"center",width:"80"},{default:_((()=>[h("批次")])),_:1}),c(U,{align:"center",width:"40"},{default:_((()=>[h("单位")])),_:1}),c(U,{align:"center",width:"70"},{default:_((()=>[h("账面数量")])),_:1}),c(U,{align:"center",width:"70"},{default:_((()=>[h("盘点数量")])),_:1}),c(U,{align:"center",width:"70"},{default:_((()=>[h("盘盈盘亏")])),_:1})])),_:1}),(m(!0),n(d,null,p(s.check_invs_filtered,((t,e)=>(m(),k(Q,{key:e},{default:_((()=>[c(T,null,{default:_((()=>[h(b(t.material_no),1)])),_:2},1024),c(T,null,{default:_((()=>[h(b(t.material_name),1)])),_:2},1024),c(T,null,{default:_((()=>[h(b(t.material_spec),1)])),_:2},1024),c(T,null,{default:_((()=>[h(b(t.stock_no),1)])),_:2},1024),c(T,null,{default:_((()=>[h(b(t.batch_no),1)])),_:2},1024),c(T,null,{default:_((()=>[h(b(t.base_unit_name),1)])),_:2},1024),c(T,{align:"center"},{default:_((()=>[h(b(t.qty),1)])),_:2},1024),c(T,{align:"center"},{default:_((()=>[h(b(t.check_qty),1)])),_:2},1024),c(T,{align:"center"},{default:_((()=>[t.check_qty>=0&&t.qty===t.check_qty?(m(),k($,{key:0,type:"checkmarkempty",color:"#808080"})):y("",!0),t.check_qty>=0&&t.qty<t.check_qty?(m(),k(B,{key:1,class:"text-error"},{default:_((()=>[h("+"+b(t.check_qty-t.qty),1)])),_:2},1024)):y("",!0),t.check_qty>=0&&t.qty>t.check_qty?(m(),k(B,{key:2,class:"text-primary"},{default:_((()=>[h("-"+b(t.qty-t.check_qty),1)])),_:2},1024)):y("",!0)])),_:2},1024)])),_:2},1024)))),128))])),_:1},512)])),_:1},8,["sub-title"]),c(B,{class:"uni-goods-nav-wrapper"},{default:_((()=>[c(z,{options:i.goods_nav.options,"button-group":i.goods_nav.button_group,fill:t.$store.state.goods_nav_fill,onClick:s.goods_nav_click,onButtonClick:s.goods_nav_button_click},null,8,["options","button-group","fill","onClick","onButtonClick"])])),_:1}),c(A,{ref:"dl_drawer",mode:"left",width:t.$store.state.drawer_width},{default:_((()=>[c(W,{"scroll-y":"",style:{height:"100%"},onTouchmove:e[7]||(e[7]=f((()=>{}),["stop"]))},{default:_((()=>[c(R,{title:"下载盘点模板",type:"square"},{right:_((()=>[c(B,{class:"uni-section__right"},{default:_((()=>[c($,{type:"closeempty",size:"24",color:"#333",onClick:e[0]||(e[0]=e=>t.$refs.dl_drawer.close())})])),_:1})])),default:_((()=>[c(E,null,{default:_((()=>[c(D,{title:"盘点模板（库位排序）",note:"打印用PDF",rightText:".pdf","show-extra-icon":!0,"extra-icon":{type:"map",size:"24",color:"#007bff"},onClick:e[1]||(e[1]=t=>s.check_template_pdf("loc_no")),clickable:"","show-arrow":""}),c(D,{title:"盘点模板（物料排序）",note:"打印用PDF",rightText:".pdf","show-extra-icon":!0,"extra-icon":{type:"map",size:"24",color:"#007bff"},onClick:e[2]||(e[2]=t=>s.check_template_pdf("material_no")),clickable:"","show-arrow":""}),c(D,{title:"盘点模板（库位排序）",note:"导入用Excel",rightText:".xlsx","show-extra-icon":!0,"extra-icon":{type:"download",size:"24",color:"#dd524d"},onClick:e[3]||(e[3]=t=>s.check_template_excel("loc_no")),clickable:"","show-arrow":""}),c(D,{title:"盘点模板（物料排序）",note:"导入用Excel",rightText:".xlsx","show-extra-icon":!0,"extra-icon":{type:"download",size:"24",color:"#dd524d"},onClick:e[4]||(e[4]=t=>s.check_template_excel("material_no")),clickable:"","show-arrow":""}),c(D,{title:"即时库存对照（金蝶账面和WMS库存）",note:"打印用PDF",rightText:".pdf","show-extra-icon":!0,"extra-icon":{type:"map",size:"24",color:"#007bff"},onClick:e[5]||(e[5]=t=>s.export_invs_pdf()),clickable:"","show-arrow":""}),c(D,{title:"即时库存对照（金蝶账面和WMS库存）",note:"Excel",rightText:".xlsx","show-extra-icon":!0,"extra-icon":{type:"download",size:"24",color:"#dd524d"},onClick:e[6]||(e[6]=t=>s.export_invs_excel()),clickable:"","show-arrow":""})])),_:1})])),_:1})])),_:1})])),_:1},8,["width"])],64)}],["__scopeId","data-v-73b7f5c7"]]);export{P as default};
