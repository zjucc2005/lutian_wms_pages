import{s as t,b as a,v as e,a as o,h as l,c as i,q as s,e as r,w as n,F as m,i as u,o as d,d as _,g as c,f,t as p,u as h,k as g,l as F}from"./index-MIvYX1nW.js";import{_ as y}from"./uni-icons.DEYikQDp.js";import{r as v}from"./uni-app.es.B8zr0lZI.js";import{_ as b}from"./uni-easyinput.BboSH9MB.js";import{_ as k,a as I}from"./uni-forms.C-YkALHf.js";import{_ as M}from"./uni-section.C7O4oyAr.js";import{_ as j}from"./uni-tag.DOImtkHb.js";import{_ as q}from"./uni-list-item.Dk-snU2X.js";import{_ as C}from"./uni-goods-nav.DSaXBg-u.js";import{s as N}from"./scan_code.bSbj3X8t.js";import{p as x}from"./index.DbF5UMRK.js";import"./k3cloudapi.DzDu3BGl.js";import{B as S}from"./bd_material.CFPy7Ij-.js";import"./stock_loc.BckAHwoS.js";import{I as U}from"./inv_log.BJcJnepW.js";import{_ as V}from"./_plugin-vue_export-helper.BCo6x5W8.js";import{f as w}from"./date-format.Dm3Q97cL.js";import"./uni-badge.DDwx_b0i.js";const B=V({data(){return{material:{},inv_logs:[],form:{material_no:"",loc_no:"",qty:null},form_rules:{material_no:{rules:[{required:!0,errorMessage:"物料编码不能为空"},{validateFunction:(t,a,e,o)=>{if(!this.material.FMaterialId)return o("物料编码不存在")}}]},loc_no:{rules:[{required:!0,errorMessage:"库位号不能为空"},{validateFunction:(a,e,o,l)=>{if(!t.state.stock_locs.some((t=>t.FNumber==e.toUpperCase())))return l("库位号不存在")}}]},qty:{rules:[{required:!0,errorMessage:"入库数量不能为空"},{validateFunction:(t,a,e,o)=>{if(a<=0)return o("入库数量必须大于0")}}]}},goods_nav:{options:[],button_group:[{text:"扫码",backgroundColor:t.state.goods_nav_color.red,color:"#fff"}]}}},methods:{formatDate:w,goods_nav_click(t){},goods_nav_button_click(t){0===t.index&&this.scan_code()},handle_material_no_change(){this.form.material_no?this.load_material():this.material={}},scan_code(){N().then((t=>{this.handle_scan_code(t.result)})).catch((t=>{a({icon:"none",title:t})}))},handle_scan_code(t){t.includes("||")?(this.form.material_no=t.split("||")[1],this.load_material()):t.includes("-")&&!t.includes(".")?this.form.loc_no=t:(this.form.material_no=t,this.load_material())},reset_form(){this.form={material_no:"",loc_no:"",qty:null},e({scrollTop:0})},after_save(t){t.data.Result.ResponseStatus.IsSuccess?U.find(t.data.Result.Id).then((t=>{t.data[0]&&(this.inv_logs.unshift(t.data[0]),a({title:"提交成功"}))})):a({title:"提交失败"})},async load_material(){let a=await S.query({FNumber:this.form.material_no,FUseOrgId:t.state.cur_stock.FUseOrgId});a.data.length?this.material=a.data[0]:this.material={}},async submit_inbound(){try{await this.$refs.form.validate();let e=this.form.loc_no.toUpperCase(),i=w(Date.now(),"yyyyMMdd");if((await U.query({FMaterialId:this.material.FMaterialId,"FStockLocId.FName":e,FOpQTY:1*this.form.qty,FBatchNo:i,FCreateTime_ge:w(Date.now()-15e3,"yyyy-MM-dd hh:mm:ss")})).data.length)return void a({icon:"error",title:"重复入库"});o({title:"Loading",mask:!0});let s=new U({FOpType:"in",FStockId:t.state.cur_stock.FStockId,FStockLocNo:e,FMaterialId:this.material.FMaterialId,FOpQTY:1*this.form.qty,FBatchNo:i,FOpStaffNo:t.state.cur_staff.FNumber}),r=await s.save();x("success"),this.after_save(r),this.reset_form(),l()}catch(e){}}}},[["render",function(t,a,e,o,l,N){const x=v(i("uni-icons"),y),S=v(i("uni-easyinput"),b),U=v(i("uni-forms-item"),k),V=g,w=v(i("uni-forms"),I),B=F,O=u,T=v(i("uni-section"),M),L=v(i("uni-tag"),j),D=v(i("uni-list-item"),q),Q=v(i("uni-goods-nav"),C);return d(),s(m,null,[r(T,{title:"扫码",type:"square",onClick:a[3]||(a[3]=a=>t.$logger.info(">>>",this.$data))},{default:n((()=>[r(O,{class:"container"},{default:n((()=>[r(w,{ref:"form",model:l.form,rules:l.form_rules,labelWidth:"80px"},{default:n((()=>[r(U,{label:"物料编码",name:"material_no",required:""},{default:n((()=>[r(S,{modelValue:l.form.material_no,"onUpdate:modelValue":a[0]||(a[0]=t=>l.form.material_no=t),trim:"both",onChange:N.handle_material_no_change,onClear:N.handle_material_no_change},{left:n((()=>[l.material.FMaterialId?(d(),_(x,{key:0,type:"checkbox-filled",size:"24",color:"#67c23a"})):l.form.material_no&&!l.material.FMaterialId?(d(),_(x,{key:1,type:"help-filled",size:"24",color:"#c0c4cc"})):c("",!0)])),_:1},8,["modelValue","onChange","onClear"])])),_:1}),r(U,{label:"库位号",name:"loc_no",required:""},{default:n((()=>[r(S,{modelValue:l.form.loc_no,"onUpdate:modelValue":a[1]||(a[1]=t=>l.form.loc_no=t),trim:"both"},null,8,["modelValue"])])),_:1}),r(U,{label:"入库数量",name:"qty",required:""},{default:n((()=>[r(S,{modelValue:l.form.qty,"onUpdate:modelValue":a[2]||(a[2]=t=>l.form.qty=t),type:"number"},{right:n((()=>[r(V,{class:"easyinput-suffix-text"},{default:n((()=>{var t;return[f(p(null==(t=l.material)?void 0:t["FBaseUnitId.FName"]),1)]})),_:1})])),_:1},8,["modelValue"])])),_:1})])),_:1},8,["model","rules"]),r(B,{type:"primary",onClick:N.submit_inbound},{default:n((()=>[f("提交入库")])),_:1},8,["onClick"])])),_:1})])),_:1}),r(T,{title:"最近操作日志",type:"line",class:"above-uni-goods-nav"},{right:n((()=>[r(L,{text:"清空日志",type:"error",onClick:a[4]||(a[4]=t=>{l.inv_logs=[]})})])),default:n((()=>[(d(!0),s(m,null,h(l.inv_logs,((t,a)=>(d(),_(D,{key:a},{body:n((()=>[r(O,{class:"uni-list-item__body"},{default:n((()=>[r(O,{class:"title"},{default:n((()=>[f(p(t["FMaterialId.FNumber"])+" / "+p(t["FMaterialId.FName"]),1)])),_:2},1024),r(O,{class:"note"},{default:n((()=>[r(O,null,{default:n((()=>[f("规格："+p(t["FMaterialId.FSpecification"]),1)])),_:2},1024),r(O,null,{default:n((()=>[f("批次："+p(t.FBatchNo),1)])),_:2},1024),r(O,null,{default:n((()=>[f("库位："),r(V,{class:"text-default"},{default:n((()=>[f(p(t["FStockLocId.FNumber"]),1)])),_:2},1024)])),_:2},1024),r(O,null,{default:n((()=>[f("时间："+p(N.formatDate(t.FCreateTime,"yyyy-MM-dd hh:mm:ss")),1)])),_:2},1024)])),_:2},1024)])),_:2},1024)])),footer:n((()=>[r(O,{class:"uni-list-item__foot"},{default:n((()=>[r(O,null,{default:n((()=>[f(p(t.FOpQTY)+" "+p(t["FStockUnitId.FName"]),1)])),_:2},1024)])),_:2},1024)])),_:2},1024)))),128))])),_:1}),r(O,{class:"uni-goods-nav-wrapper"},{default:n((()=>[r(Q,{options:l.goods_nav.options,"button-group":l.goods_nav.button_group,fill:t.$store.state.goods_nav_fill,onClick:N.goods_nav_click,onButtonClick:N.goods_nav_button_click},null,8,["options","button-group","fill","onClick","onButtonClick"])])),_:1})],64)}]]);export{B as default};
