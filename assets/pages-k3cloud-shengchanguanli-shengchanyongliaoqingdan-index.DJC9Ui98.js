var e=Object.defineProperty,t=(t,a,l)=>(((t,a,l)=>{a in t?e(t,a,{enumerable:!0,configurable:!0,writable:!0,value:l}):t[a]=l})(t,"symbol"!=typeof a?a+"":a,l),l);import{P as a,v as l,s as o,a as s,h as i,c as r,q as _,d as n,w as d,e as m,F as u,o as c,f,u as p,C as h,S as F,g as b,i as g,T as y,t as w,Q as N}from"./index-DGWOUQdM.js";import{_ as k,a as I,b as x}from"./uni-td.zb0VuMhS.js";import{r as M}from"./uni-app.es.DKZsoyMd.js";import{_ as j}from"./uni-table.6E3sqkPu.js";import{_ as v}from"./uni-list-item.BnynrAPo.js";import{_ as S}from"./uni-list.Kn4QrsAX.js";import{_ as V}from"./uni-load-more.Dv1TB_Bm.js";import{_ as B}from"./uni-fab.CP0RcAu9.js";import{_ as q}from"./uni-easyinput.l7FUzy_X.js";import{_ as U,a as P}from"./uni-forms.BvQoUrI-.js";import{_ as T,a as $}from"./uni-row.ljsguenj.js";import{_ as C,a as O}from"./uni-popup.u0O5NyhE.js";import{_ as D}from"./uni-icons.LDhtL0t0.js";import{_ as E}from"./uni-section.Dvy4SRsN.js";import{_ as R}from"./uni-drawer.Cl_UrRdK.js";import{_ as Q}from"./uni-data-picker.yU0P1u9A.js";import{X as L}from"./xlsx.uBlg2PW8.js";import{t as W,s as z}from"./index.JIux-90-.js";import{K as A}from"./k3cloudapi.CbDqg_He.js";import{B as G}from"./bd_material.C3v03D_S.js";import"./stock_loc.C36uFwb2.js";import"./inv_log.OihDyY2r.js";import{S as K}from"./stk_inventory.DVJdB6fx.js";import{_ as Z}from"./_plugin-vue_export-helper.BCo6x5W8.js";import{f as X}from"./date-format.Dm3Q97cL.js";import"./uni-datetime-picker.CztCdWST.js";import"./uni-badge._gn3hy42.js";class H{constructor(){}static query(e={},t={}){const a={FormId:this.form_id,FieldKeys:["FID","FBillNo","FMoBillNo","FMoEntrySeq","FSaleOrderNo","FMaterialId","FMaterialId.FNumber","FMaterialId2","FMaterialId2.FNumber","FMaterialId2.FName","FMaterialId2.FSpecification","FMaterialType","FNumerator","FDenominator","FUnitId2","FUnitId2.FName","FMustQty","FPickedQty","FMtoNo","FIssueType","FOwnerId","FOwnerId.FName","FStockId","FStockId.FName"].join(","),FilterString:A.query_filter(e)};return t.per_page&&(a.Limit=t.per_page,t.page&&(a.StartRow=(t.page-1)*t.per_page)),t.order&&(a.OrderString=t.order),A.bill_query(a)}static find(e){return this.query({FID:e},{limit:1})}static view(e){return"number"==typeof e?A.view(this.form_id,{Id:e}):A.view(this.form_id,{Number:e})}}t(H,"form_id","PRD_PPBOM"),t(H,"FIssueTypeEnum",{1:"直接领料",2:"直接倒冲",3:"调拨领料",4:"调拨倒冲",7:"不发料"});const J=Z({data:()=>({ppboms:[],page:1,per_page:100,load_more_status:"more",issue_type_enum:H.FIssueTypeEnum,search_form:{bill_no:"",sale_order_no:"",mo_bill_no:"",material_no:"",material_name:"",material_spec:""},statistics_form:{type:0,title:"",stock_id:0,mo_bill_no:""},statistics_form_rules:{stock_id:{rules:[{required:!0,errorMessage:"仓库不能为空"}]},mo_bill_no:{rules:[{required:!0,errorMessage:"生产订单编号不能为空"}]}},fab_content:[{iconPath:"/static/icon/cc_search.png",selectedIconPath:"/static/icon/cc_search_active.png",text:"搜索",active:!1},{iconPath:"/static/icon/cc_piechart.png",selectedIconPath:"/static/icon/cc_piechart_active.png",text:"统计",active:!1},{iconPath:"/static/icon/cc_gotop.png",selectedIconPath:"/static/icon/cc_gotop_active.png",text:"返回顶部",active:!1}]}),onPullDownRefresh(){this.reload_ppboms(),a()},onReachBottom(){this.load_more()},mounted(){this.load_ppboms()},methods:{truncate:W,formatDate:X,async load_ppboms(){let e={},t={page:this.page,per_page:this.per_page,order:"FID DESC"};this.search_form.bill_no&&(e.FBillNo_lk=this.search_form.bill_no),this.search_form.sale_order_no&&(e.FSaleOrderNo_lk=this.search_form.sale_order_no),this.search_form.mo_bill_no&&(e.FMoBillNo_lk=this.search_form.mo_bill_no),this.search_form.sub_material_no&&(e["FMaterialId2.FNumber_lk"]=this.search_form.sub_material_no),this.search_form.sub_material_name&&(e["FMaterialId2.FName_lk"]=this.search_form.sub_material_name),this.search_form.sub_material_spec&&(e["FMaterialId2.FSpecification_lk"]=this.search_form.sub_material_spec),this.load_more_status="loading",H.query(e,t).then((e=>{this.load_more_status=e.data.length<this.per_page?"nomore":"more",e.data.forEach((e=>this.ppboms.push(e)))}))},reload_ppboms(){this.ppboms=[],this.load_more_status="more",this.page=1,this.load_ppboms()},fab_trigger(e){console.log("this.$data",this.$data),0===e.index&&this.$refs.search_dialog.open(),1===e.index&&this.$refs.statistics_drawer.open(),2===e.index&&l({scrollTop:0})},load_more(){"nomore"!=this.load_more_status&&(this.page+=1,this.load_ppboms())},search_dialog_close(){this.$refs.search_dialog.close()},search_dialog_confirm(){this.reload_ppboms(),this.search_dialog_close()},statistics_dialog_open(e){this.statistics_form={...e},this.$refs.statistics_dialog.open()},statistics_dialog_close(){this.$refs.statistics_dialog.close()},async statistics_dialog_confirm(){var e,t,a,l,r;try{if(await this.$refs.statistics_form.validate(),0===this.statistics_form.type){let n=o.state.bd_stocks.find((e=>e.FStockId==this.statistics_form.stock_id)),d=(null==(e=this.statistics_form.mo_bill_no)?void 0:e.split(/[\s\t\n]/g))||[],m=[],u=[],c=new Array(8).fill(""),f=["物料编码","物料名称","规格型号","单位","可用量","仓管员","分子","工序"];s({title:"Loading"});for(let e of d)if(e){let o=await H.query({FMoBillNo:e});for(let s of o.data){u.find((e=>e.mo_bill_no==s.FMoBillNo))||u.push({mo_bill_no:s.FMoBillNo,sale_order_no:s.FSaleOrderNo});let o=m.find((e=>e.no==s["FMaterialId2.FNumber"]));if(o)o.mos.push({mo_bill_no:e,qty:s.FMustQty});else{let o=await K.query({"FMaterialId.FNumber":s["FMaterialId2.FNumber"],FStockId:n.FStockId}),i=await G.query({FNumber:s["FMaterialId2.FNumber"],FUseOrgId:1},{fields:["F_PAEZ_Base1.FName","F_RGEN_Text_bzgx"]});m.push({no:s["FMaterialId2.FNumber"],name:s["FMaterialId2.FName"],spec:s["FMaterialId2.FSpecification"],stock_name:n.FName,inv_qty:(null==(t=o.data[0])?void 0:t.FBaseQty)||0,unit_name:s["FUnitId2.FName"],storekeeper:(null==(a=i.data[0])?void 0:a["F_PAEZ_Base1.FName"])||"",numerator:s.FNumerator,process:null==(l=i.data[0])?void 0:l.F_RGEN_Text_bzgx,mos:[{mo_bill_no:e,qty:s.FMustQty}]})}}}i();for(let e of u)c.push(e.sale_order_no),f.push(e.mo_bill_no);c.push(""),f.push("合计");let p=[c,f];for(let e of m.sort(((e,t)=>e.no>t.no?1:-1))){let t=[e.no,e.name,e.spec,e.unit_name,e.inv_qty,e.storekeeper,e.numerator,e.process],a=0;for(let l of u){let o=(null==(r=e.mos.find((e=>e.mo_bill_no==l.mo_bill_no)))?void 0:r.qty)||0;t.push(o),a+=o}t.push(a),p.push(t)}let h=L.utils.aoa_to_sheet(p),F=L.utils.book_new();L.utils.book_append_sheet(F,h,"Sheet1");var _=L.write(F,{bookType:"xlsx",bookSST:!0,type:"binary"});const b=new Blob([z(_)],{type:"application/octet-stream"});let g=document.createElement("a");g.href=URL.createObjectURL(b),g.download=`${this.statistics_form.title}_${Date.now()}.xlsx`,g.click(),URL.revokeObjectURL(g.href)}}catch(n){console.log(">>> ERR:",n)}},_calc_percentage:e=>100*e.FPickedQty/e.FMustQty}},[["render",function(e,t,a,l,o,s){const i=M(r("uni-th"),k),L=M(r("uni-tr"),I),W=M(r("uni-td"),x),z=g,A=M(r("uni-table"),j),G=N,K=M(r("uni-list-item"),v),Z=M(r("uni-list"),S),X=M(r("uni-load-more"),V),H=M(r("uni-fab"),B),J=M(r("uni-easyinput"),q),Y=M(r("uni-forms-item"),U),ee=M(r("uni-col"),T),te=M(r("uni-row"),$),ae=M(r("uni-forms"),P),le=M(r("uni-popup-dialog"),C),oe=M(r("uni-popup"),O),se=M(r("uni-icons"),D),ie=M(r("uni-section"),E),re=y,_e=M(r("uni-drawer"),R),ne=M(r("uni-data-picker"),Q);return c(),_(u,null,["h5"===e.$store.state.screen_type?(c(),n(A,{key:0,ref:"table",border:"",stripe:""},{default:d((()=>[m(L,null,{default:d((()=>[m(i,{align:"center",width:"120"},{default:d((()=>[f("单据编号")])),_:1}),m(i,{align:"center",width:"120"},{default:d((()=>[f("产品编码")])),_:1}),m(i,{align:"center",width:"120"},{default:d((()=>[f("需求单据编号")])),_:1}),m(i,{align:"center",width:"120"},{default:d((()=>[f("生产订单编号")])),_:1}),m(i,{align:"center",width:"120"},{default:d((()=>[f("子项物料编码")])),_:1}),m(i,{align:"center",width:"180"},{default:d((()=>[f("子项物料名称")])),_:1}),m(i,{align:"center"},{default:d((()=>[f("规格型号")])),_:1}),m(i,{align:"center",width:"60"},{default:d((()=>[f("分子")])),_:1}),m(i,{align:"center",width:"60"},{default:d((()=>[f("分母")])),_:1}),m(i,{align:"center",width:"80"},{default:d((()=>[f("子项单位")])),_:1}),m(i,{align:"center",width:"80"},{default:d((()=>[f("应发数量")])),_:1}),m(i,{align:"center",width:"80"},{default:d((()=>[f("计划跟踪号")])),_:1}),m(i,{align:"center",width:"80"},{default:d((()=>[f("发料方式")])),_:1}),m(i,{align:"center",width:"150"},{default:d((()=>[f("仓库")])),_:1}),m(i,{align:"center",width:"80"},{default:d((()=>[f("已领数量")])),_:1})])),_:1}),(c(!0),_(u,null,p(o.ppboms,((e,t)=>(c(),n(L,{key:t},{default:d((()=>[t>0&&e.FBillNo==o.ppboms[t-1].FBillNo?(c(),n(W,{key:0})):(c(),n(W,{key:1},{default:d((()=>[m(z,{class:"text-primary"},{default:d((()=>[f(w(e.FBillNo),1)])),_:2},1024)])),_:2},1024)),m(W,null,{default:d((()=>[f(w(e["FMaterialId.FNumber"]),1)])),_:2},1024),m(W,null,{default:d((()=>[f(w(e.FSaleOrderNo),1)])),_:2},1024),m(W,null,{default:d((()=>[f(w(e.FMoBillNo),1)])),_:2},1024),m(W,null,{default:d((()=>[m(z,{class:"text-primary"},{default:d((()=>[f(w(e["FMaterialId2.FNumber"]),1)])),_:2},1024)])),_:2},1024),m(W,null,{default:d((()=>[f(w(e["FMaterialId2.FName"]),1)])),_:2},1024),m(W,null,{default:d((()=>[f(w(e["FMaterialId2.FSpecification"]),1)])),_:2},1024),m(W,null,{default:d((()=>[f(w(e.FNumerator),1)])),_:2},1024),m(W,null,{default:d((()=>[f(w(e.FDenominator),1)])),_:2},1024),m(W,null,{default:d((()=>[f(w(e["FUnitId2.FName"]),1)])),_:2},1024),m(W,null,{default:d((()=>[f(w(e.FMustQty),1)])),_:2},1024),m(W,null,{default:d((()=>[f(w(e.FMtoNo),1)])),_:2},1024),m(W,null,{default:d((()=>[f(w(o.issue_type_enum[e.FIssueType]),1)])),_:2},1024),m(W,null,{default:d((()=>[f(w(e["FStockId.FName"]),1)])),_:2},1024),m(W,null,{default:d((()=>[f(w(e.FPickedQty),1)])),_:2},1024)])),_:2},1024)))),128))])),_:1},512)):(c(),n(Z,{key:1},{default:d((()=>[(c(!0),_(u,null,p(o.ppboms,((e,t)=>(c(),n(K,{key:t},{body:d((()=>[m(z,{class:"uni-list-item__body"},{default:d((()=>[m(z,{class:"title"},{default:d((()=>[f(w(e.FBillNo)+" / "+w(e.FMoBillNo),1)])),_:2},1024),m(z,{class:"note"},{default:d((()=>[m(z,null,{default:d((()=>[f("需求单据编号："+w(e.FSaleOrderNo),1)])),_:2},1024),m(z,null,{default:d((()=>[f("编码："+w(e["FMaterialId2.FNumber"]),1)])),_:2},1024),m(z,null,{default:d((()=>[f("名称："+w(e["FMaterialId2.FName"]),1)])),_:2},1024),m(z,null,{default:d((()=>[f("规格："+w(e["FMaterialId2.FSpecification"]),1)])),_:2},1024),m(z,null,{default:d((()=>[f("发料方式："+w(o.issue_type_enum[e.FIssueType]),1)])),_:2},1024)])),_:2},1024)])),_:2},1024)])),footer:d((()=>[m(z,{class:"uni-list-item__foot"},{default:d((()=>[m(z,null,{default:d((()=>[f(w(e.FNumerator/e.FDenominator)+" "+w(e["FUnitId2.FName"]),1)])),_:2},1024),m(G,{percent:s._calc_percentage(e),"stroke-width":"2","active-color":s._calc_percentage(e)>=100?"#4cd964":"#f0ad4e"},null,8,["percent","active-color"])])),_:2},1024)])),_:2},1024)))),128))])),_:1})),m(X,{status:o.load_more_status,onClickLoadMore:s.load_more},null,8,["status","onClickLoadMore"]),m(H,{ref:"fab",content:o.fab_content,onTrigger:s.fab_trigger,show:""},null,8,["content","onTrigger"]),m(oe,{ref:"search_dialog",type:"dialog"},{default:d((()=>[m(le,{type:"info",title:"搜索条件",cancelText:"关闭",onClose:s.search_dialog_close,onConfirm:s.search_dialog_confirm,"before-close":!0,style:h({width:e.$store.state.system_info.windowWidth-20+"px",minWidth:"360px",maxWidth:"1200px"})},{default:d((()=>[m(z,{class:"search-form"},{default:d((()=>[m(ae,{ref:"search_form",model:o.search_form,"label-width":100},{default:d((()=>[m(te,{gutter:15},{default:d((()=>[m(ee,{md:8,sm:12,xs:24},{default:d((()=>[m(Y,{label:"单据编号"},{default:d((()=>[m(J,{modelValue:o.search_form.bill_no,"onUpdate:modelValue":t[0]||(t[0]=e=>o.search_form.bill_no=e)},null,8,["modelValue"])])),_:1})])),_:1}),m(ee,{md:8,sm:12,xs:24},{default:d((()=>[m(Y,{label:"需求单据编号"},{default:d((()=>[m(J,{modelValue:o.search_form.sale_order_no,"onUpdate:modelValue":t[1]||(t[1]=e=>o.search_form.sale_order_no=e)},null,8,["modelValue"])])),_:1})])),_:1}),m(ee,{md:8,sm:12,xs:24},{default:d((()=>[m(Y,{label:"生产订单编号"},{default:d((()=>[m(J,{modelValue:o.search_form.mo_bill_no,"onUpdate:modelValue":t[2]||(t[2]=e=>o.search_form.mo_bill_no=e)},null,8,["modelValue"])])),_:1})])),_:1}),m(ee,{md:8,sm:12,xs:24},{default:d((()=>[m(Y,{label:"子项物料编码"},{default:d((()=>[m(J,{modelValue:o.search_form.sub_material_no,"onUpdate:modelValue":t[3]||(t[3]=e=>o.search_form.sub_material_no=e)},null,8,["modelValue"])])),_:1})])),_:1}),m(ee,{md:8,sm:12,xs:24},{default:d((()=>[m(Y,{label:"子项物料名称"},{default:d((()=>[m(J,{modelValue:o.search_form.sub_material_name,"onUpdate:modelValue":t[4]||(t[4]=e=>o.search_form.sub_material_name=e)},null,8,["modelValue"])])),_:1})])),_:1}),m(ee,{md:8,sm:12,xs:24},{default:d((()=>[m(Y,{label:"子项规格型号"},{default:d((()=>[m(J,{modelValue:o.search_form.sub_material_spec,"onUpdate:modelValue":t[5]||(t[5]=e=>o.search_form.sub_material_spec=e)},null,8,["modelValue"])])),_:1})])),_:1})])),_:1})])),_:1},8,["model"])])),_:1})])),_:1},8,["onClose","onConfirm","style"])])),_:1},512),m(_e,{ref:"statistics_drawer",mode:"left",width:e.$store.state.drawer_width},{default:d((()=>[m(re,{"scroll-y":"",style:{height:"100%"},onTouchmove:t[8]||(t[8]=F((()=>{}),["stop"]))},{default:d((()=>[m(ie,{title:"统计模板",type:"square"},{right:d((()=>[m(z,{class:"uni-section__right"},{default:d((()=>[m(se,{type:"closeempty",size:"24",color:"#333",onClick:t[6]||(t[6]=t=>e.$refs.statistics_drawer.close())})])),_:1})])),default:d((()=>[m(Z,null,{default:d((()=>[m(K,{title:"汇总拣货清单（暂定名称）",note:"根据生产订单编号过滤",rightText:".xlsx","show-extra-icon":"","extra-icon":{type:"map",size:"24",color:"#007bff"},clickable:"",onClick:t[7]||(t[7]=e=>s.statistics_dialog_open({type:0,title:"汇总拣货清单",stock_id:103409})),"show-arrow":""})])),_:1})])),_:1})])),_:1})])),_:1},8,["width"]),m(oe,{ref:"statistics_dialog",type:"dialog"},{default:d((()=>[m(le,{type:"info",title:[o.statistics_form.title,"统计条件"].join("-"),cancelText:"关闭",onClose:s.statistics_dialog_close,onConfirm:s.statistics_dialog_confirm,"before-close":!0,style:h({width:e.$store.state.system_info.windowWidth-20+"px",minWidth:"360px",maxWidth:"1200px"})},{default:d((()=>[m(z,{class:"statistics-form"},{default:d((()=>[m(ae,{ref:"statistics_form",model:o.statistics_form,rules:o.statistics_form_rules,"label-width":100},{default:d((()=>[m(te,{gutter:15},{default:d((()=>[0===o.statistics_form.type?(c(),_(u,{key:0},[m(ee,null,{default:d((()=>[m(Y,{label:"仓库",name:"stock_id"},{default:d((()=>[m(ne,{ref:"stock_id_data_picker",modelValue:o.statistics_form.stock_id,"onUpdate:modelValue":t[9]||(t[9]=e=>o.statistics_form.stock_id=e),localdata:e.$store.state.bd_stock_opts,"popup-title":"请选择仓库"},null,8,["modelValue","localdata"])])),_:1})])),_:1}),m(ee,null,{default:d((()=>[m(Y,{label:"生产订单编号",name:"mo_bill_no"},{default:d((()=>[m(J,{modelValue:o.statistics_form.mo_bill_no,"onUpdate:modelValue":t[10]||(t[10]=e=>o.statistics_form.mo_bill_no=e),type:"textarea",maxlength:1024,"auto-height":"",placeholder:"复数编号以空格/制表符/换行符隔开"},null,8,["modelValue"])])),_:1})])),_:1})],64)):b("",!0)])),_:1})])),_:1},8,["model","rules"])])),_:1})])),_:1},8,["title","onClose","onConfirm","style"])])),_:1},512)],64)}],["__scopeId","data-v-d6445016"]]);export{J as default};
