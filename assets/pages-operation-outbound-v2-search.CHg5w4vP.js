import{s as t,b as o,a,h as s,c as e,q as i,e as n,w as l,d as _,g as r,F as c,i as u,o as d,u as h,f as m,t as p,k as f,Q as b,M as g}from"./index-MIvYX1nW.js";import{_ as k}from"./uni-easyinput.BboSH9MB.js";import{r as v}from"./uni-app.es.B8zr0lZI.js";import{_ as y}from"./uni-section.C7O4oyAr.js";import{_ as I}from"./uni-list-item.Dk-snU2X.js";import{_ as C}from"./uni-list.zX7C8YBn.js";import{_ as j}from"./uni-goods-nav.DSaXBg-u.js";import{K as D}from"./k3cloudapi.DzDu3BGl.js";import{O as F}from"./outbound_task.D0tt6Qq5.js";import{a as q}from"./stock_loc.BckAHwoS.js";import"./inv_log.BJcJnepW.js";import{s as S}from"./scan_code.bSbj3X8t.js";import{_ as w}from"./yiwancheng_stamp.fi2kVvVZ.js";import{_ as N}from"./_plugin-vue_export-helper.BCo6x5W8.js";import"./uni-icons.DEYikQDp.js";import"./uni-badge.DDwx_b0i.js";const E=N({data:()=>({outbound_task:{},inv_plans:[],search_form:{bill_no:""},is_completed:!1,goods_nav:{options:[{icon:"cart",text:"出库",info:""}],button_group:[{text:"扫码查询单据",backgroundColor:t.state.goods_nav_color.red,color:"#fff"}]}}),onShow(){this.handle_search()},mounted(){this.outbound_task=new F},methods:{goods_nav_click(t){0===t.index&&this.$logger.info("this.$data",this.$data)},goods_nav_button_click(t){0===t.index&&this.scan_code()},searchbar_icon_click(t){"prefix"==t&&this.scan_code()},scan_code(){S().then((t=>{this.search_form.bill_no=t.result,this.handle_search()})).catch((t=>{o({icon:"none",title:t})}))},async handle_search(t){this.is_completed=!1,this.outbound_task=new F,this.search_form.bill_no?(this.search_form.bill_no=this.search_form.bill_no.trim().toUpperCase(),this.search_form.bill_no.match(/^\d+$/)&&(this.search_form.bill_no="FHTZD"+this.search_form.bill_no),await this.load_bill(),await this.load_inv_plans()):this._calc_progress()},async load_bill(){let t=this.search_form.bill_no;if(t.startsWith("FHTZD"))return a({title:"Loading"}),D.view("SAL_DELIVERYNOTICE",{Number:t}).then((t=>{s(),this._handle_fhtzd_data(t)})).catch((t=>{o({icon:"none",title:t})}));this.outbound_task=new F,o({icon:"none",title:"未找到单据信息"})},async load_inv_plans(){let t=this.search_form.bill_no;if(t.startsWith("FHTZD"))return a({title:"Loading"}),q.query({FBillNo:t,FOpType:"out"},{}).then((t=>{s(),this.inv_plans=t.data,this._calc_progress(t.data)}));this.inv_plans=[]},_calc_complete_qty(t){let o=0;return this.inv_plans.forEach((a=>{a.FMaterialId==t.material_id&&"C"==a.FDocumentStatu&&(o+=a.FOpQTY)})),o},_calc_percentage(t){return this._calc_complete_qty(t)/t.base_unit_qty*100},_calc_progress(t=[]){if(0==this.outbound_task.outbound_list.length)return this.goods_nav.options[0].info="",void(this.is_completed=!1);let o=this.outbound_task.outbound_list.map((t=>t.base_unit_qty)).concat([0]).reduce(((t,o)=>t+o)),a=0;t.forEach((t=>{"C"==t.FDocumentStatu&&(a+=t.FOpQTY)}));let s=Math.floor(a/o*100);this.goods_nav.options[0].info=`${s}%`,this.is_completed=o<=a},_handle_fhtzd_data(a){var s;if(a.data.Result.ResponseStatus.IsSuccess){const o=a.data.Result.Result;let s=[];o.SAL_DELIVERYNOTICEENTRY.forEach((t=>{var o,a,e,i;let n=s.find((o=>o.material_id==t.MaterialID_Id));n?n.base_unit_qty+=t.BaseUnitQty:s.push({material_id:t.MaterialID.Id,material_no:t.MaterialID.Number,material_name:null==(o=t.MaterialID.Name[0])?void 0:o.Value,material_spec:null==(a=t.MaterialID.Specification[0])?void 0:a.Value,base_unit_qty:t.BaseUnitQty,base_unit_name:null==(e=t.BaseUnitID.Name[0])?void 0:e.Value,base_unit_no:t.BaseUnitID.Number,stock_id:t.StockID.Id,stock_name:null==(i=t.StockID.Name[0])?void 0:i.Value,planned_qty:0})})),this.outbound_task.bill_no=o.BillNo,this.outbound_task.stock_id=t.state.cur_stock.FStockId,this.outbound_task.staff_no=t.state.cur_staff.FNumber,this.outbound_task.outbound_list=s}else this.outbound_task=new F,o({icon:"none",title:null==(s=a.data.Result.ResponseStatus.Errors[0])?void 0:s.Message})}}},[["render",function(t,o,a,s,D,F){var q;const S=v(e("uni-easyinput"),k),N=u,E=v(e("uni-section"),y),x=f,R=b,V=v(e("uni-list-item"),I),B=v(e("uni-list"),C),M=v(e("uni-goods-nav"),j),T=g;return d(),i(c,null,[n(E,{title:"查询单据编号",type:"square"},{default:l((()=>[n(N,{class:"searchbar-container"},{default:l((()=>[n(S,{modelValue:D.search_form.bill_no,"onUpdate:modelValue":o[0]||(o[0]=t=>D.search_form.bill_no=t),placeholder:"请输入搜索内容","prefix-icon":"scan",onConfirm:F.handle_search,onClear:F.handle_search,onIconClick:F.searchbar_icon_click,"primary-color":"rgb(238, 238, 238)",styles:{color:"#000",backgroundColor:"rgb(238, 238, 238)",borderColor:"rgb(238, 238, 238)"}},null,8,["modelValue","onConfirm","onClear","onIconClick","styles"])])),_:1})])),_:1}),(null==(q=D.outbound_task.outbound_list)?void 0:q.length)?(d(),_(E,{key:0,title:"出库物料信息",type:"square",class:"above-uni-goods-nav"},{default:l((()=>[n(B,null,{default:l((()=>[(d(!0),i(c,null,h(D.outbound_task.outbound_list,((t,o)=>(d(),_(V,{key:o},{body:l((()=>[n(N,{class:"uni-list-item__body"},{default:l((()=>[n(x,{class:"title"},{default:l((()=>[m(p(t.material_no),1)])),_:2},1024),n(N,{class:"note"},{default:l((()=>[n(N,null,{default:l((()=>[m("名称："+p(t.material_name),1)])),_:2},1024),n(N,null,{default:l((()=>[m("规格："+p(t.material_spec),1)])),_:2},1024),n(N,null,{default:l((()=>[m("出货仓库："),n(x,{class:"text-primary"},{default:l((()=>[m(p(t.stock_name),1)])),_:2},1024)])),_:2},1024)])),_:2},1024)])),_:2},1024)])),footer:l((()=>[n(N,{class:"uni-list-item__foot"},{default:l((()=>[n(x,null,{default:l((()=>[m(p(F._calc_complete_qty(t))+" / "+p(t.base_unit_qty)+" "+p(t.base_unit_name),1)])),_:2},1024),n(R,{percent:F._calc_percentage(t),"stroke-width":"2","active-color":100==F._calc_percentage(t)?"#4cd964":"#f0ad4e"},null,8,["percent","active-color"])])),_:2},1024)])),_:2},1024)))),128))])),_:1})])),_:1})):r("",!0),n(N,{class:"uni-goods-nav-wrapper"},{default:l((()=>[n(M,{options:D.goods_nav.options,"button-group":D.goods_nav.button_group,fill:t.$store.state.goods_nav_fill,onClick:F.goods_nav_click,onButtonClick:F.goods_nav_button_click},null,8,["options","button-group","fill","onClick","onButtonClick"])])),_:1}),D.is_completed?(d(),_(T,{key:1,src:w,class:"cover-image"})):r("",!0)],64)}],["__scopeId","data-v-5c3dda05"]]);export{E as default};
