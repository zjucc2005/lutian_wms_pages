import{s as t,b as e,m as a,R as i,n as s,a as o,h as n,c as l,q as r,d as _,w as m,g as c,e as u,F as d,i as f,o as h,f as p,t as b,u as k,S as g,l as y,k as w,T as v,Q as F,M as C}from"./index-MIvYX1nW.js";import{_ as j}from"./uni-easyinput.BboSH9MB.js";import{r as q}from"./uni-app.es.B8zr0lZI.js";import{_ as I,a as x}from"./uni-forms.C-YkALHf.js";import{_ as $}from"./uni-data-select.7wY52LM_.js";import{_ as N}from"./uni-icons.DEYikQDp.js";import{_ as V,a as S}from"./uni-row.Cx_kdH4q.js";import{_ as M}from"./uni-section.C7O4oyAr.js";import{_ as U}from"./uni-list-item.Dk-snU2X.js";import{_ as T}from"./uni-list.zX7C8YBn.js";import{_ as B}from"./uni-goods-nav.DSaXBg-u.js";import{_ as O}from"./uni-drawer.COomJS_R.js";import{_ as z,a as D}from"./uni-swipe-action.Ci9pC8U9.js";import{K as E}from"./k3cloudapi.DzDu3BGl.js";import{I as Q}from"./inbound_task.BSJaUx0d.js";import{B as L}from"./bd_material.CFPy7Ij-.js";import{a as P}from"./stock_loc.BckAHwoS.js";import"./inv_log.BJcJnepW.js";import{p as A,b as W}from"./index.DbF5UMRK.js";import{f as Y}from"./date-format.Dm3Q97cL.js";import{s as K}from"./scan_code.bSbj3X8t.js";import{_ as R}from"./yiwancheng_stamp.fi2kVvVZ.js";import{_ as G}from"./_plugin-vue_export-helper.BCo6x5W8.js";import"./uni-badge.DDwx_b0i.js";const J=G({data(){return{bd_materials:[],inbound_task:{},inv_plans:[],material_categories:[],is_completed:!1,search_form:{material_no:"",material_name:"",material_spec:"",material_category_id:"",candidates:[]},form:{material_id:"",material_no:"",material_name:"",material_spec:"",material_image:"",base_unit_qty:"",base_unit_qty_focus:!1,base_unit_name:"Pcs",decimal_unit:!1},form_rules:{material_id:{rules:[{required:!0,errorMessage:"请先查询获取物料信息"}]},base_unit_qty:{rules:[{required:!0,errorMessage:"物料数量不能为空"},{format:"number",errorMessage:"物料数量只能输入数字"},{validateFunction:(t,e,a,i)=>e<=0?i("物料数量必须大于0"):this.form.decimal_unit||Number.isInteger(e)?void 0:i("物料数量必须为整数")}]}},swipe_options:[{text:"删除",style:{backgroundColor:"#dd524d"}}],goods_nav:{options:[{icon:"list",text:"明细",info:""}],button_group:[{text:"结束编辑入库计划",backgroundColor:t.state.goods_nav_color.grey,color:"#fff"},{text:"新增计划明细",backgroundColor:t.state.goods_nav_color.blue,color:"#fff"}]}}},onShow(){this.inbound_task=Q.current()||new Q({category:"custom",stock_id:t.state.cur_stock.FStockId,stock_name:t.state.cur_stock.FName,staff_no:t.state.cur_staff.FNumber,bill_no:"IC"+Y(Date.now(),"yyyyMMddhhmmss")}),"ongoing"==this.inbound_task.status&&this.load_inv_plans(),window.addEventListener("keydown",(t=>{"Enter"==t.code&&this.search()}))},mounted(){this.load_bd_materialcategories()},methods:{formatDate:Y,add_to_inbound_task(){this.$refs.form.validate().then((t=>{if(this.inbound_task.inbound_list.some((t=>t.material_id==this.form.material_id)))return void e({icon:"none",title:"重复提交"});let a=new Q(this.inbound_task);this.inbound_task=a.add_inbound_list({material_id:this.form.material_id,material_no:this.form.material_no,material_name:this.form.material_name,material_spec:this.form.material_spec,base_unit_qty:Number(this.form.base_unit_qty),base_unit_name:this.form.base_unit_name,created_at:Date.now()}),this._init_form(),A("success"),e({icon:"none",title:"提交成功"})})).catch((t=>{}))},delete_inbound_list(t){let e=new Q(this.inbound_task);this.inbound_task=e.del_inbound_list(t),A("delete")},goods_nav_click(t){0===t.index&&(this.$refs.detail_drawer.open(),this.$logger.info("this.$data",this.$data))},goods_nav_button_click(t){0===t.index&&this.if_finish_inbound_task(),1===t.index&&this.if_new_plan()},if_finish_inbound_task(){a({title:"结束编辑入库计划",content:"结束编辑后，将会清除当前缓存的计划初始化信息，并且无法恢复。请在完成相关计划明细并确认无误后，再确认结束。",success:t=>{t.confirm&&(A("delete"),Q.destroy_all(),i())}})},if_new_plan(t){0!==this.inbound_task.inbound_list.length?"init"==this.inbound_task.status?a({title:"新增计划明细",content:"开始新增计划明细后，将不能继续录入物料信息。请确认已录完物料信息后，再新增计划明细。",success:e=>{e.confirm&&this.new_plan(t)}}):this.new_plan(t):e({icon:"none",title:"未添加物料信息"})},new_plan(t){this.is_completed?e({icon:"none",title:"该计划已完成"}):s({url:"/pages/operation/inbound/v2/plan_new_pallet",success:e=>{A("success");let a=new Q(this.inbound_task);this.inbound_task=a.update({status:"ongoing"}),e.eventChannel.emit("sendInboundTask",{material_no:t})}})},scan_code(){K().then((t=>{if(t.result.includes("||")){let e=t.result.split("||");this.search_form.material_no=e[1]}else this.search_form.material_no=t.result;this.search()})).catch((t=>{e({icon:"none",title:t})}))},searchbar_icon_click(){this.scan_code()},select_material(t){this._set_form(t),this.$refs.search_drawer.close()},swipe_action_click(t,e){0===t.index&&"right"==t.position&&(this.delete_inbound_list(e),this.$refs.swipe_action.closeAll())},async load_inv_plans(){return P.query({FStockId:t.state.cur_stock.FStockId,FBillNo:this.inbound_task.bill_no,FOpType:"in"},{}).then((t=>{this.inv_plans=t.data,this._calc_progress(t.data)}))},async load_bd_materialcategories(){var e;(null==(e=t.state.bd_materialcategories)?void 0:e.length)||(o({title:"Loading"}),await L.categories().then((e=>{n(),t.commit("set_bd_materialcategories",e.data)}))),this.material_categories=t.state.bd_materialcategories.map((t=>({value:t.FMasterId,text:t.FName})))},async search(){if(this._set_material(),this.invs=[],this.inv_plans=[],!this.search_form.material_no&&!this.search_form.material_name&&!this.search_form.material_spec)return;let a={};t.state.cur_stock.FUseOrgId&&(a.FUseOrgId=t.state.cur_stock.FUseOrgId),this.search_form.material_no&&(a.FNumber_lk=this.search_form.material_no),this.search_form.material_name&&(a.FName_lk=this.search_form.material_name),this.search_form.material_spec&&(a.FSpecification_lk=this.search_form.material_spec),this.search_form.material_category_id&&(a.FCategoryId=this.search_form.material_category_id);o({title:"Loading"}),L.query(a,{per_page:50,order:"FNumber ASC"}).then((t=>{n(),this.search_form.candidates=t.data,t.data.length>1&&this.$refs.search_drawer.open(),1===t.data.length&&this._set_form(t.data[0]),t.data.length<1&&e({icon:"none",title:"无匹配结果"})}))},_calc_percentage(t){let e=0;return this.inv_plans.forEach((a=>{a.FMaterialId==t.material_id&&(e+=a.FOpQTY)})),e/t.base_unit_qty*100},_calc_progress(t=[]){if(0==this.inbound_task.inbound_list.length)return this.goods_nav.options[0].info="",void(this.is_completed=!1);let e=this.inbound_task.inbound_list.map((t=>t.base_unit_qty)).concat([0]).reduce(((t,e)=>t+e)),a=0,i=0;t.forEach((t=>{a+=t.FOpQTY,"C"==t.FDocumentStatu&&(i+=t.FOpQTY)}));let s=Math.floor(a/e*100);this.goods_nav.options[0].info=`${s}%`,this.is_completed=e==i},_init_form(){this.form.material_id="",this.form.material_no="",this.form.material_name="",this.form.material_spec="",this.form.material_image="",this.form.base_unit_qty="",this.form.base_unit_qty_focus=!1,this.form.base_unit_name="Pcs",this.form.decimal_unit=!1,this.search_form.material_no="",this.search_form.material_name="",this.search_form.material_spec=""},_set_form(t){t?(this.form.material_id=t.FMaterialId,this.form.material_no=t.FNumber,this.form.material_name=t.FName,this.form.material_spec=t.FSpecification,this.form.base_unit_name=t["FBaseUnitId.FName"],this.form.decimal_unit=W(t["FBaseUnitId.FName"]),this.form.base_unit_qty_focus=!0):this._init_form()},_set_material(t){t?(this.form.material_id=t.FMaterialId,this.form.material_no=t.FNumber,this.form.material_name=t.FName,this.form.material_spec=t.FSpecification,this.form.base_unit_name=t["FBaseUnitId.FName"],this.form.material_image=t.FImageFileServer):(this.form.material_id="",this.form.material_no="",this.form.material_name="",this.form.material_spec="",this.form.base_unit_name="Pcs",this.form.material_image="")},thumbnail_url:t=>E.thumbnail_url(t)}},[["render",function(t,e,a,i,s,o){var n;const E=q(l("uni-easyinput"),j),Q=q(l("uni-forms-item"),I),L=q(l("uni-data-select"),$),P=q(l("uni-icons"),N),A=y,W=q(l("uni-col"),V),Y=q(l("uni-row"),S),K=q(l("uni-forms"),x),G=f,J=q(l("uni-section"),M),X=q(l("uni-list-item"),U),Z=q(l("uni-list"),T),H=w,tt=F,et=q(l("uni-goods-nav"),B),at=C,it=v,st=q(l("uni-drawer"),O),ot=q(l("uni-swipe-action-item"),z),nt=q(l("uni-swipe-action"),D);return h(),r(d,null,["init"==s.inbound_task.status?(h(),_(J,{key:0,title:"1. 查询物料",type:"square"},{default:m((()=>[u(G,{class:"container"},{default:m((()=>[u(K,{ref:"search_form",model:s.search_form,labelWidth:"70px"},{default:m((()=>[u(Q,{label:"编码",name:"material_no"},{default:m((()=>[u(E,{modelValue:s.search_form.material_no,"onUpdate:modelValue":e[0]||(e[0]=t=>s.search_form.material_no=t),trim:"both",focus:"","prefix-icon":"scan",onIconClick:o.searchbar_icon_click},null,8,["modelValue","onIconClick"])])),_:1}),u(Q,{label:"名称",name:"material_name"},{default:m((()=>[u(E,{modelValue:s.search_form.material_name,"onUpdate:modelValue":e[1]||(e[1]=t=>s.search_form.material_name=t),trim:"both"},null,8,["modelValue"])])),_:1}),u(Q,{label:"规格",name:"material_spec"},{default:m((()=>[u(E,{modelValue:s.search_form.material_spec,"onUpdate:modelValue":e[2]||(e[2]=t=>s.search_form.material_spec=t),trim:"both"},null,8,["modelValue"])])),_:1}),u(Q,{label:"存货类别",name:"material_category_id"},{default:m((()=>[u(L,{modelValue:s.search_form.material_category_id,"onUpdate:modelValue":e[3]||(e[3]=t=>s.search_form.material_category_id=t),localdata:s.material_categories},null,8,["modelValue","localdata"])])),_:1}),u(Y,null,{default:m((()=>[u(W,{span:12},{default:m((()=>[u(A,{onClick:o.scan_code,type:"warn",class:"form-btn left"},{default:m((()=>[u(P,{type:"scan",color:"#fff"}),p(" 扫码 ")])),_:1},8,["onClick"])])),_:1}),u(W,{span:12},{default:m((()=>[u(A,{onClick:o.search,type:"primary",class:"form-btn right"},{default:m((()=>[u(P,{type:"checkmarkempty",color:"#fff"}),p(" 搜索 ")])),_:1},8,["onClick"])])),_:1})])),_:1})])),_:1},8,["model"])])),_:1})])),_:1})):c("",!0),"init"==s.inbound_task.status?(h(),_(J,{key:1,title:"2. 提交物料数量",type:"square"},{default:m((()=>[s.form.material_id?(h(),_(Z,{key:0},{default:m((()=>[u(X,{title:s.form.material_no,note:[`名称：${s.form.material_name}`,`规格：${s.form.material_spec}`].join("\n"),thumb:o.thumbnail_url(s.form.material_image),"thumb-size":"lg"},null,8,["title","note","thumb"])])),_:1})):(h(),_(Z,{key:1},{default:m((()=>[u(X,{"show-extra-icon":!0,"extra-icon":{type:"info",size:"24",color:"#007bff"},title:"请先查询获取物料信息"})])),_:1})),u(G,{class:"container"},{default:m((()=>[u(K,{ref:"form",model:s.form,rules:s.form_rules,labelWidth:"70px"},{default:m((()=>[u(Q,{name:"material_id",style:{height:"0"}}),u(Q,{label:"物料数量",name:"base_unit_qty"},{default:m((()=>[u(E,{modelValue:s.form.base_unit_qty,"onUpdate:modelValue":e[4]||(e[4]=t=>s.form.base_unit_qty=t),type:"number",focus:s.form.base_unit_qty_focus,onConfirm:o.add_to_inbound_task},{right:m((()=>[u(H,{class:"easyinput-suffix-text"},{default:m((()=>[p(b(s.form.base_unit_name),1)])),_:1})])),_:1},8,["modelValue","focus","onConfirm"])])),_:1}),u(A,{onClick:o.add_to_inbound_task,type:"primary"},{default:m((()=>[u(P,{type:"checkmarkempty",color:"#fff"}),p(" 提交 ")])),_:1},8,["onClick"])])),_:1},8,["model","rules"])])),_:1})])),_:1})):c("",!0),(null==(n=s.inbound_task.inbound_list)?void 0:n.length)?(h(),_(J,{key:2,title:"当前物料信息",type:"square","sub-title":s.inbound_task.bill_no,"sub-title-color":"#007aff",class:"above-uni-goods-nav"},{default:m((()=>[u(Z,null,{default:m((()=>[(h(!0),r(d,null,k(s.inbound_task.inbound_list,((t,e)=>(h(),_(X,{key:e,onClick:e=>o.if_new_plan(t.material_no),clickable:"","show-arrow":""},{body:m((()=>[u(G,{class:"uni-list-item__body"},{default:m((()=>[u(H,{class:"title"},{default:m((()=>[p(b(t.material_no),1)])),_:2},1024),u(G,{class:"note"},{default:m((()=>[u(G,null,{default:m((()=>[p("名称："+b(t.material_name),1)])),_:2},1024),u(G,null,{default:m((()=>[p("规格："+b(t.material_spec),1)])),_:2},1024),t.src_stock_name?(h(),_(G,{key:0},{default:m((()=>[p("调出仓库："+b(t.src_stock_name),1)])),_:2},1024)):c("",!0),u(G,null,{default:m((()=>[p("调入仓库："),u(H,{class:"text-primary"},{default:m((()=>[p(b(t.dest_stock_name),1)])),_:2},1024)])),_:2},1024),u(G,null,{default:m((()=>[p("批次："+b(t.batch_no),1)])),_:2},1024)])),_:2},1024)])),_:2},1024)])),footer:m((()=>[u(G,{class:"uni-list-item__foot"},{default:m((()=>[u(H,null,{default:m((()=>[p(b(t.base_unit_qty)+" "+b(t.base_unit_name),1)])),_:2},1024),u(tt,{percent:o._calc_percentage(t),"stroke-width":"2","active-color":100==o._calc_percentage(t)?"#4cd964":"#f0ad4e"},null,8,["percent","active-color"])])),_:2},1024)])),_:2},1032,["onClick"])))),128))])),_:1})])),_:1},8,["sub-title"])):c("",!0),u(G,{class:"uni-goods-nav-wrapper"},{default:m((()=>[u(et,{options:s.goods_nav.options,"button-group":s.goods_nav.button_group,fill:t.$store.state.goods_nav_fill,onClick:o.goods_nav_click,onButtonClick:o.goods_nav_button_click},null,8,["options","button-group","fill","onClick","onButtonClick"])])),_:1}),s.is_completed?(h(),_(at,{key:3,src:R,class:"cover-image"})):c("",!0),u(st,{ref:"search_drawer",width:t.$store.state.drawer_width},{default:m((()=>[u(it,{"scroll-y":"",style:{height:"100%"},onTouchmove:e[6]||(e[6]=g((()=>{}),["stop"]))},{default:m((()=>[u(J,{title:`模糊匹配：${s.form.material_no}`,type:"square","sub-title":"最多展示20条匹配结果"},{right:m((()=>[u(G,{class:"uni-section__right"},{default:m((()=>[u(P,{type:"closeempty",size:"24",color:"#333",onClick:e[5]||(e[5]=e=>t.$refs.search_drawer.close())})])),_:1})])),default:m((()=>[u(Z,null,{default:m((()=>[(h(!0),r(d,null,k(s.search_form.candidates,((t,e)=>(h(),_(X,{key:e,title:t.FNumber,note:[`名称：${t.FName}`,`规格：${t.FSpecification}`].join("\n"),thumb:o.thumbnail_url(t.FImageFileServer),"thumb-size":"lg",onClick:e=>o.select_material(t),clickable:"","show-arrow":""},null,8,["title","note","thumb","onClick"])))),128))])),_:1})])),_:1},8,["title"])])),_:1})])),_:1},8,["width"]),u(st,{ref:"detail_drawer",width:t.$store.state.drawer_width},{default:m((()=>[u(it,{"scroll-y":"",style:{height:"100%"},onTouchmove:e[8]||(e[8]=g((()=>{}),["stop"]))},{default:m((()=>[u(J,{title:"操作明细",type:"square","sub-title":"init"==s.inbound_task.status&&"app-plus"==t.$store.state.device_type?"左滑可删除":""},{right:m((()=>[u(G,{class:"uni-section__right"},{default:m((()=>[u(P,{type:"closeempty",size:"24",color:"#333",onClick:e[7]||(e[7]=e=>t.$refs.detail_drawer.close())})])),_:1})])),default:m((()=>[u(nt,{ref:"swipe_action"},{default:m((()=>[(h(!0),r(d,null,k(s.inbound_task.inbound_list,((e,a)=>(h(),_(ot,{key:a,threshold:60,"right-options":"init"==s.inbound_task.status?s.swipe_options:[],onClick:t=>o.swipe_action_click(t,e._id)},{default:m((()=>[u(X,null,{body:m((()=>[u(G,{class:"uni-list-item__body"},{default:m((()=>[u(H,{class:"title"},{default:m((()=>[p(b(e.material_no),1)])),_:2},1024),u(G,{class:"note"},{default:m((()=>[u(G,null,{default:m((()=>[p("名称："+b(e.material_name),1)])),_:2},1024),u(G,null,{default:m((()=>[p("规格："+b(e.material_spec),1)])),_:2},1024),u(G,null,{default:m((()=>[p("提交时间："+b(o.formatDate(e.created_at,"yyyy-MM-dd hh:mm:ss")),1)])),_:2},1024)])),_:2},1024)])),_:2},1024)])),footer:m((()=>[u(G,{class:"uni-list-item__foot flex-row"},{default:m((()=>[u(G,null,{default:m((()=>[p(b(e.base_unit_qty)+" "+b(e.base_unit_name),1)])),_:2},1024),"h5"==t.$store.state.device_type?(h(),_(G,{key:0},{default:m((()=>[u(P,{type:"trash",size:"24",color:"#dd524d",onClick:t=>o.delete_inbound_list(e._id),class:"uni-ml-5"},null,8,["onClick"])])),_:2},1024)):c("",!0)])),_:2},1024)])),_:2},1024)])),_:2},1032,["right-options","onClick"])))),128))])),_:1},512)])),_:1},8,["sub-title"])])),_:1})])),_:1},8,["width"])],64)}],["__scopeId","data-v-0f4e295f"]]);export{J as default};
