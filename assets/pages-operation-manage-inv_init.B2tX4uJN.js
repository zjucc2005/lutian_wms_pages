import{s as t,ap as a,a as e,h as o,b as i,c as n,q as s,e as l,w as r,F as _,i as d,o as c,f as u,u as f,d as p,t as m}from"./index-MIvYX1nW.js";import{_ as g}from"./uni-notice-bar.BrdymbPY.js";import{r as h}from"./uni-app.es.B8zr0lZI.js";import{_ as v,a as b,b as k}from"./uni-td.B3Sq6FHr.js";import{_ as w}from"./uni-table.CMkDOYII.js";import{_ as x}from"./uni-section.C7O4oyAr.js";import{_ as F}from"./uni-goods-nav.DSaXBg-u.js";import{X as j}from"./xlsx.uBlg2PW8.js";import"./k3cloudapi.DzDu3BGl.js";import"./stock_loc.BckAHwoS.js";import{I as y}from"./inv_log.BJcJnepW.js";import{a as $}from"./index.C26QB1B8.js";import{_ as I}from"./_plugin-vue_export-helper.BCo6x5W8.js";import"./uni-icons.DEYikQDp.js";import"./uni-datetime-picker.D11eskE5.js";import"./bd_empinfo.CFj7JuJN.js";const N=I({data:()=>({bd_materials:[],is_valid:!1,new_invs:[],goods_nav:{options:[{icon:"refreshempty",text:"刷新"}],button_group:[{text:"读取文件",backgroundColor:t.state.goods_nav_color.red,color:"#fff"},{text:"获取物料ID",backgroundColor:t.state.goods_nav_color.yellow,color:"#fff"},{text:"确认导入",backgroundColor:t.state.goods_nav_color.blue,color:"#fff"}]}}),mounted(){},methods:{goods_nav_click(t){0===t.index&&this.$logger.info("this.$data",this.$data)},goods_nav_button_click(t){0===t.index&&this.open_excel(),1===t.index&&this.validate_data(),2===t.index&&this.import_data()},open_excel(){let t=this;a({count:1,extension:[".xlsx",".xls"],success(a){let i=a.tempFiles[0];i.name.split(".").pop();var n=new FileReader;n.onload=function(a){let i=a.target.result,n=j.read(i,{type:"binary"}),s=n.Sheets[n.SheetNames[0]],l=j.utils.sheet_to_json(s,{header:1});e({title:"解析数据..."}),t.handle_sheet_data(l),o()},n.readAsBinaryString(i)}})},async handle_sheet_data(t){"LOC_NO"==t[0][0]&&t.shift();let a=[];for(let e of t)a.push({material_id:0,material_no:e[1],loc_no:`NX3-${e[0]}`,qty:e[4],batch_no:"20250121"});this.new_invs=a},async validate_data(){var a;let e=!0;this.$logger.info("stock_locs",t.state.stock_locs);for(var o=0;o<this.new_invs.length;o++){let i=this.new_invs[o],n=this.bd_materials.find((t=>t.FNumber==i.material_no));if(n)i.material_id=n.FMaterialId;else{let o=await $(i.material_no,t.state.cur_stock.FUseOrgId);if(!o.data[0]){e=!1,this.$logger.info(`>>> validate: 物料编号 ${i.material_no} 未找到`);break}i.material_id=null==(a=o.data[0])?void 0:a.FMaterialId,this.bd_materials.push(o.data[0])}if(!t.state.stock_locs.find((t=>t.FNumber==i.loc_no))){e=!1,this.$logger.info(`>>> validate: 库位编号 ${i.loc_no} 未找到`);break}}this.is_valid=e},async import_data(){for(var a=0;a<this.new_invs.length;a++){let e=this.new_invs[a],o=new y({FOpType:"in",FStockId:t.state.cur_stock.FStockId,FStockLocNo:e.loc_no,FMaterialId:e.material_id,FOpQTY:e.qty,FBatchNo:e.batch_no,FOpStaffNo:t.state.cur_staff.FNumber,FRemark:"期初库存"});await o.save(),i({icon:"none",title:`${a+1}/${this.new_invs.length}`})}this.new_invs=[]}}},[["render",function(t,a,e,o,i,j){const y=h(n("uni-notice-bar"),g),$=h(n("uni-th"),v),I=h(n("uni-tr"),b),N=h(n("uni-td"),k),C=h(n("uni-table"),w),S=h(n("uni-section"),x),O=h(n("uni-goods-nav"),F),q=d;return c(),s(_,null,[l(y,{single:"",scrollable:"",text:"本功能建议仅在初始化库存时使用"}),l(S,{title:"期初库存(草稿)",type:"square",class:"above-uni-goods-nav"},{default:r((()=>[l(C,{ref:"new_invs",border:"",stripe:"",class:"new-invs"},{default:r((()=>[l(I,null,{default:r((()=>[l($,{align:"center",width:"60"},{default:r((()=>[u("物料ID")])),_:1}),l($,{align:"center",width:"80"},{default:r((()=>[u("物料编号")])),_:1}),l($,{align:"center",width:"80"},{default:r((()=>[u("库位")])),_:1}),l($,{align:"center",width:"60"},{default:r((()=>[u("数量")])),_:1}),l($,{align:"center"},{default:r((()=>[u("批次")])),_:1})])),_:1}),(c(!0),s(_,null,f(i.new_invs,((t,a)=>(c(),p(I,{key:a},{default:r((()=>[l(N,{align:"center"},{default:r((()=>[u(m(t.material_id),1)])),_:2},1024),l(N,{align:"center"},{default:r((()=>[u(m(t.material_no),1)])),_:2},1024),l(N,{align:"center"},{default:r((()=>[u(m(t.loc_no),1)])),_:2},1024),l(N,{align:"center"},{default:r((()=>[u(m(t.qty),1)])),_:2},1024),l(N,{align:"center"},{default:r((()=>[u(m(t.batch_no),1)])),_:2},1024)])),_:2},1024)))),128))])),_:1},512)])),_:1}),l(q,{class:"uni-goods-nav-wrapper"},{default:r((()=>[l(O,{options:i.goods_nav.options,"button-group":i.goods_nav.button_group,fill:t.$store.state.goods_nav_fill,onClick:j.goods_nav_click,onButtonClick:j.goods_nav_button_click},null,8,["options","button-group","fill","onClick","onButtonClick"])])),_:1})],64)}],["__scopeId","data-v-7eab5d9f"]]);export{N as default};
