import{s as e,P as t,b as a,p as i,n,a as o,h as s,c as r,q as l,e as _,w as c,F as u,i as m,o as d,d as p,f,u as g,g as h,t as v,j as k}from"./index-MIvYX1nW.js";import{_ as b}from"./uni-easyinput.BboSH9MB.js";import{r as y}from"./uni-app.es.B8zr0lZI.js";import{_ as C,a as x,b as j}from"./uni-td.B3Sq6FHr.js";import{_ as F}from"./uni-tag.DOImtkHb.js";import{_ as I}from"./uni-table.CMkDOYII.js";import{_ as w}from"./uni-list-item.Dk-snU2X.js";import{_ as $}from"./uni-list.zX7C8YBn.js";import{_ as M}from"./uni-load-more.5aGCwx5G.js";import{_ as N}from"./uni-section.C7O4oyAr.js";import{_ as U}from"./uni-goods-nav.DSaXBg-u.js";import{l as q,p as L}from"./index.DbF5UMRK.js";import{K as S}from"./k3cloudapi.DzDu3BGl.js";import{I as D}from"./stock_loc.BckAHwoS.js";import"./inv_log.BJcJnepW.js";import{s as V}from"./scan_code.bSbj3X8t.js";import{_ as B}from"./_plugin-vue_export-helper.BCo6x5W8.js";import"./uni-icons.DEYikQDp.js";import"./uni-datetime-picker.D11eskE5.js";import"./uni-badge.DDwx_b0i.js";const O=B({data:()=>({invs:[],inv_groups:[],last_refresh_time:0,refresh_interval:3e4,search_form:{no:""},goods_nav:{options:[{icon:"refreshempty",text:"刷新"},{icon:"more-filled",text:"更多"}],button_group:[{text:"扫码查询",backgroundColor:e.state.goods_nav_color.red,color:"#fff"},{text:"库存地图",backgroundColor:e.state.goods_nav_color.green,color:"#fff"}]}}),onPullDownRefresh(){this.refresh(),t()},mounted(){this.load_invs()},methods:{link_to:q,goods_nav_click(e){0===e.index&&this.refresh(),1===e.index&&this.more()},goods_nav_button_click(e){0===e.index&&this.scan_code(),1===e.index&&this.inv_map()},searchbar_icon_click(e){"prefix"==e&&this.scan_code()},scan_code(){V().then((e=>{console.log("scan code:",e.result),this.search_form.no=this.parse_scan_code(e.result)})).catch((e=>{a({icon:"none",title:e})}))},parse_scan_code:e=>e.includes("||")?e.split("||")[1]:e,inv_menu(e){e.material_id?i({itemList:["库存明细","库存调整","库存日志","物料详情"],success:t=>{0===t.tapIndex&&q(`/pages/operation/manage/inv_search?t=${e.material_no}&m=0`),1===t.tapIndex&&this.inv_modify(e.material_no),2===t.tapIndex&&q(`/pages/operation/list/inv_logs?material_no=${e.material_no}`),3===t.tapIndex&&q(`/pages/operation/material/show?id=${e.material_id}`)}}):a({icon:"none",title:"物料ID不能为空"})},inv_modify(t){e.state.role.includes("admin")?q(`/pages/operation/move/v2/plan_new?material_no=${obj.material_no}`):a({icon:"error",title:"无权限"})},inv_map(){n({url:"/pages/operation/manage/inv_map",success:e=>{L("success"),e.eventChannel.emit("sendInvs",{invs:this.invs})}})},more(){e.state.role.includes("admin")&&i({itemList:["库存盘点"],success:e=>{0===e.tapIndex&&(L("success"),n({url:"/pages/operation/manage/inv_check",success:e=>{L("success")}}))}})},async load_invs(){const t={FStockId:e.state.cur_stock.FStockId};o({title:"Loading"});let a=await D.get_all(t);s(),this.invs=a,this.set_inv_groups(a),this.get_thumbnail()},async refresh(){this.last_refresh_time+this.refresh_interval>Date.now()?a({icon:"none",title:"请不要频繁刷新"}):(await this.load_invs(),this.last_refresh_time=Date.now())},inv_groups_filtered(){let e=this.search_form.no.trim();if(!e)return this.inv_groups;let t=e.split("+");if(!(t.length>2))return this.inv_groups.filter((e=>{for(let a of t)if(!(e.material_no.includes(a)||e.material_name.toUpperCase().includes(a.toUpperCase())||e.material_spec.toUpperCase().includes(a.toUpperCase())))return!1;return!0}));a({icon:"error",title:"最多支持2个关键词"})},set_inv_groups(e){let t=[];e.forEach((e=>{let a=t.find((t=>t.material_id==e.FMaterialId));a?a.qty+=e.FQty:t.push({material_id:e.FMaterialId,material_no:e["FMaterialId.FNumber"],material_name:e["FMaterialId.FName"],material_spec:e["FMaterialId.FSpecification"],material_image:e["FMaterialId.FImageFileServer"],qty:e.FQty,base_unit_name:e["FStockUnitId.FName"],thumbnail:"/static/default_40x40.png"})})),this.inv_groups=t},async get_thumbnail(){for(let e of this.inv_groups){let t=await S.thumbnail_url(e.material_image);e.thumbnail=t}}}},[["render",function(e,t,a,i,n,o){const s=y(r("uni-easyinput"),b),q=m,L=y(r("uni-th"),C),S=y(r("uni-tr"),x),D=y(r("uni-td"),j),V=k,B=y(r("uni-tag"),F),O=y(r("uni-table"),I),P=y(r("uni-list-item"),w),Q=y(r("uni-list"),$),G=y(r("uni-load-more"),M),K=y(r("uni-section"),N),R=y(r("uni-goods-nav"),U);return d(),l(u,null,[_(K,{title:"当前仓库",type:"square","sub-title":[e.$store.state.cur_stock["FUseOrgId.FName"],e.$store.state.cur_stock["FGroup.FName"]||"未分组",e.$store.state.cur_stock.FName].join(" / "),"sub-title-color":"#007aff",class:"above-uni-goods-nav",onClick:t[1]||(t[1]=t=>e.$logger.info(">>>",this.$data))},{default:c((()=>[_(q,{class:"searchbar-container"},{default:c((()=>[_(s,{modelValue:n.search_form.no,"onUpdate:modelValue":t[0]||(t[0]=e=>n.search_form.no=e),placeholder:"请输入搜索内容","prefix-icon":"scan",onIconClick:o.searchbar_icon_click,"primary-color":"rgb(238, 238, 238)",styles:{color:"#000",backgroundColor:"rgb(238, 238, 238)",borderColor:"rgb(238, 238, 238)",height:"100px"}},null,8,["modelValue","onIconClick","styles"])])),_:1}),"h5"===e.$store.state.screen_type?(d(),p(O,{key:0,ref:"table",border:"",stripe:""},{default:c((()=>[_(S,null,{default:c((()=>[_(L,{align:"center",width:"60"},{default:c((()=>[f("序号")])),_:1}),_(L,{align:"center",width:"60"},{default:c((()=>[f("ICON")])),_:1}),_(L,{align:"center"},{default:c((()=>[f("物料编码")])),_:1}),_(L,{align:"center"},{default:c((()=>[f("物料名称")])),_:1}),_(L,{align:"center"},{default:c((()=>[f("规格型号")])),_:1}),_(L,{align:"center"},{default:c((()=>[f("单位")])),_:1}),_(L,{align:"center"},{default:c((()=>[f("数量")])),_:1}),_(L,{align:"center",width:"230"},{default:c((()=>[f("操作")])),_:1})])),_:1}),(d(!0),l(u,null,g(o.inv_groups_filtered(),((e,t)=>(d(),p(S,{key:t},{default:c((()=>[_(D,{align:"center"},{default:c((()=>[f(v(t+1),1)])),_:2},1024),_(D,null,{default:c((()=>[_(V,{src:e.thumbnail,mode:"aspectFill",class:"thumbnail"},null,8,["src"])])),_:2},1024),_(D,null,{default:c((()=>[_(q,{class:"text-primary",onClick:t=>o.link_to(`/pages/operation/material/show?id=${e.material_id}`)},{default:c((()=>[f(v(e.material_no),1)])),_:2},1032,["onClick"])])),_:2},1024),_(D,null,{default:c((()=>[f(v(e.material_name),1)])),_:2},1024),_(D,null,{default:c((()=>[f(v(e.material_spec),1)])),_:2},1024),_(D,{align:"center"},{default:c((()=>[f(v(e.base_unit_name),1)])),_:2},1024),_(D,{align:"center"},{default:c((()=>[f(v(e.qty),1)])),_:2},1024),_(D,{align:"center"},{default:c((()=>[_(B,{text:"库存明细",type:"primary",inverted:"",onClick:t=>o.link_to(`/pages/operation/manage/inv_search?t=${e.material_no}&m=0`)},null,8,["onClick"]),_(B,{text:"库存调整",type:"primary",onClick:t=>o.inv_modify(e.material_no),class:"uni-ml-2"},null,8,["onClick"]),_(B,{text:"库存日志",type:"primary",inverted:"",onClick:t=>o.link_to(`/pages/operation/list/inv_logs?material_no=${e.material_no}`),class:"uni-ml-2"},null,8,["onClick"])])),_:2},1024)])),_:2},1024)))),128))])),_:1},512)):(d(),p(Q,{key:1},{default:c((()=>[(d(!0),l(u,null,g(o.inv_groups_filtered(),((e,t)=>(d(),p(P,{key:t,title:e.material_no,note:[`名称：${e.material_name}`,`规格：${e.material_spec}`].join("\n"),thumb:e.thumbnail,"thumb-size":"lg",rightText:[e.qty,e.base_unit_name].join(" "),onClick:t=>o.inv_menu(e),clickable:"","show-arrow":"",onLongpress:t=>o.inv_menu(e)},null,8,["title","note","thumb","rightText","onClick","onLongpress"])))),128))])),_:1})),0===n.inv_groups.length?(d(),p(G,{key:2,status:"nomore"})):h("",!0)])),_:1},8,["sub-title"]),_(q,{class:"uni-goods-nav-wrapper"},{default:c((()=>[_(R,{options:n.goods_nav.options,"button-group":n.goods_nav.button_group,fill:e.$store.state.goods_nav_fill,onClick:o.goods_nav_click,onButtonClick:o.goods_nav_button_click},null,8,["options","button-group","fill","onClick","onButtonClick"])])),_:1})],64)}],["__scopeId","data-v-4623c806"]]);export{O as default};
