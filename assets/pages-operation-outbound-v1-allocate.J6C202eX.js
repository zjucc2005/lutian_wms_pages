import{s as t,x as e,p as o,n as i,m as a,b as s,a as n,h as c,c as u,d as l,w as _,i as r,o as d,q as h,u as m,F as f,e as k,f as F,t as b,g as p,k as g,y as v,z as y}from"./index-DjNCOAYS.js";import{_ as I}from"./uni-icons.CZYyaTue.js";import{r as q}from"./uni-app.es.Ch8d-HxS.js";import{_ as N}from"./uni-badge.DRmKIMEp.js";import{_ as x}from"./uni-list-item.Dm5ieig7.js";import{_ as S}from"./uni-list.p66-62vf.js";import{_ as j}from"./uni-section.Cyvrqc16.js";import{_ as C}from"./uni-goods-nav.BCKosiBH.js";import{p as E}from"./index.uJty1kg6.js";import"./k3cloudapi.B_cIKn_3.js";import{I as T}from"./stock_loc.GXV191SF.js";import{I as Q}from"./inv_log.B3mwqkWu.js";import{_ as B}from"./_plugin-vue_export-helper.BCo6x5W8.js";const M=B({data:()=>({cur_stock:{},cur_staff:{},cur_outbound_task:{},invs:[],inv_logs:[],goods_nav:{options:[{icon:"more-filled",text:"更多"}],button_group:[{text:"自动分配",backgroundColor:"linear-gradient(90deg, #FFCD1E, #FF8A18)",color:"#fff"},{text:"批量下架",backgroundColor:"linear-gradient(90deg, #1E83FF, #0053B8)",color:"#fff"}]}}),mounted(){this.cur_stock=t.state.cur_stock,this.cur_staff=t.state.cur_staff},onShow(){this.cur_outbound_task=e("cur_outbound_task"),this.load_invs()},methods:{goods_nav_click(t){0===t.index&&this.more_actions()},goods_nav_button_click(t){0===t.index&&this.if_auto_allocate(),1===t.index&&this.if_submit_batch_unmount()},more_actions(){o({itemList:["扫描下架","出库详情","操作日志"],success:t=>{0===t.tapIndex&&i({url:"/pages/operation/outbound/v1/unmount"}),1===t.tapIndex&&i({url:"/pages/operation/outbound/v1/task"}),2===t.tapIndex&&i({url:"/pages/operation/outbound/v1/logs"})}})},if_auto_allocate(){this.invs.some((t=>t.checked))?a({title:"自动分配注意事项",content:"当前已有库存分配信息，开始自动分配后，将会清除之前的分配并产生新的分配，自动分配遵循先入先出原则",success:t=>{t.confirm&&this.auto_allocate()},fail:t=>{}}):this.auto_allocate()},auto_allocate(){this.invs.forEach((t=>{t.checked=!1,t.checked_qty=0,t.disabled=!1})),this.cur_outbound_task.outbound_list.forEach((t=>{let e=t.base_unit_qty-t.unmounted_qty,o=0;this.invs.map((i=>{if(i["FMaterialId.FNumber"]==t.material_no)if(e-o>0){let t=Math.min(i.FQty,e-o);i.checked=!0,i.checked_qty=t,o+=t}else i.disabled=!0})),t.checked_qty=o}))},if_submit_batch_unmount(){this.invs.some((t=>t.checked))?a({title:"确认下架注意事项",content:"请仔细核对下架信息，确认下架操作后，将会批量扣减库存。",success:t=>{t.confirm&&this.submit_batch_unmount()},fail:t=>{}}):s({icon:"none",title:"未勾选任何库存"})},submit_batch_unmount(){E("success"),n({title:"Loading"}),this.invs.filter((t=>t.checked)).forEach((t=>{new Q({FOpType:"out",FStockId:t.FStockId,FStockLocNo:t["FStockLocId.FNumber"],FMaterialId:t.FMaterialId,FOpQTY:t.checked_qty,FBatchNo:t.FBatchNo,FBillNo:this.cur_outbound_task.bill_no,FOpStaffNo:this.cur_staff.FNumber}).save()})),this.after_save(),c()},after_save(){this.load_invs()},handle_inv_check(t,e){let o=this.invs.filter((t=>t["FMaterialId.FNumber"]==e.material_no)),i=e.base_unit_qty-e.unmounted_qty,a=0,s=t.detail.value.map((t=>1*t)),n=[],c=null;if(o.forEach((t=>{t.checked&&(s.includes(t.FID)?(n.push(t.FID),a+=t.checked_qty):(t.checked=!1,t.checked_qty=0)),t.disabled=!1})),s.forEach((t=>{n.includes(t)||(c=t)})),c){let t=o.find((t=>t.FID==c)),e=Math.min(t.FQty,i-a);t.checked=!0,t.checked_qty=e,a+=e}a<i?o.forEach((t=>{if(n.includes(t.FID)&&t.FQty-t.checked_qty>0){let e=Math.min(t.FQty-t.checked_qty,i-a);t.checked_qty+=e,a+=e}})):o.forEach((t=>t.disabled=!t.checked)),e.checked_qty=a},load_invs(){const t={FStockId:this.cur_stock.FStockId,"FMaterialId.FNumber_in":this.cur_outbound_task.outbound_list.map((t=>t.material_no)),FQty_gt:0};T.query(t,{order:"FBatchNo ASC, FStockLocId.FNumber ASC"}).then((t=>{this.invs=t.data,this.load_inv_logs()}))},search_invs(t){i({url:"/pages/operation/manage/inv_search?t="+t})},load_inv_logs(){Q.query({FStockId:this.cur_stock.FStockId,FBillNo:this.cur_outbound_task.bill_no,FOpType_in:["out","out_cl"]},{page:1,per_page:5,order:"FCreateTime DESC"}).then((t=>{this.inv_logs=[],t.data.reverse().forEach((t=>this.unshift_inv_log(t))),this.cur_outbound_task.outbound_list.forEach((t=>{let e=0;this.filter_inv_logs(t.material_no).forEach((t=>e+=t.FOpQTY)),t.unmounted_qty=e,t.checked_qty=0,e>t.base_unit_qty&&this.filter_invs(t.material_no).forEach((t=>t.disabled=!0))}))}))},unshift_inv_log(t){if("out_cl"==t.FOpType){let e=this.inv_logs.find((e=>e.FID===t.FReferId));e&&(e.status="已取消")}this.inv_logs.unshift(t)},filter_invs(t){return this.invs.filter((e=>e["FMaterialId.FNumber"]==t))},filter_inv_logs(t){return this.inv_logs.filter((e=>e["FMaterialId.FNumber"]==t&&"out"==e.FOpType&&!e.status))}}},[["render",function(t,e,o,i,a,s){const n=q(u("uni-icons"),I),c=g,E=r,T=v,Q=q(u("uni-badge"),N),B=q(u("uni-list-item"),x),M=y,D=q(u("uni-list"),S),O=q(u("uni-section"),j),L=q(u("uni-goods-nav"),C);return d(),l(E,null,{default:_((()=>[(d(!0),h(f,null,m(a.cur_outbound_task.outbound_list,((t,e)=>(d(),l(O,{key:e,title:t.material_no,"sub-title":[t.material_name,t.material_spec].join("\n")},{decoration:_((()=>[k(n,{onClick:e=>s.search_invs(t.material_no),type:"search",size:"30",color:"#007aff",class:"uni-section-icon"},null,8,["onClick"])])),right:_((()=>[k(E,{class:"uni-section-right-text"},{default:_((()=>[t.unmounted_qty||t.checked_qty?(d(),l(c,{key:0},{default:_((()=>[F(b(t.unmounted_qty+t.checked_qty)+" /",1)])),_:2},1024)):p("",!0),F(" "+b([t.base_unit_qty,t.base_unit_name].join(" ")),1)])),_:2},1024)])),default:_((()=>[k(D,null,{default:_((()=>[k(M,{onChange:e=>s.handle_inv_check(e,t)},{default:_((()=>[(d(!0),h(f,null,m(s.filter_invs(t.material_no),((t,e)=>(d(),l(B,{key:e,title:`库位号：${t["FStockLocId.FNumber"]}`,note:`批次号: ${t.FBatchNo}`,rightText:[t.FQty,t["FStockUnitId.FName"]].join(" ")},{header:_((()=>[k(E,{class:"uni-list-item-header"},{default:_((()=>[k(T,{value:t.FID.toString(),checked:t.checked,disabled:t.disabled},null,8,["value","checked","disabled"])])),_:2},1024)])),footer:_((()=>[k(E,{class:"uni-list-item-footer"},{default:_((()=>[k(c,null,{default:_((()=>[F(b([t.FQty,t["FStockUnitId.FName"]].join(" ")),1)])),_:2},1024),k(Q,{text:-t.checked_qty,size:"normal",class:"unmount-qty"},null,8,["text"])])),_:2},1024)])),_:2},1032,["title","note","rightText"])))),128))])),_:2},1032,["onChange"]),(d(!0),h(f,null,m(s.filter_inv_logs(t.material_no),((t,e)=>(d(),l(B,{key:e,title:`库位号：${t["FStockLocId.FNumber"]}`,note:`批次号: ${t.FBatchNo}`,rightText:`已下架 ${[t.FOpQTY,t["FStockUnitId.FName"]].join(" ")}`},{header:_((()=>[k(E,{class:"uni-list-item-header"},{default:_((()=>[k(T,{value:t.FID.toString(),checked:!0,disabled:!0},null,8,["value"])])),_:2},1024)])),_:2},1032,["title","note","rightText"])))),128))])),_:2},1024)])),_:2},1032,["title","sub-title"])))),128)),k(E,{class:"uni-goods-nav-wrapper"},{default:_((()=>[k(L,{options:a.goods_nav.options,"button-group":a.goods_nav.button_group,onClick:s.goods_nav_click,onButtonClick:s.goods_nav_button_click},null,8,["options","button-group","onClick","onButtonClick"])])),_:1})])),_:1})}],["__scopeId","data-v-b68ab3ce"]]);export{M as default};
