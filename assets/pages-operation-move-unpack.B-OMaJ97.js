import{s as t,b as a,n as e,a as l,h as i,c as s,q as o,e as n,w as r,d as _,g as c,F as d,i as u,o as m,f,t as F,u as h,k as p,K as y,L as k,M as b}from"./index-DGWOUQdM.js";import{_ as g}from"./uni-easyinput.l7FUzy_X.js";import{r as I}from"./uni-app.es.DKZsoyMd.js";import{_ as v}from"./uni-section.Dvy4SRsN.js";import{_ as N,a as C,b as S}from"./uni-td.zb0VuMhS.js";import{_ as M}from"./uni-tag.BV5eTfZ0.js";import{_ as B}from"./uni-table.6E3sqkPu.js";import{_ as q}from"./uni-list-item.BnynrAPo.js";import{_ as w}from"./uni-list.Kn4QrsAX.js";import{_ as j}from"./uni-card.BKgpCmSo.js";import{_ as x}from"./uni-goods-nav.BwI3ErB8.js";import{p as Q}from"./index.JIux-90-.js";import{s as U}from"./scan_code.CS8963f7.js";import"./k3cloudapi.CbDqg_He.js";import{a as A}from"./stock_loc.C36uFwb2.js";import"./inv_log.OihDyY2r.js";import{P}from"./prd_issue_mtr_notice.ymDHJ4tV.js";import{S as D,a as $,P as E}from"./stk_out_stock_apply.Bhki5iRX.js";import{_ as Z}from"./yiwancheng_stamp.fi2kVvVZ.js";import{_ as L}from"./_plugin-vue_export-helper.BCo6x5W8.js";import{f as W}from"./date-format.Dm3Q97cL.js";import"./uni-icons.LDhtL0t0.js";import"./uni-datetime-picker.CztCdWST.js";import"./uni-badge._gn3hy42.js";const R=L({data:()=>({scfl:[],scfl_todo:[],inv_plans:[],inv_plans_map:{},multiuser:!1,search_form:{bill_no:""},goods_nav:{options:[{icon:"close",text:"清空",info:""}],button_group:[{text:"扫描单据",backgroundColor:t.state.goods_nav_color.red,color:"#fff"}]}}),onShow(){this.search_form.bill_no?this.load_inv_plans():this.load_scfl_todo()},mounted(){},computed:{is_completed(){let t=!0;if(this.scfl.length){for(let a of this.scfl)if(!this.inv_plans_map[a.material_id]||this.inv_plans_map[a.material_id]<a.must_qty){t=!1;break}}else t=!1;return t}},methods:{goods_nav_click(t){0===t.index&&(this.$logger.info("this.$data",this.$data),this.search_form.bill_no="",this.handle_search())},goods_nav_button_click(t){0===t.index&&this.scan_code()},searchbar_icon_click(t){"prefix"==t&&this.scan_code()},switch_click(t){this.multiuser=t.detail.value,this.handle_search()},scan_code(){U().then((t=>{if(this.scfl.length){let e=this.scfl.find((a=>a.material_no==t.result));e?this.allocate_loc_no(e):a({icon:"none",title:"物料编码不存在"})}else this.search_form.bill_no=t.result,this.handle_search()})).catch((t=>{a({icon:"none",title:t})}))},async handle_search(){this.scfl=[],this.inv_plans=[],this.search_form.bill_no&&(this.search_form.bill_no=this.search_form.bill_no.trim().toUpperCase(),this.search_form.bill_no.match(/^\d+$/)&&(this.search_form.bill_no="SCFLTZD"+this.search_form.bill_no),this.search_form.bill_no.startsWith("SCFLTZD")?await this.load_scfltzd():this.search_form.bill_no.startsWith("CKSQD")?await this.load_cksqd():this.search_form.bill_no.startsWith("JSCLL")?await this.load_jscll():this.search_form.bill_no.startsWith("CGTL")&&await this.load_cgtl(),await this.load_inv_plans()),this.scfl.length?this.goods_nav.button_group[0]={text:"扫描物料",backgroundColor:t.state.goods_nav_color.yellow,color:"#fff"}:this.goods_nav.button_group[0]={text:"扫描单据",backgroundColor:t.state.goods_nav_color.red,color:"#fff"}},allocate_loc_no(t){e({url:"/pages/operation/move/unpack_allocate",events:{eventOutput:t=>{}},success:a=>{Q("success"),a.eventChannel.emit("eventInput",{bill_no:this.search_form.bill_no,material:t})}})},async load_scfltzd(){try{l({title:"Loading"});let e={FBillNo:this.search_form.bill_no};this.multiuser?e.FStockId=t.state.cur_stock.FStockId:e.F_PAEZ_BaseProperty1=t.state.cur_staff.FName;let s=await P.query(e);if(i(),0===s.data.length)return void a({icon:"none",title:"没有相关数据"});let o=[];for(let t of s.data){let a=o.find((a=>a.material_id===t.FMaterialId));a?(a.must_qty+=t.FMustQty,a.base_must_qty+=t.FBaseMustQty):o.push({material_id:t.FMaterialId,material_no:t["FMaterialId.FNumber"],material_name:t["FMaterialId.FName"],material_spec:t["FMaterialId.FSpecification"],storekeeper:t.F_PAEZ_BaseProperty1,stock_id:t.FStockId,stock_name:t["FStockId.FName"],prd_line:t["F_PAEZ_Base.FName"],must_qty:t.FMustQty,unit_id:t.FUnitId1,unit_name:t["FUnitId1.FName"],base_must_qty:t.FBaseMustQty,base_unit_id:t.FBaseUnitId1,base_unit_name:t["FBaseUnitId1.FName"]})}this.scfl=o}catch(e){}},async load_cksqd(){try{l({title:"Loading"});let e={FBillNo:this.search_form.bill_no};this.multiuser?e.FStockId=t.state.cur_stock.FStockId:e["FMaterialId.F_PAEZ_Base1"]=t.state.cur_staff.FName;let s=await D.query(e);if(i(),0===s.data.length)return void a({icon:"none",title:"没有相关数据"});let o=[];for(let t of s.data){let a=o.find((a=>a.material_id===t.FMaterialId));a?(a.must_qty+=t.FQty,a.base_must_qty+=t.FBaseQty):o.push({material_id:t.FMaterialId,material_no:t["FMaterialId.FNumber"],material_name:t["FMaterialId.FName"],material_spec:t["FMaterialId.FSpecification"],storekeeper:t["FMaterialId.F_PAEZ_Base1"],stock_id:t.FStockId,stock_name:t["FStockId.FName"],prd_line:t["FDeptId.FName"],must_qty:t.FQty,unit_id:t.FUnitId,unit_name:t["FUnitId.FName"],base_must_qty:t.FBaseQty,base_unit_id:t.FBaseUnitId,base_unit_name:t["FBaseUnitId.FName"]})}this.scfl=o}catch(e){}},async load_jscll(){try{l({title:"Loading"});let e={FBillNo:this.search_form.bill_no};this.multiuser?e.FStockId=t.state.cur_stock.FStockId:e["FMaterialId.F_PAEZ_Base1"]=t.state.cur_staff.FName;let s=await $.query(e);if(i(),0===s.data.length)return void a({icon:"none",title:"没有相关数据"});let o=[];for(let t of s.data){let a=o.find((a=>a.material_id===t.FMaterialId));a?(a.must_qty+=t.FActualQty,a.base_must_qty+=t.FBaseActualQty):o.push({material_id:t.FMaterialId,material_no:t["FMaterialId.FNumber"],material_name:t["FMaterialId.FName"],material_spec:t["FMaterialId.FSpecification"],storekeeper:t["FMaterialId.F_PAEZ_Base1"],stock_id:t.FStockId,stock_name:t["FStockId.FName"],prd_line:t["FWorkShopId.FName"],must_qty:t.FActualQty,unit_id:t.FUnitId,unit_name:t["FUnitId.FName"],base_must_qty:t.FBaseActualQty,base_unit_id:t.FBaseUnitId,base_unit_name:t["FBaseUnitId.FName"]})}this.scfl=o}catch(e){}},async load_cgtl(){try{l({title:"Loading"});let e={FBillNo:this.search_form.bill_no,FStockId:t.state.cur_stock.FStockId},s=await E.query(e);if(i(),0===s.data.length)return void a({icon:"none",title:"没有相关数据"});let o=[];for(let t of s.data){let a=o.find((a=>a.material_id===t.FMaterialId));a?(a.must_qty+=t.FRmRealQty,a.base_must_qty+=t.FRmRealQty):o.push({material_id:t.FMaterialId,material_no:t["FMaterialId.FNumber"],material_name:t["FMaterialId.FName"],material_spec:t["FMaterialId.FSpecification"],storekeeper:t["FMaterialId.F_PAEZ_Base1"],stock_id:t.FStockId,stock_name:t["FStockId.FName"],prd_line:t["FSupplierId.FName"],must_qty:t.FRmRealQty,unit_id:t.FUnitId,unit_name:t["FUnitId.FName"],base_must_qty:t.FRmRealQty,base_unit_id:t.FUnitId,base_unit_name:t["FUnitId.FName"]})}this.scfl=o}catch(e){}},async load_inv_plans(){var a;let e=await A.query({FBillNo:this.search_form.bill_no,FStockId:t.state.cur_stock.FStockId,FDocumentStatu:"C",FOpType:"mv"});this.inv_plans=e.data;let l={};for(let t of this.inv_plans)l[a=t.FMaterialId]||(l[a]=0),l[t.FMaterialId]+=t.FOpQTY;this.inv_plans_map=l},async load_scfl_todo(){let a=[];l({title:"Loading"});let e=await P.query({FDocumentStatus:"C",FCloseStatus:"A",F_PAEZ_BaseProperty1:t.state.cur_staff.FName,FCreateDate_ge:W(Date.now(),"yyyy-MM-dd")},{fields:["FBillNo","F_PAEZ_Base.FName"],order:"FCreateDate DESC"});for(let t of e.data){a.find((a=>a.bill_no==t.FBillNo))||a.push({bill_no:t.FBillNo,prd_line:t["F_PAEZ_Base.FName"]})}let s=await $.query({FDocumentStatus:"C","FMaterialId.F_PAEZ_Base1":t.state.cur_staff.FName,FCreateDate_ge:W(Date.now(),"yyyy-MM-dd")},{fields:["FBillNo","FWorkShopId.FName"],order:"FCreateDate DESC"});for(let t of s.data){a.find((a=>a.bill_no==t.FBillNo))||a.push({bill_no:t.FBillNo,prd_line:t["FWorkShopId.FName"]})}i(),this.scfl_todo=a}}},[["render",function(t,a,e,l,i,Q){var U;const A=p,P=y,D=I(s("uni-easyinput"),g),$=u,E=I(s("uni-section"),v),L=I(s("uni-th"),N),W=I(s("uni-tr"),C),R=I(s("uni-td"),S),T=I(s("uni-tag"),M),O=I(s("uni-table"),B),z=I(s("uni-list-item"),q),G=I(s("uni-list"),w),V=I(s("uni-card"),j),J=I(s("uni-goods-nav"),x),K=b;return m(),o(d,null,[n(E,{title:"查询单据编号",type:"square","sub-title":[t.$store.state.cur_stock["FUseOrgId.FName"],t.$store.state.cur_stock["FGroup.FName"]||"未分组",t.$store.state.cur_stock.FName].join(" / "),"sub-title-color":"#007aff",onClick:a[1]||(a[1]=a=>t.$logger.info(">>>",t.$data))},{right:r((()=>[n(A,{class:"text-grey text-sm"},{default:r((()=>[f(F(i.multiuser?"多人":"单人"),1)])),_:1}),n(P,{onChange:Q.switch_click,style:{transform:"scale(0.7)"}},null,8,["onChange"])])),default:r((()=>[n($,{class:"searchbar-container"},{default:r((()=>[n(D,{modelValue:i.search_form.bill_no,"onUpdate:modelValue":a[0]||(a[0]=t=>i.search_form.bill_no=t),placeholder:"请输入单据编号","prefix-icon":"scan",onConfirm:Q.handle_search,onClear:Q.handle_search,onIconClick:Q.searchbar_icon_click,"primary-color":"rgb(238, 238, 238)",styles:{color:"#000",backgroundColor:"rgb(238, 238, 238)",borderColor:"rgb(238, 238, 238)",height:"60px"}},null,8,["modelValue","onConfirm","onClear","onIconClick","styles"])])),_:1})])),_:1},8,["sub-title"]),i.scfl.length?(m(),_(E,{key:0,title:"子项明细",type:"square","sub-title":`${i.search_form.bill_no.startsWith("CGTL")?"供应商":"领用部门"}：${null==(U=i.scfl[0])?void 0:U.prd_line}`,"sub-title-color":"#007aff",class:"above-uni-goods-nav"},{default:r((()=>["h5"===t.$store.state.screen_type?(m(),_(O,{key:0,ref:"table",border:"",stripe:""},{default:r((()=>[n(W,null,{default:r((()=>[n(L,{align:"center",width:"60"},{default:r((()=>[f("序号")])),_:1}),n(L,{align:"center"},{default:r((()=>[f("物料编码")])),_:1}),n(L,{align:"center"},{default:r((()=>[f("物料名称")])),_:1}),n(L,{align:"center"},{default:r((()=>[f("规格型号")])),_:1}),n(L,{align:"center"},{default:r((()=>[f("单位")])),_:1}),n(L,{align:"center"},{default:r((()=>[f("应发数量")])),_:1}),n(L,{align:"center"},{default:r((()=>[f("已调拨数量")])),_:1}),n(L,{align:"center"},{default:r((()=>[f("仓库")])),_:1}),n(L,{align:"center"},{default:r((()=>[f("仓管员")])),_:1}),n(L,{align:"center"},{default:r((()=>[f("操作")])),_:1})])),_:1}),(m(!0),o(d,null,h(i.scfl,((a,e)=>(m(),_(W,{key:e},{default:r((()=>[n(R,{align:"center"},{default:r((()=>[f(F(e+1),1)])),_:2},1024),n(R,null,{default:r((()=>[f(F(a.material_no),1)])),_:2},1024),n(R,null,{default:r((()=>[f(F(a.material_name),1)])),_:2},1024),n(R,null,{default:r((()=>[f(F(a.material_spec),1)])),_:2},1024),n(R,{align:"center"},{default:r((()=>[f(F(a.unit_name),1)])),_:2},1024),n(R,{align:"center"},{default:r((()=>[f(F(a.must_qty),1)])),_:2},1024),n(R,{align:"center"},{default:r((()=>[f(F(i.inv_plans_map[a.material_id]),1)])),_:2},1024),n(R,null,{default:r((()=>[n(A,{class:k([a.stock_id==t.$store.state.cur_stock.FStockId?"text-primary":"text-error"])},{default:r((()=>[f(F(a.stock_name),1)])),_:2},1032,["class"])])),_:2},1024),n(R,null,{default:r((()=>[f(F(a.storekeeper),1)])),_:2},1024),n(R,{align:"center"},{default:r((()=>[n(T,{text:"分配库位",type:"primary",onClick:t=>Q.allocate_loc_no(a)},null,8,["onClick"])])),_:2},1024)])),_:2},1024)))),128))])),_:1},512)):(m(),_(G,{key:1},{default:r((()=>[(m(!0),o(d,null,h(i.scfl,((a,e)=>(m(),_(z,{key:e,onClick:t=>Q.allocate_loc_no(a),clickable:"","show-arrow":""},{body:r((()=>[n($,{class:"uni-list-item__body"},{default:r((()=>[n(A,{class:"title"},{default:r((()=>[f(F(a.material_no),1)])),_:2},1024),n($,{class:"note"},{default:r((()=>[n($,null,{default:r((()=>[f("名称："+F(a.material_name),1)])),_:2},1024),n($,null,{default:r((()=>[f("规格："+F(a.material_spec),1)])),_:2},1024),n($,null,{default:r((()=>[f("仓库："),n(A,{class:k([a.stock_id==t.$store.state.cur_stock.FStockId?"text-primary":"text-error"])},{default:r((()=>[f(F(a.stock_name),1)])),_:2},1032,["class"])])),_:2},1024),n($,null,{default:r((()=>[f("仓管员："+F(a.storekeeper),1)])),_:2},1024)])),_:2},1024)])),_:2},1024)])),footer:r((()=>[n($,{class:"uni-list-item__foot"},{default:r((()=>[n($,null,{default:r((()=>[f(F(a.must_qty)+" "+F(a.unit_name),1)])),_:2},1024),i.inv_plans_map[a.material_id]?(m(),_($,{key:0},{default:r((()=>[f("已调拨："),n(A,{class:"text-primary"},{default:r((()=>[f(F(i.inv_plans_map[a.material_id]),1)])),_:2},1024)])),_:2},1024)):c("",!0)])),_:2},1024)])),_:2},1032,["onClick"])))),128))])),_:1}))])),_:1},8,["sub-title"])):c("",!0),!i.scfl.length&&i.scfl_todo.length?(m(),_(E,{key:1,title:"今日生产发料",type:"square"},{default:r((()=>[n(V,{spacing:"0",padding:"0"},{default:r((()=>[n(G,null,{default:r((()=>[(m(!0),o(d,null,h(i.scfl_todo,((t,a)=>(m(),_(z,{key:a,"extra-icon":{type:"chat",size:"24",color:"#007bff"},"show-extra-icon":"",title:t.bill_no,"right-text":t.prd_line,onClick:a=>{i.search_form.bill_no=t.bill_no,Q.handle_search()},clickable:"","show-arrow":""},null,8,["title","right-text","onClick"])))),128))])),_:1})])),_:1})])),_:1})):c("",!0),"app-plus"===t.$store.state.screen_type?(m(),_($,{key:2,class:"uni-goods-nav-wrapper"},{default:r((()=>[n(J,{options:i.goods_nav.options,"button-group":i.goods_nav.button_group,fill:t.$store.state.goods_nav_fill,onClick:Q.goods_nav_click,onButtonClick:Q.goods_nav_button_click},null,8,["options","button-group","fill","onClick","onButtonClick"])])),_:1})):c("",!0),Q.is_completed?(m(),_(K,{key:3,src:Z,class:"yiwancheng-stamp"})):c("",!0)],64)}]]);export{R as default};
